document.addEventListener("DOMContentLoaded",async()=>{const e=new(window.AudioContext||window.webkitAudioContext);if(!e)return void alert("Web Audio API not supported.");const t=()=>{"suspended"===e.state&&e.resume().catch(console.error)};document.addEventListener("click",t,{once:!0}),document.addEventListener("touchstart",t,{once:!0}),document.addEventListener("keydown",t,{once:!0});let n=null;try{const e=await fetch("/api/firebase-config");if(!e.ok){const t=await e.json();return console.error("Firebase configuration error:",t),void alert("Firebase設定の取得に失敗しました。管理者にお問い合わせください。")}n=await e.json()}catch(e){return console.error("Failed to fetch Firebase config:",e),void alert("Firebase設定の取得に失敗しました。ネットワーク接続を確認してください。")}firebase.initializeApp(n);const a=firebase.firestore(),o=firebase.auth(),c=document.getElementById("login-button"),l=document.getElementById("logout-button"),s=document.getElementById("user-info"),r=document.getElementById("user-name"),i=document.getElementById("load-data-button"),d=document.getElementById("playback-grid"),u=document.getElementById("sequence-max-buttons"),m=document.getElementById("note-duration-buttons"),p=document.getElementById("bpm"),v=document.querySelectorAll(".bpm-adjust"),f=document.getElementById("play-once-button"),y=document.getElementById("play-loop-button"),g=document.getElementById("stop-button"),b=document.getElementById("bulk-edit-button"),E=document.getElementById("random-generate-trigger-button"),h=document.getElementById("toast-container"),T=document.getElementById("preset-status-container"),I=document.getElementById("current-preset-status"),k=document.getElementById("manual-save-button"),B=document.getElementById("footer-save-button"),x=document.getElementById("new-preset-button"),w=document.getElementById("fx-slots-container"),L=document.getElementById("fx-edit-modal"),A=document.getElementById("fx-modal-title"),C=document.getElementById("fx-type-select"),N=document.getElementById("fx-params-container"),S=document.getElementById("fx-modal-complete-button"),q=document.getElementById("confirmation-modal"),M=document.getElementById("confirmation-modal-message"),$=document.getElementById("confirmation-modal-confirm-button"),D=document.getElementById("confirmation-modal-cancel-button"),F=document.getElementById("confirmation-modal-alternative-button");function V(e){if(!e)return;const t=e.min?parseFloat(e.min):0,n=e.max?parseFloat(e.max):100,a=(parseFloat(e.value)-t)/(n-t)*100;e.style.setProperty("--fill-percent",`${a}%`)}function G(e,t,n={}){M.innerHTML=e.replace(/\n/g,"<br>"),$.onclick=()=>{t&&t(),Re(q)},D.onclick=()=>{n.onCancel&&n.onCancel(),Re(q)},n.onAlternative?(F.style.display="inline-block",F.textContent=n.alternativeText||"選択肢",F.onclick=()=>{n.onAlternative&&n.onAlternative(),Re(q)}):F.style.display="none",$.textContent=n.confirmText||"OK",D.textContent=n.cancelText||"キャンセル",$.classList.toggle("danger",!!n.isDanger),je(q)}function H(){G("この機能を利用するにはTwitterアカウントでのログインが必要です。",()=>{O()},{confirmText:"Twitterでログイン",cancelText:"キャンセル"})}async function O(){const e=new firebase.auth.TwitterAuthProvider;try{const t=(await o.signInWithPopup(e)).user;Ce(`ようこそ、${t.displayName}さん！`,"success"),console.log("Twitterログイン成功！ユーザーUID:",t.uid)}catch(e){console.error("Twitterログインエラー:",e);const t=e.code,n=e.message;"auth/popup-closed-by-user"===t?Ce("認証画面が閉じられました。","info"):"auth/cancelled-popup-request"===t||Ce("auth/credential-already-in-use"===t?"このTwitterアカウントは既に使用されています。":`ログインエラー: ${n}`,"error")}}Ae(q,()=>Re(q));const j=document.getElementById("edit-modal"),R=document.getElementById("bulk-edit-modal"),P=document.getElementById("random-generate-modal"),_=document.getElementById("save-preset-modal"),K=document.getElementById("load-preset-modal");let U=[],W=null,X=0,J=!1,z=!1,Q=null,Y=0,Z=[],ee=null,te=null,ne=16,ae=1,oe=null,ce=null,le=null;const se=e.createGain();let re=[{id:"B",name:"FX B",node:null,bypassNode:null,isActive:!1,effectType:"delay",params:{mix:.5,time:.25,feedback:.4,syncMode:"bpm",rate:4}},{id:"C",name:"FX C",node:null,bypassNode:null,isActive:!1,effectType:"reverb",params:{mix:.5}},{id:"D",name:"FX D",node:null,bypassNode:null,isActive:!1,effectType:"none",params:{}}];const ie={none:{name:"エフェクトなし",params:{}},reverb:{name:"リバーブ",params:{mix:{label:"Mix",type:"range",min:0,max:1,step:.01,value:.5}},createNode:async e=>{const t=e.createConvolver(),n=e.createGain(),a=e.createGain(),o=e.sampleRate,c=2*o,l=e.createBuffer(2,c,o),s=l.getChannelData(0),r=l.getChannelData(1);for(let e=0;e<c;e++)s[e]=(2*Math.random()-1)*Math.pow(1-e/c,2.5),r[e]=(2*Math.random()-1)*Math.pow(1-e/c,2.5);return t.buffer=l,{convolver:t,wetGain:n,dryGain:a}}},delay:{name:"ディレイ",params:{mix:{label:"Mix",type:"range",min:0,max:1,step:.01,value:.5},feedback:{label:"Feedback",type:"range",min:0,max:.9,step:.01,value:.4},time:{label:"Time",type:"range",min:.01,max:2,step:.01,value:.25},rate:{label:"Rate",type:"buttons",value:4,options:[{value:.5,label:"2分"},{value:.75,label:"2分3連符"},{value:1,label:"4分"},{value:1/1.5,label:"付点4分"},{value:1.5,label:"4分3連符"},{value:2,label:"8分"},{value:2/1.5,label:"付点8分"},{value:3,label:"8分3連符"},{value:4,label:"16分"}]}},createNode:e=>({delay:e.createDelay(5),feedback:e.createGain(),wetGain:e.createGain(),dryGain:e.createGain()})},slicer:{name:"スライサー",params:{depth:{label:"Depth",type:"range",min:0,max:1,step:.01,value:1},rate:{label:"Rate",type:"buttons",value:4,options:[{value:1,label:"4分"},{value:1.5,label:"4分3連符"},{value:2,label:"8分"},{value:2/1.5,label:"付点8分"},{value:3,label:"8分3連符"},{value:4,label:"16分"},{value:4/1.5,label:"付点16分"},{value:6,label:"16分3連符"},{value:8,label:"32分"}]}},createNode:e=>{const t=e.createGain(),n=e.createOscillator(),a=e.createGain(),o=e.createConstantSource();return n.type="square",t.gain.value=0,n.connect(a),a.connect(t.gain),o.connect(t.gain),n.start(),o.start(),{slicerGain:t,lfo:n,lfoGain:a,dcOffset:o}}}},de={C:0,"C♯":1,"D♭":1,D:2,"D♯":3,"E♭":3,E:4,F:5,"F♯":6,"G♭":6,G:7,"G♯":8,"A♭":8,A:9,"A♯":10,"B♭":10,B:11},ue=["C","C♯","D","D♯","E","F","F♯","G","G♯","A","A♯","B"],me=[1,2,3,4,5,6,7,8,9],pe={sine:"正弦波",square:"矩形波",sawtooth:"ノコギリ波",triangle:"三角波"},ve=[{value:.25,label:"16分"},{value:1/3,label:"1拍3連"},{value:.5,label:"8分"},{value:2/3,label:"2拍3連"},{value:1,label:"4分"},{value:2,label:"2分"},{value:4,label:"全音符"}],fe={major:{name:"メジャー",intervals:[0,4,7]},minor:{name:"マイナー",intervals:[0,3,7]},dominant7th:{name:"ドミナント7th",intervals:[0,4,7,10]},major7th:{name:"メジャー7th",intervals:[0,4,7,11]},minor7th:{name:"マイナー7th",intervals:[0,3,7,10]},diminished:{name:"ディミニッシュ",intervals:[0,3,6]},augmented:{name:"オーギュメント",intervals:[0,4,8]},sus4:{name:"サスフォー",intervals:[0,5,7]},majorPentatonic:{name:"メジャーペンタ",intervals:[0,2,4,7,9]},minorPentatonic:{name:"マイナーペンタ",intervals:[0,3,5,7,10]}};async function ye(){for(const t of re)"none"!==t.effectType&&ie[t.effectType].createNode?(t.node=await ie[t.effectType].createNode(e),t.node.type=t.effectType,xe(t)):t.node=null;be()}function ge(e){const t=0===re.indexOf(e)?se:re[re.indexOf(e)-1].bypassNode;if(t.disconnect(),e.isActive&&"none"!==e.effectType&&e.node){if("reverb"===e.effectType){const{convolver:n,wetGain:a,dryGain:o}=e.node;t.connect(o).connect(e.bypassNode),t.connect(n).connect(a).connect(e.bypassNode)}else if("delay"===e.effectType){const{delay:n,feedback:a,wetGain:o,dryGain:c}=e.node;t.connect(c).connect(e.bypassNode),t.connect(n),n.connect(o).connect(e.bypassNode),n.connect(a).connect(n)}else if("slicer"===e.effectType){const{slicerGain:n}=e.node;t.connect(n).connect(e.bypassNode)}}else t.connect(e.bypassNode)}function be(){re.forEach(ge)}function Ee(e){const t=document.getElementById("tag-display-container"),n=Array.from(t.querySelectorAll(".tag-badge span:first-child")).map(e=>e.textContent);if(n.includes(e)||n.length>=10)return;const a=document.createElement("div");a.className="tag-badge",a.innerHTML=`<span>${e}</span><span class="remove-tag">×</span>`,t.appendChild(a)}function he(e){const t=re.find(t=>t.id===e),n=w.querySelector(`[data-fx-id="${e}"]`);t&&n&&(n.classList.toggle("active",t.isActive),n.querySelector(".fx-type-name").textContent=ie[t.effectType].name)}function Te(){Re(L),ce=null}async function Ie(){const t=C.value,n=ce;if(!n||n.effectType===t)return;n.effectType=t;const a=ie[t].params;n.params={};for(const e in a)n.params[e]=a[e].value;ie[t].createNode?(n.node=await ie[t].createNode(e),n.node.type=t):n.node=null,ke()}function ke(){const e=ce;if(N.innerHTML="",!e||"none"===e.effectType)return;const t=ie[e.effectType].params;if("delay"===e.effectType){const n=e.params,a=(e,t)=>{const a=n[e]??t.value,o=document.createElement("div");o.className="fx-param-control",o.innerHTML=`\n                    <label>${t.label}</label>\n                    <div class="slider-wrapper">\n                        <input type="range" min="${t.min}" max="${t.max}" step="${t.step}" value="${a}" data-param-key="${e}">\n                        <span>${a}</span>\n                    </div>\n                `;const c=o.querySelector("input"),l=o.querySelector("span");return c.oninput=()=>{l.textContent=c.value,V(c)},V(c),o};N.appendChild(a("mix",t.mix)),N.appendChild(a("feedback",t.feedback));const o=document.createElement("div");o.className="fx-param-control toggle-switch-container",o.innerHTML='\n                <span class="toggle-label">Time (秒数で指定)</span>\n                <label class="toggle-switch">\n                    <input type="checkbox" data-param-key="syncMode">\n                    <span class="toggle-slider"></span>\n                </label>\n            ';const c=o.querySelector("input");N.appendChild(o);const l=document.createElement("div");l.dataset.syncControl="time",l.appendChild(a("time",t.time)),N.appendChild(l);const s=document.createElement("div");s.dataset.syncControl="bpm";const r=t.rate,i=n.rate??r.value,d=document.createElement("div");d.className="fx-param-control",d.innerHTML=`<label>${r.label}</label>`;const u=document.createElement("div");u.className="button-selector-group fx-param-buttons",u.dataset.paramKey="rate",r.options.forEach(e=>{const t=document.createElement("button");t.type="button",t.dataset.value=e.value,t.textContent=e.label,e.value==i&&t.classList.add("active"),t.onclick=()=>{u.querySelectorAll("button").forEach(e=>e.classList.remove("active")),t.classList.add("active")},u.appendChild(t)}),d.appendChild(u),s.appendChild(d),N.appendChild(s);const m=()=>{const e=c.checked;l.style.display=e?"":"none",s.style.display=e?"none":""};c.onchange=m,c.checked="time"===n.syncMode,m()}else for(const n in t){const a=t[n],o=e.params[n]??a.value,c=document.createElement("div");c.className="fx-param-control";const l=document.createElement("label");if(l.textContent=a.label,c.appendChild(l),"range"===a.type){const e=document.createElement("div");e.className="slider-wrapper",e.innerHTML=`\n                        <input type="range" min="${a.min}" max="${a.max}" step="${a.step}" value="${o}" data-param-key="${n}">\n                        <span>${o}</span>`;const t=e.querySelector('input[type="range"]'),l=e.querySelector("span");t.oninput=()=>{l.textContent=t.value,V(t)},c.appendChild(e),V(t)}else if("buttons"===a.type){const e=document.createElement("div");e.className="button-selector-group fx-param-buttons",e.dataset.paramKey=n,a.options.forEach(t=>{const n=document.createElement("button");n.type="button",n.dataset.value=t.value,n.textContent=t.label,t.value==o&&n.classList.add("active"),n.onclick=()=>{e.querySelectorAll("button").forEach(e=>e.classList.remove("active")),n.classList.add("active")},e.appendChild(n)}),c.appendChild(e)}N.appendChild(c)}}async function Be(){const t=ce;if(t){if("delay"===t.effectType){const e=N.querySelector('input[data-param-key="syncMode"]');if(t.params.syncMode=e.checked?"time":"bpm",t.params.mix=parseFloat(N.querySelector('input[data-param-key="mix"]').value),t.params.feedback=parseFloat(N.querySelector('input[data-param-key="feedback"]').value),"time"===t.params.syncMode)t.params.time=parseFloat(N.querySelector('input[data-param-key="time"]').value);else{const e=N.querySelector('.button-selector-group[data-param-key="rate"]').querySelector("button.active");e&&(t.params.rate=parseFloat(e.dataset.value))}}else N.querySelectorAll('input[type="range"]').forEach(e=>{t.params[e.dataset.paramKey]=parseFloat(e.value)}),N.querySelectorAll(".button-selector-group").forEach(e=>{const n=e.dataset.paramKey,a=e.querySelector("button.active");a&&(t.params[n]=parseFloat(a.dataset.value))});t.node&&t.node.type===t.effectType||(ie[t.effectType].createNode?(t.node=await ie[t.effectType].createNode(e),t.node.type=t.effectType):t.node=null),xe(t),be(),he(t.id),Te(),ct()}}function xe(t){if(!t.node||"none"===t.effectType)return;const n=t.params,a=e.currentTime;if("reverb"===t.effectType)t.node.wetGain.gain.setValueAtTime(n.mix,a),t.node.dryGain.gain.setValueAtTime(1-n.mix,a);else if("delay"===t.effectType){let e;if(t.node.wetGain.gain.setValueAtTime(n.mix,a),t.node.dryGain.gain.setValueAtTime(1-n.mix,a),"bpm"===n.syncMode){e=60/(parseFloat(p.value)*n.rate)}else e=n.time;e=Math.max(.001,Math.min(e,5)),t.node.delay.delayTime.setValueAtTime(e,a),t.node.feedback.gain.setValueAtTime(n.feedback,a)}else if("slicer"===t.effectType){const{lfo:e,lfoGain:o,dcOffset:c}=t.node,l=parseFloat(p.value)/60*n.rate,s=n.depth;e.frequency.setValueAtTime(l,a),o.gain.setValueAtTime(s/2,a),c.offset.setValueAtTime(s/2,a)}}function we(){re.filter(e=>e.isActive&&("slicer"===e.effectType||"delay"===e.effectType&&"bpm"===e.params.syncMode)).forEach(xe)}function Le(e,t){const n=Array.from(e.querySelectorAll("button")),a=e.querySelector("button.active");let o=n.findIndex(e=>e===a);-1===o?o=0:o+=t,o>=n.length?o=0:o<0&&(o=n.length-1),n[o].click()}function Ae(e,t){e.querySelector(".close-button").onclick=t,window.addEventListener("click",n=>{n.target==e&&t()})}function Ce(e,t="info",n=3e3){const a=document.createElement("div");a.className=`toast-message ${t}`,a.textContent=e,h.appendChild(a),setTimeout(()=>a.classList.add("show"),10),setTimeout(()=>{a.classList.remove("show"),a.addEventListener("transitionend",()=>a.remove())},n)}function Ne(e,t,n=null,a=null){if("undefined"!=typeof gtag){gtag("event",e,{event_category:t,event_label:n,value:a})}}function Se(e){const t=U[e],n=t.playbackElements;n.noteDisplay.textContent=`${t.note.replace("♯","#")}${t.octave}`,n.waveDisplay.textContent=pe[t.waveform]||t.waveform,n.volumeBar.style.width=100*t.volume+"%"}function qe(t){J&&Fe();const n=()=>{J=!0,z=t,X=0,Y=e.currentTime+.05,document.querySelectorAll(".playback-block.playing").forEach(e=>e.classList.remove("playing")),Me(),Ne("play_sequence","audio",t?"loop":"once")};"suspended"===e.state?e.resume().then(n):n()}function Me(){if(!J)return;const t=60/parseFloat(p.value)*ae;for(;Y<e.currentTime+.1;){if(X>=ne){if(!z)return void Fe();X=0}const e=U[X],n=.1;Oe(X,t,Y),Ge(e,t,Y+n),Y+=t,X++}J&&(Q=setTimeout(Me,25))}let $e=null,De=[];function Fe(){J=!1,z=!1,Q&&clearTimeout(Q),Q=null;const t=e.currentTime;Z.forEach(({gainNode:e})=>{try{e.gain.cancelScheduledValues(t),e.gain.setValueAtTime(e.gain.value,t),e.gain.linearRampToValueAtTime(0,t+.02)}catch(e){}}),Z=[],document.querySelectorAll(".playback-block.playing").forEach(e=>e.classList.remove("playing")),X=0,Ve()}function Ve(){$e&&clearTimeout($e),$e=null;const t=e.currentTime;De.forEach(({gainNode:e})=>{try{e.gain.cancelScheduledValues(t),e.gain.setValueAtTime(e.gain.value,t),e.gain.linearRampToValueAtTime(0,t+.02)}catch(e){}}),De=[],document.querySelectorAll(".action-button.preview.playing").forEach(e=>{e.classList.remove("playing"),e.innerHTML='<i class="fa-solid fa-play"></i> 試聴'})}function Ge(t,n,a=e.currentTime){if(0===t.volume)return;const o=He(t.note,t.octave);if(0===o)return;const c=e.createOscillator(),l=e.createGain();c.type=t.waveform,c.frequency.setValueAtTime(o,a);const s=Math.min(.04,.3*n);l.gain.setValueAtTime(0,a),l.gain.linearRampToValueAtTime(t.volume,a+.01),a+n-s>a+.01&&l.gain.setValueAtTime(t.volume,a+n-s),l.gain.linearRampToValueAtTime(0,a+n),c.connect(l).connect(se),c.start(a),c.stop(a+n+.01);const r={oscillator:c,gainNode:l,blockId:t.id};Z.push(r),setTimeout(()=>Z=Z.filter(e=>e!==r),1e3*(n+.1))}function He(e,t){const n=de[e.replace("#","♯")];if(void 0===n)return 0;const a=12*(t+1)+n;return 440*Math.pow(2,(a-69)/12)}function Oe(t,n,a){const o=U[t]?.playbackElements?.blockElement;if(o){const t=1e3*(a-e.currentTime);setTimeout(()=>{o.classList.add("playing"),setTimeout(()=>o.classList.remove("playing"),1e3*n)},Math.max(0,t))}}function je(e){e.style.display="flex",setTimeout(()=>e.classList.add("active"),10)}function Re(e){e.classList.remove("active"),setTimeout(()=>e.style.display="none",300)}function Pe(e){ee=e;const t=U[e];document.getElementById("modal-title").textContent=`ステップ ${e+1} 編集`,yt(document.getElementById("modal-note-buttons"),t.note),yt(document.getElementById("modal-octave-buttons"),t.octave),yt(document.getElementById("modal-waveform-buttons"),t.waveform);const n=document.getElementById("modal-volume");n.value=100*t.volume,V(n),document.getElementById("modal-volume-display").textContent=`${Math.round(100*t.volume)}%`,je(j)}function _e(){Re(j),ee=null}function Ke(){if(null===ee)return;const e=ee,t=e=>e.querySelector("button.active")?.dataset.value;U[e].note=t(document.getElementById("modal-note-buttons"))||U[e].note,U[e].octave=parseInt(t(document.getElementById("modal-octave-buttons")))||U[e].octave,U[e].waveform=t(document.getElementById("modal-waveform-buttons"))||U[e].waveform,U[e].volume=parseInt(document.getElementById("modal-volume").value)/100,Se(e),_e(),ct()}function Ue(){if(null===ee)return;const t=e=>e.querySelector("button.active")?.dataset.value,n={note:t(document.getElementById("modal-note-buttons")),octave:parseInt(t(document.getElementById("modal-octave-buttons"))),waveform:t(document.getElementById("modal-waveform-buttons")),volume:parseInt(document.getElementById("modal-volume").value)/100};var a,o;a=n,o=.5,"suspended"===e.state?e.resume().then(()=>Ge(a,o)):Ge(a,o)}function We(){[document.getElementById("bulk-modal-note-buttons"),document.getElementById("bulk-modal-octave-buttons"),document.getElementById("bulk-modal-waveform-buttons")].forEach(e=>e.querySelectorAll("button.active").forEach(e=>e.classList.remove("active")));const e=document.getElementById("bulk-modal-volume");e.value=50,document.getElementById("bulk-modal-volume-display").textContent="50%",e.dataset.isSetForBulk="false",e.style.opacity=.5,document.getElementById("bulk-modal-volume-display").style.opacity=.5,V(e),je(R)}function Xe(){Re(R)}function Je(){const e=e=>e.querySelector("button.active")?.dataset.value,t={note:e(document.getElementById("bulk-modal-note-buttons")),octave:parseInt(e(document.getElementById("bulk-modal-octave-buttons"))),waveform:e(document.getElementById("bulk-modal-waveform-buttons"))};"true"===document.getElementById("bulk-modal-volume").dataset.isSetForBulk&&(t.volume=parseInt(document.getElementById("bulk-modal-volume").value)/100);for(let e=0;e<16;e++)t.note&&(U[e].note=t.note),isNaN(t.octave)||(U[e].octave=t.octave),t.waveform&&(U[e].waveform=t.waveform),void 0!==t.volume&&(U[e].volume=t.volume),Se(e);Xe(),ct()}function ze(){je(P)}function Qe(){Re(P)}function Ye(){U.forEach((e,t)=>{Object.assign(e,{note:"A",octave:4,waveform:"sawtooth",volume:.5}),Se(t)}),p.value=120,ae=1,yt(m,ae),ne=16,yt(u,ne)}function Ze(e=!1,t=null){if(!W)return void H();const n=()=>{const n=document.getElementById("preset-name"),o=document.getElementById("preset-description"),c=document.getElementById("tag-display-container"),l=document.getElementById("preset-tags-input"),s=document.getElementById("save-preset-button"),r=_.querySelector("h3");delete _.dataset.editingId;const i=document.getElementById("overwrite-preset-button");i&&i.remove(),e?(r.textContent="名前を付けて保存",s.textContent="保存"):(r.textContent="新規プリセット作成",s.textContent="作成して保存"),n.value="",o.value="",c.innerHTML="",l.value="",s.disabled=!0,s.onclick=()=>async function(e,t=null){if(!W)return void Ce("ログインが必要です。","error");const n=document.getElementById("preset-name").value.trim();if(!n)return void Ce("プリセット名は必須です。","error");const o=document.getElementById("preset-tags-input");""!==o.value.trim()&&(Ee(o.value.trim()),o.value="");const c=document.getElementById("tag-display-container"),l=Array.from(c.querySelectorAll(".tag-badge span:first-child")).map(e=>e.textContent);e||Ye();const s={name:n,description:document.getElementById("preset-description").value.trim(),tags:l,...at(),createdAt:firebase.firestore.FieldValue.serverTimestamp(),updatedAt:firebase.firestore.FieldValue.serverTimestamp()};try{const e=await a.collection("users").doc(W.uid).collection("presets").add(s);oe=e.id,Ce(`プリセット「${n}」を作成しました。`,"success"),st(n,!0),ot(),rt(),Ne("create_preset","preset_management","new_preset"),t&&t()}catch(e){Ce(`プリセットの作成に失敗しました: ${e.message}`,"error"),console.error("Error creating new preset: ",e)}}(!0,t),je(_)},o=I.textContent.includes("*");!e&&o?G("新規作成します。\n現在の編集内容は保存しますか？",()=>{lt(()=>{Ye(),st("新規シーケンス",!1,!1),ot()})},{confirmText:"保存して続行",onCancel:()=>{Ye(),st("新規シーケンス",!1,!1),ot(),n()},cancelText:"破棄して続行",onAlternative:()=>{},alternativeText:"キャンセル",isDanger:!1}):n()}function et(){oe=null,st(null,!1);const e=e=>e.querySelector("button.active")?.dataset.value,t=e(document.getElementById("rg-root-note-buttons")),n=parseInt(e(document.getElementById("rg-octave-min-buttons"))),a=parseInt(e(document.getElementById("rg-octave-max-buttons"))),o=parseInt(e(document.getElementById("rg-steps-buttons")));if(!(t&&n&&a&&o))return void Ce("ランダム生成の全項目を選択してください。","error");if(n>a)return void Ce("最小オクターブは最大以下にしてください。","error");const c=fe[document.getElementById("rg-chord-type").value],l=de[t],s=[];for(let e=n;e<=a;e++)c.intervals.forEach(t=>{const n=12*(e+1)+l+t,a=n%12,o=Math.floor(n/12)-1;let c=ue.find(e=>de[e]===a&&!e.includes("♭"))||ue[a];o>=1&&o<=9&&s.push({note:c,octave:o})});if(0!==s.length){for(let e=0;e<o;e++){const t=s[Math.floor(Math.random()*s.length)];U[e].note=t.note,U[e].octave=t.octave,Se(e)}ne=o,yt(u,ne),Qe(),Ce("ランダム生成を実行しました。","success"),Ne("random_generate","creation_tools",c.name,o),ct()}else Ce("指定範囲で生成可能な音がありません。","error")}const tt="oscbot_local_backup";async function nt(e){if(e.sequenceData.forEach((e,t)=>{U[t]&&(Object.assign(U[t],e),Se(t))}),p.value=e.bpm,ae=e.noteDuration,yt(m,ae),ne=e.sequenceMax,yt(u,ne),e.fxSlots){for(let t=0;t<re.length;t++)if(e.fxSlots[t]){const n=re[t],a=e.fxSlots[t];n.isActive=a.isActive,n.effectType=a.effectType;const o=ie[a.effectType]?.params||{},c=Object.fromEntries(Object.entries(o).map(([e,t])=>[e,t.value]));n.params={...c,...a.params}}await ye(),re.forEach(e=>he(e.id))}}function at(){return{sequenceData:U.map(({note:e,octave:t,waveform:n,volume:a})=>({note:e,octave:t,waveform:n,volume:a})),bpm:parseInt(p.value),noteDuration:ae,sequenceMax:ne,fxSlots:re.map(e=>({isActive:e.isActive,effectType:e.effectType,params:e.params}))}}function ot(){localStorage.removeItem(tt)}function ct(){!function(){try{const e={...at(),timestamp:(new Date).getTime()};localStorage.setItem(tt,JSON.stringify(e))}catch(e){console.error("Error saving local backup:",e)}}(),st(oe?I.textContent:"新規シーケンス",!1,!0),W&&oe&&(le&&clearTimeout(le),le=setTimeout(()=>async function(e,t=null){if(!W||!oe)return;const n=I.textContent;st("保存中...",!1);try{const n=at(),o=a.collection("users").doc(W.uid).collection("presets").doc(oe);await o.update({...n,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});const c=(await o.get()).data().name;st(c,!0),e||Ce(`「${c}」を保存しました。`,"success"),ot(),t&&t()}catch(e){Ce(`保存に失敗: ${e.message}`,"error"),console.error("Save error: ",e),st(n.replace("保存中...",""),!1,!0)}}(!0),1e4))}function lt(e=null){W?oe?(le&&clearTimeout(le),G("現在のプリセットの保存方法を選択してください",()=>{!async function(e,t=null){if(!W||!e)return;const n={...at(),updatedAt:firebase.firestore.FieldValue.serverTimestamp()};try{const o=a.collection("users").doc(W.uid).collection("presets").doc(e);await o.update(n);const c=(await o.get()).data().name;Ce(`「${c}」を上書き保存しました。`,"success"),st(c,!0),ot(),t&&t()}catch(e){console.error("Error overwriting preset: ",e),"not-found"===e.code?(Ce("エラー: 保存対象のプリセットが見つかりませんでした。","error"),G("元のプリセットが削除されているようです。現在の内容を新しいプリセットとして保存しますか？",()=>{Ze(!0)},{confirmText:"新規保存",cancelText:"キャンセル"}),oe=null,st("新規シーケンス",!1,!0)):Ce(`上書き保存に失敗しました: ${e.message}`,"error")}}(oe,e)},{onAlternative:()=>{Ze(!0)},confirmText:"上書き保存",alternativeText:"別名で保存",cancelText:"キャンセル"})):Ze(!0,e):Ze(!0)}function st(e,t,n=!1){const a=document.getElementById("manual-save-button"),o=document.getElementById("footer-save-button");let c=e||"新規シーケンス";const l=c.replace(/\s\*$/,"").replace(/^[\u2713\s]*/,"").replace(/^保存中.../,"");if(null!==e){if(!W&&!n)return T.style.display="none",void(o.disabled=!0);t?(c=`✓ ${l}`,a.textContent="保存済み",a.disabled=!0,o.disabled=!0):"保存中..."===e?(c="保存中...",a.textContent="保存中...",a.disabled=!0,o.disabled=!0):n?(c=`${l} *`,a.textContent="保存",a.disabled=!1,o.disabled=!1):(c=l,a.textContent="保存",a.disabled=!0,o.disabled=!0),I.textContent=c,T.style.display="flex",I.classList.toggle("editable",!!oe&&!!W)}else T.style.display="none"}function rt(){const e=document.getElementById("overwrite-preset-button");e&&e.remove(),Re(_)}async function it(e=!0){if(!W)return void Ce("ログインが必要です。","error");const t=document.getElementById("preset-name").value.trim();if(!t)return void Ce("プリセット名は必須です。","error");const n=document.getElementById("preset-tags-input");""!==n.value.trim()&&(Ee(n.value.trim()),n.value="");const o=_.dataset.editingId,c=document.getElementById("tag-display-container"),l=Array.from(c.querySelectorAll(".tag-badge span:first-child")).map(e=>e.textContent),s={name:t,description:document.getElementById("preset-description").value.trim(),tags:l,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};try{const t=a.collection("users").doc(W.uid).collection("presets");if(e&&o)await t.doc(o).update({name:s.name,description:s.description,tags:s.tags}),Ce("プリセット情報を更新しました。","success"),o===oe&&st(s.name,!0),mt();else{const e={...at(),...s,createdAt:firebase.firestore.FieldValue.serverTimestamp()},n=await t.add(e);oe=n.id,Ce(`「${s.name}」を保存しました。`,"success"),st(s.name,!0),ot()}rt()}catch(e){Ce(`保存に失敗しました: ${e.message}`,"error"),console.error("Error saving preset: ",e)}}function dt(){W?(mt(),je(K)):H()}function ut(){Re(K)}async function mt(){if(!W)return;const t=document.getElementById("preset-list"),n=document.getElementById("no-results-message"),o=document.getElementById("search-box").value.toLowerCase();t.innerHTML='<div class="loading-spinner"></div>';try{const c=await a.collection("users").doc(W.uid).collection("presets").orderBy("updatedAt","desc").get(),l=c.docs.map(e=>({id:e.id,...e.data()})).filter(e=>e.name.toLowerCase().includes(o)||e.description&&e.description.toLowerCase().includes(o)||e.tags&&e.tags.some(e=>e.toLowerCase().includes(o)));t.innerHTML="",l.length>0?(t.className="preset-grid",l.forEach(n=>{const o=document.createElement("div");o.className="preset-card-item";const c=document.createElement("div");c.className="preset-card-content";const l=document.createElement("h3");l.textContent=n.name;const s=document.createElement("p");s.textContent=n.description||"説明なし";const r=document.createElement("span");r.className="preset-timestamp",n.updatedAt&&n.updatedAt.toDate&&(r.textContent=`最終更新: ${n.updatedAt.toDate().toLocaleString()}`);const i=document.createElement("div");i.className="tags",n.tags&&n.tags.length>0&&(i.innerHTML=n.tags.map(e=>`<span class="tag">${e}</span>`).join(""));const d=document.createElement("div");d.className="actions";const u=document.createElement("button");u.className="action-button preview",u.innerHTML='<i class="fa-solid fa-play"></i> 試聴';const m=document.createElement("button");m.className="action-button edit",m.innerHTML='<i class="fa-solid fa-pen-to-square"></i>',m.title="名前やタグを編集";const p=document.createElement("button");p.className="action-button delete",p.innerHTML='<i class="fa-solid fa-trash"></i>',p.title="削除";const v=document.createElement("button");v.className="action-button load",v.textContent="読込",d.append(u,m,p,v),c.append(l,s,r,i,d),o.append(c),u.onclick=t=>{t.stopPropagation(),function(t){"suspended"===e.state&&e.resume();const n=De.length>0;if(Ve(),n)return;const a=event.target.closest(".action-button.preview");a&&(a.classList.add("playing"),a.innerHTML='<i class="fa-solid fa-stop"></i> 停止');let o=0,c=e.currentTime+.05;const l=t.sequenceData||[],s=t.sequenceMax||16,r=t.noteDuration||1,i=t.bpm||120,d=()=>{const t=60/i*r;for(;c<e.currentTime+.1;){if(o>=s)return void Ve();const n=l[o];if(n&&n.volume>0){const a=He(n.note,n.octave);if(a>0){const o=e.createOscillator(),l=e.createGain();o.type=n.waveform,o.frequency.setValueAtTime(a,c);const s=.01,r=Math.min(.04,.3*t);l.gain.setValueAtTime(0,c),l.gain.linearRampToValueAtTime(n.volume,c+s),c+t-r>c+s&&l.gain.setValueAtTime(n.volume,c+t-r),l.gain.linearRampToValueAtTime(0,c+t),o.connect(l).connect(se),o.start(c),o.stop(c+t+.01);const i={oscillator:o,gainNode:l};De.push(i),setTimeout(()=>{De=De.filter(e=>e!==i)},1e3*(t+.1))}}c+=t,o++}$e=o<s&&De.length>0?setTimeout(d,25):setTimeout(Ve,1e3*t)};d()}(n)},v.onclick=e=>{e.stopPropagation(),async function(e){if(!W)return;Ve();try{const t=a.collection("users").doc(W.uid).collection("presets").doc(e),n=await t.get();if(!n.exists)return void Ce("プリセットが見つかりません。","error");const o=n.data();await nt(o),oe=e,st(o.name,!0),ot(),Ce(`「${o.name}」を読み込みました。`,"success"),ut()}catch(e){Ce(`プリセットの読み込みに失敗しました: ${e.message}`,"error"),console.error("Error loading preset:",e)}}(n.id)},m.onclick=e=>{e.stopPropagation(),pt(n.id)},p.onclick=e=>{e.stopPropagation(),async function(e,t){if(!W)return;G(`本当にプリセット「${t}」を削除しますか？この操作は取り消せません。`,async()=>{try{await a.collection("users").doc(W.uid).collection("presets").doc(e).delete(),Ce("プリセットを削除しました。","success"),oe===e&&(oe=null,st(null)),mt()}catch(e){Ce(`プリセットの削除に失敗しました: ${e.message}`,"error"),console.error("Error deleting preset:",e)}},{isDanger:!0})}(n.id,n.name)},t.appendChild(o)}),n.style.display="none"):(t.className="preset-list",n.style.display="block")}catch(e){t.innerHTML="プリセットの読み込みに失敗しました。",Ce("プリセットの読み込みに失敗しました。","error"),console.error("Error populating presets: ",e)}}async function pt(e){if(W)try{const t=a.collection("users").doc(W.uid).collection("presets").doc(e),n=await t.get();if(!n.exists)return void Ce("編集対象のプリセットが見つかりません。","error");const o=n.data();_.querySelector("h3").textContent="プリセット情報の編集";const c=document.getElementById("preset-name");c.value=o.name,document.getElementById("preset-description").value=o.description||"";const l=document.getElementById("tag-display-container");l.innerHTML="",o.tags&&o.tags.forEach(e=>{const t=document.createElement("div");t.className="tag-badge",t.innerHTML=`<span>${e}</span><span class="remove-tag">×</span>`,l.appendChild(t)});const s=document.getElementById("save-preset-button");s.textContent="変更を保存",s.onclick=()=>it(!0),s.disabled=""===c.value.trim(),_.dataset.editingId=e;const r=document.getElementById("overwrite-preset-button");r&&r.remove(),ut(),je(_)}catch(e){Ce("プリセット情報の取得に失敗しました。","error")}}function vt(e,t,n,a=e=>e){e.innerHTML="",t.forEach(t=>{const n=document.createElement("button");n.type="button",n.dataset.value=t,n.textContent=a(t),n.onclick=t=>{(e.id.startsWith("bulk-")||e.id.startsWith("rg-"))&&!e.id.includes("waveform")?t.target.classList.contains("active")?t.target.classList.remove("active"):(e.querySelectorAll("button.active").forEach(e=>e.classList.remove("active")),t.target.classList.add("active")):(e.querySelectorAll("button").forEach(e=>e.classList.remove("active")),t.target.classList.add("active"))},e.appendChild(n)})}function ft(e,t,n,a,o="value",c="label"){e.innerHTML="",t.forEach(t=>{const l=document.createElement("button"),s="object"==typeof t?t[o]:t;l.dataset.value=s,l.textContent="object"==typeof t?t[c]:t,s===a&&l.classList.add("active"),l.onclick=()=>{n(s),e.querySelectorAll("button").forEach(e=>e.classList.remove("active")),l.classList.add("active")},e.appendChild(l)})}function yt(e,t){e.querySelectorAll("button").forEach(e=>{const n=isNaN(parseFloat(e.dataset.value))?e.dataset.value:parseFloat(e.dataset.value),a=isNaN(parseFloat(t))?t:parseFloat(t);e.classList.toggle("active",n===a)})}function gt(e){let t=(parseInt(p.value)||120)+e;p.value=Math.max(20,Math.min(300,t))}c.addEventListener("click",()=>{}),l.addEventListener("click",()=>{G("本当にログアウトしますか？",()=>o.signOut(),{isDanger:!0})});const bt=document.getElementById("loading-overlay"),Et=document.querySelector(".sequencer-app");bt.style.opacity="0",Et.classList.add("loaded"),setTimeout(()=>{bt.style.display="none"},500),async function(){await async function(){let t=se;for(const n of re)n.bypassNode=e.createGain(),t.connect(n.bypassNode),t=n.bypassNode;t.connect(e.destination)}(),await ye(),function(){d.innerHTML="",U=[];for(let e=0;e<16;e++){const t=document.createElement("div");t.className="playback-block",t.dataset.id=e,t.draggable=!0,t.onclick=()=>Pe(e);const n=document.createElement("span");n.className="step-number-pb",n.textContent=e+1;const a=document.createElement("div");a.className="pb-note";const o=document.createElement("div");o.className="pb-wave";const c=document.createElement("div");c.className="pb-volume-container";const l=document.createElement("div");l.className="pb-volume-bar",c.appendChild(l),t.append(n,a,o,c),d.appendChild(t),U.push({id:e,note:"A",octave:4,waveform:"sawtooth",volume:.5,playbackElements:{blockElement:t,noteDisplay:a,waveDisplay:o,volumeBar:l}}),Se(e)}}(),function(){const e=Object.keys(pe);vt(document.getElementById("modal-note-buttons"),ue,"note",e=>e.replace("♯","#")),vt(document.getElementById("modal-octave-buttons"),me,"octave"),vt(document.getElementById("modal-waveform-buttons"),e,"waveform",e=>pe[e]),vt(document.getElementById("bulk-modal-note-buttons"),ue,"note",e=>e.replace("♯","#")),vt(document.getElementById("bulk-modal-octave-buttons"),me,"octave"),vt(document.getElementById("bulk-modal-waveform-buttons"),e,"waveform",e=>pe[e]),ft(u,Array.from({length:16},(e,t)=>t+1),e=>{ne=parseInt(e),ct()},ne),ft(m,ve,e=>{ae=parseFloat(e),ct()},ae,"value","label"),function(){const e=Array.from({length:16},(e,t)=>t+1);vt(document.getElementById("rg-root-note-buttons"),ue,"rg-root",e=>e.replace("♯","#")),yt(document.getElementById("rg-root-note-buttons"),"C");document.getElementById("rg-chord-type").innerHTML=Object.keys(fe).map(e=>`<option value="${e}">${fe[e].name}</option>`).join(""),vt(document.getElementById("rg-octave-min-buttons"),me,"rg-octave-min"),yt(document.getElementById("rg-octave-min-buttons"),3),vt(document.getElementById("rg-octave-max-buttons"),me,"rg-octave-max"),yt(document.getElementById("rg-octave-max-buttons"),5),vt(document.getElementById("rg-steps-buttons"),e,"rg-steps"),yt(document.getElementById("rg-steps-buttons"),ne)}(),w.innerHTML="",re.forEach(e=>{const t=document.createElement("button");t.className="fx-slot-button",t.dataset.fxId=e.id,t.innerHTML=`<span class="fx-slot-name">${e.name}</span><span class="fx-type-name"></span>`;let n=null;const a=t=>{t.preventDefault(),n=setTimeout(()=>{var t;t=e.id,ce=re.find(e=>e.id===t),ce&&(A.textContent=`${ce.name} 設定`,C.innerHTML=Object.keys(ie).map(e=>`<option value="${e}">${ie[e].name}</option>`).join(""),C.value=ce.effectType,ke(),je(L)),n=null},500)},o=()=>{n&&clearTimeout(n),n=null},c=()=>{null!==n&&function(e){const t=re.find(t=>t.id===e);t&&(t.isActive=!t.isActive,he(e),ge(t),ct())}(e.id),o()};t.addEventListener("mousedown",a),t.addEventListener("touchstart",a,{passive:!1}),t.addEventListener("mouseup",c),t.addEventListener("mouseleave",o),t.addEventListener("touchend",c),w.appendChild(t),he(e.id)})}(),function(){f.onclick=()=>qe(!1),y.onclick=()=>qe(!0),g.onclick=Fe,b.onclick=We,E.onclick=ze,i.onclick=dt,x.onclick=()=>Ze(!1),k.onclick=()=>lt(),B.onclick=()=>lt(),I.addEventListener("click",()=>{oe&&W&&pt(oe)}),v.forEach(e=>e.addEventListener("click",()=>{gt(parseInt(e.dataset.step)),we(),ct()})),p.addEventListener("change",()=>{p.value=Math.max(20,Math.min(300,parseInt(p.value)||120)),we(),ct()}),d.addEventListener("dragstart",e=>{e.target.classList.contains("playback-block")&&(te=e.target,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",e.target.innerHTML),e.target.classList.add("dragging"))}),d.addEventListener("dragover",e=>{e.preventDefault();const t=e.target.closest(".playback-block");t&&t!==te&&t.classList.add("drag-over")}),d.addEventListener("dragleave",e=>{const t=e.target.closest(".playback-block");t&&t.classList.remove("drag-over")}),d.addEventListener("dragend",e=>e.target.classList.remove("dragging")),d.addEventListener("drop",e=>{e.preventDefault();const t=e.target.closest(".playback-block");if(!t||!te||t===te)return void(t&&t.classList.remove("drag-over"));t.classList.remove("drag-over");const n=parseInt(te.dataset.id),a=parseInt(t.dataset.id);G(`ステップ${n+1}のデータをステップ${a+1}と入れ替えますか？`,()=>{!function(e,t){const n={...U[e]},a={...U[t]};["note","octave","waveform","volume"].forEach(o=>{U[e][o]=a[o],U[t][o]=n[o]}),Se(e),Se(t),ct()}(n,a)},{confirmText:"入れ替え",cancelText:"キャンセル",onAlternative:()=>{!function(e,t){const n={...U[e]};["note","octave","waveform","volume"].forEach(e=>{U[t][e]=n[e]}),Se(t),ct()}(n,a)},alternativeText:"上書き"}),te=null}),Ae(j,_e),Ae(R,Xe),Ae(P,Qe),Ae(_,rt),Ae(L,Te),S.onclick=Be,C.onchange=Ie,document.getElementById("modal-volume").oninput=e=>{document.getElementById("modal-volume-display").textContent=`${e.target.value}%`,V(e.target)},document.getElementById("modal-complete-button").onclick=Ke,document.getElementById("modal-play-test-button").onclick=Ue;const e=document.getElementById("bulk-modal-volume"),t=document.getElementById("bulk-modal-volume-display");e.oninput=()=>{t.textContent=`${e.value}%`,e.dataset.isSetForBulk="true",e.style.opacity=1,t.style.opacity=1,V(e)},document.getElementById("bulk-modal-apply-button").onclick=Je,document.getElementById("bulk-clear-volume-button").onclick=()=>{e.value=50,t.textContent="50%",e.dataset.isSetForBulk="false",e.style.opacity=.5,t.style.opacity=.5,V(e)},document.getElementById("rg-execute-button").onclick=et,document.getElementById("save-preset-button").onclick=it,document.getElementById("search-box").addEventListener("input",mt),function(){const e=document.getElementById("preset-name"),t=document.getElementById("save-preset-button"),n=document.getElementById("preset-tags-input"),a=document.getElementById("tag-display-container");e.addEventListener("input",()=>{t.disabled=""===e.value.trim()}),n.addEventListener("keydown",e=>{"Enter"===e.key&&""!==n.value.trim()&&(e.preventDefault(),Ee(n.value.trim()),n.value="")}),a.addEventListener("click",e=>{e.target.classList.contains("remove-tag")&&e.target.parentElement.remove()})}(),window.addEventListener("keydown",e=>{const t=document.activeElement;if(["INPUT","TEXTAREA","SELECT"].includes(t.tagName)&&"range"===!t.type)return;const n=document.querySelector(".modal.active");if(!n||"Escape"===e.key)switch(e.key){case" ":J?g.click():y.click(),e.preventDefault();break;case"Enter":f.click(),e.preventDefault();break;case"ArrowUp":gt(e.shiftKey?10:1),e.preventDefault();break;case"ArrowDown":gt(e.shiftKey?-10:-1),e.preventDefault();break;case"ArrowRight":Le(e.shiftKey?u:m,1),e.preventDefault();break;case"ArrowLeft":Le(e.shiftKey?u:m,-1),e.preventDefault();break;case"Escape":n?n.querySelector(".close-button").click():J&&g.click(),e.preventDefault();break;case"r":case"R":E.click();break;case"b":case"B":b.click();break;case"l":case"L":i.click()}}),c.onclick=O,l.onclick=()=>{o.signOut().then(()=>{Ce("ログアウトしました。","info"),oe=null,st(null)}).catch(e=>{Ce(`ログアウトに失敗しました: ${e.message}`,"error"),console.error("Logout Error:",e)})}}(),o.onAuthStateChanged(t=>{if(t){const n=a.collection("users").doc(t.uid);n.get().then(e=>{const a={displayName:t.displayName,email:t.email,photoURL:t.photoURL,lastLoginAt:firebase.firestore.FieldValue.serverTimestamp()};return e.exists||(a.createdAt=firebase.firestore.FieldValue.serverTimestamp()),n.set(a,{merge:!0})}).catch(e=>{console.error("Error checking/creating user in Firestore:",e),Ce("ユーザー情報の確認に失敗しました。","error")}),W=t,function(e){const t=e.displayName||"ユーザー";if(r.textContent=`${t}さん`,e.photoURL){const t=document.createElement("img");t.src=e.photoURL;const n=r.querySelector("img");n&&n.remove(),r.insertBefore(t,r.firstChild)}c.style.display="none",s.style.display="flex"}(t),"suspended"===e.state&&e.resume().catch(console.error)}else W=null,c.style.display="block",s.style.display="none"}),function(){try{const e=localStorage.getItem(tt);if(!e)return void st("新規シーケンス");const t=JSON.parse(e);G(`未保存の作業データが見つかりました。（最終更新: ${new Date(t.timestamp).toLocaleString()}）復元しますか？`,()=>{nt(t),ct(),Ce("作業を復元しました。","info")},{onCancel:()=>{ot(),Ce("バックアップを破棄しました。","info"),st("新規シーケンス",!1,!1)},confirmText:"復元する",cancelText:"破棄する"})}catch(e){console.error("Error loading local backup:",e),ot()}}(),document.querySelectorAll('input[type="range"]').forEach(V)}()});