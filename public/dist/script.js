document.addEventListener("DOMContentLoaded",async()=>{const e=new(window.AudioContext||window.webkitAudioContext);if(!e)return void alert("Web Audio API not supported.");let t=null;try{const e=await fetch("/api/firebase-config");if(!e.ok){const t=await e.json();return console.error("Firebase configuration error:",t),void alert("Firebase設定の取得に失敗しました。管理者にお問い合わせください。")}t=await e.json()}catch(e){return console.error("Failed to fetch Firebase config:",e),void alert("Firebase設定の取得に失敗しました。ネットワーク接続を確認してください。")}firebase.initializeApp(t);const n=firebase.firestore(),a=firebase.auth(),o=document.getElementById("login-button"),l=document.getElementById("logout-button"),c=document.getElementById("user-info"),s=document.getElementById("user-name"),r=document.getElementById("load-data-button"),i=document.getElementById("playback-grid"),d=document.getElementById("sequence-max-buttons"),u=document.getElementById("note-duration-buttons"),m=document.getElementById("bpm"),p=document.querySelectorAll(".bpm-adjust"),v=document.getElementById("play-once-button"),f=document.getElementById("play-loop-button"),y=document.getElementById("stop-button"),g=document.getElementById("bulk-edit-button"),b=document.getElementById("random-generate-trigger-button"),E=document.getElementById("toast-container"),h=document.getElementById("preset-status-container"),I=document.getElementById("current-preset-status"),T=document.getElementById("manual-save-button"),k=document.getElementById("footer-save-button"),B=document.getElementById("new-preset-button"),x=document.getElementById("fx-slots-container"),w=document.getElementById("fx-edit-modal"),L=document.getElementById("fx-modal-title"),A=document.getElementById("fx-type-select"),C=document.getElementById("fx-params-container"),N=document.getElementById("fx-modal-complete-button"),S=document.getElementById("confirmation-modal"),M=document.getElementById("confirmation-modal-message"),q=document.getElementById("confirmation-modal-confirm-button"),$=document.getElementById("confirmation-modal-cancel-button"),D=document.getElementById("confirmation-modal-alternative-button");function F(e){if(!e)return;const t=e.min?parseFloat(e.min):0,n=e.max?parseFloat(e.max):100,a=(parseFloat(e.value)-t)/(n-t)*100;e.style.setProperty("--fill-percent",`${a}%`)}function G(e,t,n={}){M.innerHTML=e.replace(/\n/g,"<br>"),q.onclick=()=>{t&&t(),Ve(S)},$.onclick=()=>{n.onCancel&&n.onCancel(),Ve(S)},n.onAlternative?(D.style.display="inline-block",D.textContent=n.alternativeText||"選択肢",D.onclick=()=>{n.onAlternative&&n.onAlternative(),Ve(S)}):D.style.display="none",q.textContent=n.confirmText||"OK",$.textContent=n.cancelText||"キャンセル",q.classList.toggle("danger",!!n.isDanger),Ge(S)}function V(){G("この機能を利用するにはGoogleアカウントでのログインが必要です。",()=>{const e=new firebase.auth.GoogleAuthProvider;a.signInWithPopup(e).catch(e=>{"auth/popup-closed-by-user"!==e.code&&we(`ログインに失敗しました: ${e.message}`,"error")})},{confirmText:"Googleでログイン",cancelText:"キャンセル"})}xe(S,()=>Ve(S));const H=document.getElementById("edit-modal"),O=document.getElementById("bulk-edit-modal"),j=document.getElementById("random-generate-modal"),R=document.getElementById("save-preset-modal"),P=document.getElementById("load-preset-modal");let K=[],W=null,U=0,X=!1,J=!1,_=null,z=0,Q=[],Y=null,Z=null,ee=16,te=1,ne=null,ae=null,oe=null;const le=e.createGain();let ce=[{id:"B",name:"FX B",node:null,bypassNode:null,isActive:!1,effectType:"delay",params:{mix:.5,time:.25,feedback:.4,syncMode:"bpm",rate:4}},{id:"C",name:"FX C",node:null,bypassNode:null,isActive:!1,effectType:"reverb",params:{mix:.5}},{id:"D",name:"FX D",node:null,bypassNode:null,isActive:!1,effectType:"none",params:{}}];const se={none:{name:"エフェクトなし",params:{}},reverb:{name:"リバーブ",params:{mix:{label:"Mix",type:"range",min:0,max:1,step:.01,value:.5}},createNode:async e=>{const t=e.createConvolver(),n=e.createGain(),a=e.createGain(),o=e.sampleRate,l=2*o,c=e.createBuffer(2,l,o),s=c.getChannelData(0),r=c.getChannelData(1);for(let e=0;e<l;e++)s[e]=(2*Math.random()-1)*Math.pow(1-e/l,2.5),r[e]=(2*Math.random()-1)*Math.pow(1-e/l,2.5);return t.buffer=c,{convolver:t,wetGain:n,dryGain:a}}},delay:{name:"ディレイ",params:{mix:{label:"Mix",type:"range",min:0,max:1,step:.01,value:.5},feedback:{label:"Feedback",type:"range",min:0,max:.9,step:.01,value:.4},time:{label:"Time",type:"range",min:.01,max:2,step:.01,value:.25},rate:{label:"Rate",type:"buttons",value:4,options:[{value:.5,label:"2分"},{value:.75,label:"2分3連符"},{value:1,label:"4分"},{value:1/1.5,label:"付点4分"},{value:1.5,label:"4分3連符"},{value:2,label:"8分"},{value:2/1.5,label:"付点8分"},{value:3,label:"8分3連符"},{value:4,label:"16分"}]}},createNode:e=>({delay:e.createDelay(5),feedback:e.createGain(),wetGain:e.createGain(),dryGain:e.createGain()})},slicer:{name:"スライサー",params:{depth:{label:"Depth",type:"range",min:0,max:1,step:.01,value:1},rate:{label:"Rate",type:"buttons",value:4,options:[{value:1,label:"4分"},{value:1.5,label:"4分3連符"},{value:2,label:"8分"},{value:2/1.5,label:"付点8分"},{value:3,label:"8分3連符"},{value:4,label:"16分"},{value:4/1.5,label:"付点16分"},{value:6,label:"16分3連符"},{value:8,label:"32分"}]}},createNode:e=>{const t=e.createGain(),n=e.createOscillator(),a=e.createGain(),o=e.createConstantSource();return n.type="square",t.gain.value=0,n.connect(a),a.connect(t.gain),o.connect(t.gain),n.start(),o.start(),{slicerGain:t,lfo:n,lfoGain:a,dcOffset:o}}}},re={C:0,"C♯":1,"D♭":1,D:2,"D♯":3,"E♭":3,E:4,F:5,"F♯":6,"G♭":6,G:7,"G♯":8,"A♭":8,A:9,"A♯":10,"B♭":10,B:11},ie=["C","C♯","D","D♯","E","F","F♯","G","G♯","A","A♯","B"],de=[1,2,3,4,5,6,7,8,9],ue={sine:"正弦波",square:"矩形波",sawtooth:"ノコギリ波",triangle:"三角波"},me=[{value:.25,label:"16分"},{value:1/3,label:"1拍3連"},{value:.5,label:"8分"},{value:2/3,label:"2拍3連"},{value:1,label:"4分"},{value:2,label:"2分"},{value:4,label:"全音符"}],pe={major:{name:"メジャー",intervals:[0,4,7]},minor:{name:"マイナー",intervals:[0,3,7]},dominant7th:{name:"ドミナント7th",intervals:[0,4,7,10]},major7th:{name:"メジャー7th",intervals:[0,4,7,11]},minor7th:{name:"マイナー7th",intervals:[0,3,7,10]},diminished:{name:"ディミニッシュ",intervals:[0,3,6]},augmented:{name:"オーギュメント",intervals:[0,4,8]},sus4:{name:"サスフォー",intervals:[0,5,7]},majorPentatonic:{name:"メジャーペンタ",intervals:[0,2,4,7,9]},minorPentatonic:{name:"マイナーペンタ",intervals:[0,3,5,7,10]}};async function ve(){for(const t of ce)"none"!==t.effectType&&se[t.effectType].createNode?(t.node=await se[t.effectType].createNode(e),t.node.type=t.effectType,Te(t)):t.node=null;ye()}function fe(e){const t=0===ce.indexOf(e)?le:ce[ce.indexOf(e)-1].bypassNode;if(t.disconnect(),e.isActive&&"none"!==e.effectType&&e.node){if("reverb"===e.effectType){const{convolver:n,wetGain:a,dryGain:o}=e.node;t.connect(o).connect(e.bypassNode),t.connect(n).connect(a).connect(e.bypassNode)}else if("delay"===e.effectType){const{delay:n,feedback:a,wetGain:o,dryGain:l}=e.node;t.connect(l).connect(e.bypassNode),t.connect(n),n.connect(o).connect(e.bypassNode),n.connect(a).connect(n)}else if("slicer"===e.effectType){const{slicerGain:n}=e.node;t.connect(n).connect(e.bypassNode)}}else t.connect(e.bypassNode)}function ye(){ce.forEach(fe)}function ge(e){const t=ce.find(t=>t.id===e),n=x.querySelector(`[data-fx-id="${e}"]`);t&&n&&(n.classList.toggle("active",t.isActive),n.querySelector(".fx-type-name").textContent=se[t.effectType].name)}function be(){Ve(w),ae=null}async function Ee(){const t=A.value,n=ae;if(!n||n.effectType===t)return;n.effectType=t;const a=se[t].params;n.params={};for(const e in a)n.params[e]=a[e].value;se[t].createNode?(n.node=await se[t].createNode(e),n.node.type=t):n.node=null,he()}function he(){const e=ae;if(C.innerHTML="",!e||"none"===e.effectType)return;const t=se[e.effectType].params;if("delay"===e.effectType){const n=e.params,a=(e,t)=>{const a=n[e]??t.value,o=document.createElement("div");o.className="fx-param-control",o.innerHTML=`\n                    <label>${t.label}</label>\n                    <div class="slider-wrapper">\n                        <input type="range" min="${t.min}" max="${t.max}" step="${t.step}" value="${a}" data-param-key="${e}">\n                        <span>${a}</span>\n                    </div>\n                `;const l=o.querySelector("input"),c=o.querySelector("span");return l.oninput=()=>{c.textContent=l.value,F(l)},F(l),o};C.appendChild(a("mix",t.mix)),C.appendChild(a("feedback",t.feedback));const o=document.createElement("div");o.className="fx-param-control toggle-switch-container",o.innerHTML='\n                <span class="toggle-label">Time (秒数で指定)</span>\n                <label class="toggle-switch">\n                    <input type="checkbox" data-param-key="syncMode">\n                    <span class="toggle-slider"></span>\n                </label>\n            ';const l=o.querySelector("input");C.appendChild(o);const c=document.createElement("div");c.dataset.syncControl="time",c.appendChild(a("time",t.time)),C.appendChild(c);const s=document.createElement("div");s.dataset.syncControl="bpm";const r=t.rate,i=n.rate??r.value,d=document.createElement("div");d.className="fx-param-control",d.innerHTML=`<label>${r.label}</label>`;const u=document.createElement("div");u.className="button-selector-group fx-param-buttons",u.dataset.paramKey="rate",r.options.forEach(e=>{const t=document.createElement("button");t.type="button",t.dataset.value=e.value,t.textContent=e.label,e.value==i&&t.classList.add("active"),t.onclick=()=>{u.querySelectorAll("button").forEach(e=>e.classList.remove("active")),t.classList.add("active")},u.appendChild(t)}),d.appendChild(u),s.appendChild(d),C.appendChild(s);const m=()=>{const e=l.checked;c.style.display=e?"":"none",s.style.display=e?"none":""};l.onchange=m,l.checked="time"===n.syncMode,m()}else for(const n in t){const a=t[n],o=e.params[n]??a.value,l=document.createElement("div");l.className="fx-param-control";const c=document.createElement("label");if(c.textContent=a.label,l.appendChild(c),"range"===a.type){const e=document.createElement("div");e.className="slider-wrapper",e.innerHTML=`\n                        <input type="range" min="${a.min}" max="${a.max}" step="${a.step}" value="${o}" data-param-key="${n}">\n                        <span>${o}</span>`;const t=e.querySelector('input[type="range"]'),c=e.querySelector("span");t.oninput=()=>{c.textContent=t.value,F(t)},l.appendChild(e),F(t)}else if("buttons"===a.type){const e=document.createElement("div");e.className="button-selector-group fx-param-buttons",e.dataset.paramKey=n,a.options.forEach(t=>{const n=document.createElement("button");n.type="button",n.dataset.value=t.value,n.textContent=t.label,t.value==o&&n.classList.add("active"),n.onclick=()=>{e.querySelectorAll("button").forEach(e=>e.classList.remove("active")),n.classList.add("active")},e.appendChild(n)}),l.appendChild(e)}C.appendChild(l)}}async function Ie(){const t=ae;if(t){if("delay"===t.effectType){const e=C.querySelector('input[data-param-key="syncMode"]');if(t.params.syncMode=e.checked?"time":"bpm",t.params.mix=parseFloat(C.querySelector('input[data-param-key="mix"]').value),t.params.feedback=parseFloat(C.querySelector('input[data-param-key="feedback"]').value),"time"===t.params.syncMode)t.params.time=parseFloat(C.querySelector('input[data-param-key="time"]').value);else{const e=C.querySelector('.button-selector-group[data-param-key="rate"]').querySelector("button.active");e&&(t.params.rate=parseFloat(e.dataset.value))}}else C.querySelectorAll('input[type="range"]').forEach(e=>{t.params[e.dataset.paramKey]=parseFloat(e.value)}),C.querySelectorAll(".button-selector-group").forEach(e=>{const n=e.dataset.paramKey,a=e.querySelector("button.active");a&&(t.params[n]=parseFloat(a.dataset.value))});t.node&&t.node.type===t.effectType||(se[t.effectType].createNode?(t.node=await se[t.effectType].createNode(e),t.node.type=t.effectType):t.node=null),Te(t),ye(),ge(t.id),be(),tt()}}function Te(t){if(!t.node||"none"===t.effectType)return;const n=t.params,a=e.currentTime;if("reverb"===t.effectType)t.node.wetGain.gain.setValueAtTime(n.mix,a),t.node.dryGain.gain.setValueAtTime(1-n.mix,a);else if("delay"===t.effectType){let e;if(t.node.wetGain.gain.setValueAtTime(n.mix,a),t.node.dryGain.gain.setValueAtTime(1-n.mix,a),"bpm"===n.syncMode){e=60/(parseFloat(m.value)*n.rate)}else e=n.time;e=Math.max(.001,Math.min(e,5)),t.node.delay.delayTime.setValueAtTime(e,a),t.node.feedback.gain.setValueAtTime(n.feedback,a)}else if("slicer"===t.effectType){const{lfo:e,lfoGain:o,dcOffset:l}=t.node,c=parseFloat(m.value)/60*n.rate,s=n.depth;e.frequency.setValueAtTime(c,a),o.gain.setValueAtTime(s/2,a),l.offset.setValueAtTime(s/2,a)}}function ke(){ce.filter(e=>e.isActive&&("slicer"===e.effectType||"delay"===e.effectType&&"bpm"===e.params.syncMode)).forEach(Te)}function Be(e,t){const n=Array.from(e.querySelectorAll("button")),a=e.querySelector("button.active");let o=n.findIndex(e=>e===a);-1===o?o=0:o+=t,o>=n.length?o=0:o<0&&(o=n.length-1),n[o].click()}function xe(e,t){e.querySelector(".close-button").onclick=t,window.addEventListener("click",n=>{n.target==e&&t()})}function we(e,t="info",n=3e3){const a=document.createElement("div");a.className=`toast-message ${t}`,a.textContent=e,E.appendChild(a),setTimeout(()=>a.classList.add("show"),10),setTimeout(()=>{a.classList.remove("show"),a.addEventListener("transitionend",()=>a.remove())},n)}function Le(e){const t=K[e],n=t.playbackElements;n.noteDisplay.textContent=`${t.note.replace("♯","#")}${t.octave}`,n.waveDisplay.textContent=ue[t.waveform]||t.waveform,n.volumeBar.style.width=100*t.volume+"%"}function Ae(t){X&&Me();const n=()=>{X=!0,J=t,U=0,z=e.currentTime+.05,document.querySelectorAll(".playback-block.playing").forEach(e=>e.classList.remove("playing")),Ce()};"suspended"===e.state?e.resume().then(n):n()}function Ce(){if(!X)return;const t=60/parseFloat(m.value)*te;for(;z<e.currentTime+.1;){if(U>=ee){if(!J)return void Me();U=0}const e=K[U],n=.1;Fe(U,t,z),$e(e,t,z+n),z+=t,U++}X&&(_=setTimeout(Ce,25))}let Ne=null,Se=[];function Me(){X=!1,J=!1,_&&clearTimeout(_),_=null;const t=e.currentTime;Q.forEach(({gainNode:e})=>{try{e.gain.cancelScheduledValues(t),e.gain.setValueAtTime(e.gain.value,t),e.gain.linearRampToValueAtTime(0,t+.02)}catch(e){}}),Q=[],document.querySelectorAll(".playback-block.playing").forEach(e=>e.classList.remove("playing")),U=0,qe()}function qe(){Ne&&clearTimeout(Ne),Ne=null;const t=e.currentTime;Se.forEach(({gainNode:e})=>{try{e.gain.cancelScheduledValues(t),e.gain.setValueAtTime(e.gain.value,t),e.gain.linearRampToValueAtTime(0,t+.02)}catch(e){}}),Se=[],document.querySelectorAll(".action-button.preview.playing").forEach(e=>{e.classList.remove("playing"),e.innerHTML='<i class="fa-solid fa-play"></i> 試聴'})}function $e(t,n,a=e.currentTime){if(0===t.volume)return;const o=De(t.note,t.octave);if(0===o)return;const l=e.createOscillator(),c=e.createGain();l.type=t.waveform,l.frequency.setValueAtTime(o,a);const s=Math.min(.04,.3*n);c.gain.setValueAtTime(0,a),c.gain.linearRampToValueAtTime(t.volume,a+.01),a+n-s>a+.01&&c.gain.setValueAtTime(t.volume,a+n-s),c.gain.linearRampToValueAtTime(0,a+n),l.connect(c).connect(le),l.start(a),l.stop(a+n+.01);const r={oscillator:l,gainNode:c,blockId:t.id};Q.push(r),setTimeout(()=>Q=Q.filter(e=>e!==r),1e3*(n+.1))}function De(e,t){const n=re[e.replace("#","♯")];if(void 0===n)return 0;const a=12*(t+1)+n;return 440*Math.pow(2,(a-69)/12)}function Fe(t,n,a){const o=K[t]?.playbackElements?.blockElement;if(o){const t=1e3*(a-e.currentTime);setTimeout(()=>{o.classList.add("playing"),setTimeout(()=>o.classList.remove("playing"),1e3*n)},Math.max(0,t))}}function Ge(e){e.style.display="flex",setTimeout(()=>e.classList.add("active"),10)}function Ve(e){e.classList.remove("active"),setTimeout(()=>e.style.display="none",300)}function He(e){Y=e;const t=K[e];document.getElementById("modal-title").textContent=`ステップ ${e+1} 編集`,pt(document.getElementById("modal-note-buttons"),t.note),pt(document.getElementById("modal-octave-buttons"),t.octave),pt(document.getElementById("modal-waveform-buttons"),t.waveform);const n=document.getElementById("modal-volume");n.value=100*t.volume,F(n),document.getElementById("modal-volume-display").textContent=`${Math.round(100*t.volume)}%`,Ge(H)}function Oe(){Ve(H),Y=null}function je(){if(null===Y)return;const e=Y,t=e=>e.querySelector("button.active")?.dataset.value;K[e].note=t(document.getElementById("modal-note-buttons"))||K[e].note,K[e].octave=parseInt(t(document.getElementById("modal-octave-buttons")))||K[e].octave,K[e].waveform=t(document.getElementById("modal-waveform-buttons"))||K[e].waveform,K[e].volume=parseInt(document.getElementById("modal-volume").value)/100,Le(e),Oe(),tt()}function Re(){if(null===Y)return;const t=e=>e.querySelector("button.active")?.dataset.value,n={note:t(document.getElementById("modal-note-buttons")),octave:parseInt(t(document.getElementById("modal-octave-buttons"))),waveform:t(document.getElementById("modal-waveform-buttons")),volume:parseInt(document.getElementById("modal-volume").value)/100};var a,o;a=n,o=.5,"suspended"===e.state?e.resume().then(()=>$e(a,o)):$e(a,o)}function Pe(){[document.getElementById("bulk-modal-note-buttons"),document.getElementById("bulk-modal-octave-buttons"),document.getElementById("bulk-modal-waveform-buttons")].forEach(e=>e.querySelectorAll("button.active").forEach(e=>e.classList.remove("active")));const e=document.getElementById("bulk-modal-volume");e.value=50,document.getElementById("bulk-modal-volume-display").textContent="50%",e.dataset.isSetForBulk="false",e.style.opacity=.5,document.getElementById("bulk-modal-volume-display").style.opacity=.5,F(e),Ge(O)}function Ke(){Ve(O)}function We(){const e=e=>e.querySelector("button.active")?.dataset.value,t={note:e(document.getElementById("bulk-modal-note-buttons")),octave:parseInt(e(document.getElementById("bulk-modal-octave-buttons"))),waveform:e(document.getElementById("bulk-modal-waveform-buttons"))};"true"===document.getElementById("bulk-modal-volume").dataset.isSetForBulk&&(t.volume=parseInt(document.getElementById("bulk-modal-volume").value)/100);for(let e=0;e<16;e++)t.note&&(K[e].note=t.note),isNaN(t.octave)||(K[e].octave=t.octave),t.waveform&&(K[e].waveform=t.waveform),void 0!==t.volume&&(K[e].volume=t.volume),Le(e);Ke(),tt()}function Ue(){Ge(j)}function Xe(){Ve(j)}function Je(){K.forEach((e,t)=>{Object.assign(e,{note:"A",octave:4,waveform:"sawtooth",volume:.5}),Le(t)}),m.value=120,te=1,pt(u,te),ee=16,pt(d,ee)}function _e(e=!1,t=null){if(!W)return void V();const a=()=>{const a=document.getElementById("preset-name"),o=document.getElementById("preset-description"),l=document.getElementById("tag-display-container"),c=document.getElementById("preset-tags-input"),s=document.getElementById("save-preset-button"),r=R.querySelector("h3");delete R.dataset.editingId;const i=document.getElementById("overwrite-preset-button");i&&i.remove(),e?(r.textContent="名前を付けて保存",s.textContent="保存"):(r.textContent="新規プリセット作成",s.textContent="作成して保存"),a.value="",o.value="",l.innerHTML="",c.value="",s.disabled=!0,s.onclick=()=>async function(e,t=null){if(!W)return void we("ログインが必要です。","error");const a=document.getElementById("preset-name").value.trim();if(!a)return void we("プリセット名は必須です。","error");const o=document.getElementById("tag-display-container"),l=Array.from(o.querySelectorAll(".tag-badge span:first-child")).map(e=>e.textContent);e||Je();const c={name:a,description:document.getElementById("preset-description").value.trim(),tags:l,...Ze(),createdAt:firebase.firestore.FieldValue.serverTimestamp(),updatedAt:firebase.firestore.FieldValue.serverTimestamp()};try{const e=await n.collection("users").doc(W.uid).collection("presets").add(c);ne=e.id,we(`プリセット「${a}」を作成しました。`,"success"),ot(a,!0),et(),lt(),t&&t()}catch(e){we(`プリセットの作成に失敗しました: ${e.message}`,"error"),console.error("Error creating new preset: ",e)}}(!0,t),Ge(R)},o=I.textContent.includes("*");!e&&o?G("新規作成します。\n現在の編集内容は保存しますか？",()=>{nt(()=>{Je(),ot("新規シーケンス",!1,!1),et()})},{confirmText:"保存して続行",onCancel:()=>{Je(),ot("新規シーケンス",!1,!1),et(),a()},cancelText:"破棄して続行",onAlternative:()=>{},alternativeText:"キャンセル",isDanger:!1}):a()}function ze(){ne=null,ot(null,!1);const e=e=>e.querySelector("button.active")?.dataset.value,t=e(document.getElementById("rg-root-note-buttons")),n=parseInt(e(document.getElementById("rg-octave-min-buttons"))),a=parseInt(e(document.getElementById("rg-octave-max-buttons"))),o=parseInt(e(document.getElementById("rg-steps-buttons")));if(!(t&&n&&a&&o))return void we("ランダム生成の全項目を選択してください。","error");if(n>a)return void we("最小オクターブは最大以下にしてください。","error");const l=pe[document.getElementById("rg-chord-type").value],c=re[t],s=[];for(let e=n;e<=a;e++)l.intervals.forEach(t=>{const n=12*(e+1)+c+t,a=n%12,o=Math.floor(n/12)-1;let l=ie.find(e=>re[e]===a&&!e.includes("♭"))||ie[a];o>=1&&o<=9&&s.push({note:l,octave:o})});if(0!==s.length){for(let e=0;e<o;e++){const t=s[Math.floor(Math.random()*s.length)];K[e].note=t.note,K[e].octave=t.octave,Le(e)}ee=o,pt(d,ee),Xe(),we("ランダム生成を実行しました。","success"),tt()}else we("指定範囲で生成可能な音がありません。","error")}const Qe="oscbot_local_backup";async function Ye(e){if(e.sequenceData.forEach((e,t)=>{K[t]&&(Object.assign(K[t],e),Le(t))}),m.value=e.bpm,te=e.noteDuration,pt(u,te),ee=e.sequenceMax,pt(d,ee),e.fxSlots){for(let t=0;t<ce.length;t++)if(e.fxSlots[t]){const n=ce[t],a=e.fxSlots[t];n.isActive=a.isActive,n.effectType=a.effectType;const o=se[a.effectType]?.params||{},l=Object.fromEntries(Object.entries(o).map(([e,t])=>[e,t.value]));n.params={...l,...a.params}}await ve(),ce.forEach(e=>ge(e.id))}}function Ze(){return{sequenceData:K.map(({note:e,octave:t,waveform:n,volume:a})=>({note:e,octave:t,waveform:n,volume:a})),bpm:parseInt(m.value),noteDuration:te,sequenceMax:ee,fxSlots:ce.map(e=>({isActive:e.isActive,effectType:e.effectType,params:e.params}))}}function et(){localStorage.removeItem(Qe)}function tt(){!function(){try{const e={...Ze(),timestamp:(new Date).getTime()};localStorage.setItem(Qe,JSON.stringify(e))}catch(e){console.error("Error saving local backup:",e)}}(),ot(ne?I.textContent:"新規シーケンス",!1,!0),W&&ne&&(oe&&clearTimeout(oe),oe=setTimeout(()=>at(!0),1e4))}function nt(e=null){W?ne?(oe&&clearTimeout(oe),G("現在のプリセットの保存方法を選択してください",()=>{at(!1,e)},{onAlternative:()=>{_e(!0)},confirmText:"上書き保存",alternativeText:"別名で保存",cancelText:"キャンセル"})):_e(!0,e):_e(!0)}async function at(e,t=null){if(!W||!ne)return;const a=I.textContent;ot("保存中...",!1);try{const a=Ze(),o=n.collection("users").doc(W.uid).collection("presets").doc(ne);await o.update({...a,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});const l=(await o.get()).data().name;ot(l,!0),e||we(`「${l}」を保存しました。`,"success"),et(),t&&t()}catch(e){we(`保存に失敗: ${e.message}`,"error"),console.error("Save error: ",e),ot(a.replace("保存中...",""),!1,!0)}}function ot(e,t,n=!1){const a=document.getElementById("manual-save-button"),o=document.getElementById("footer-save-button");let l=e||"新規シーケンス";const c=l.replace(/\s\*$/,"").replace(/^[\u2713\s]*/,"").replace(/^保存中.../,"");if(null!==e){if(!W&&!n)return h.style.display="none",void(o.disabled=!0);t?(l=`✓ ${c}`,a.textContent="保存済み",a.disabled=!0,o.disabled=!0):"保存中..."===e?(l="保存中...",a.textContent="保存中...",a.disabled=!0,o.disabled=!0):n?(l=`${c} *`,a.textContent="保存",a.disabled=!1,o.disabled=!1):(l=c,a.textContent="保存",a.disabled=!0,o.disabled=!0),I.textContent=l,h.style.display="flex",I.classList.toggle("editable",!!ne&&!!W)}else h.style.display="none"}function lt(){const e=document.getElementById("overwrite-preset-button");e&&e.remove(),Ve(R)}async function ct(e=!0){if(!W)return void we("ログインが必要です。","error");const t=document.getElementById("preset-name").value.trim();if(!t)return void we("プリセット名は必須です。","error");const a=R.dataset.editingId,o=document.getElementById("tag-display-container"),l=Array.from(o.querySelectorAll(".tag-badge span:first-child")).map(e=>e.textContent),c={name:t,description:document.getElementById("preset-description").value.trim(),tags:l,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};try{const t=n.collection("users").doc(W.uid).collection("presets");if(e&&a)await t.doc(a).update({name:c.name,description:c.description,tags:c.tags}),we("プリセット情報を更新しました。","success"),a===ne&&ot(c.name,!0),it();else{const e={...Ze(),...c,createdAt:firebase.firestore.FieldValue.serverTimestamp()},n=await t.add(e);ne=n.id,we(`「${c.name}」を保存しました。`,"success"),ot(c.name,!0),et()}lt()}catch(e){we(`保存に失敗しました: ${e.message}`,"error"),console.error("Error saving preset: ",e)}}function st(){W?(it(),Ge(P)):V()}function rt(){Ve(P)}async function it(){if(!W)return;const t=document.getElementById("preset-list"),a=document.getElementById("no-results-message"),o=document.getElementById("search-box").value.toLowerCase();t.innerHTML='<div class="loading-spinner"></div>';try{const l=await n.collection("users").doc(W.uid).collection("presets").orderBy("updatedAt","desc").get(),c=l.docs.map(e=>({id:e.id,...e.data()})).filter(e=>e.name.toLowerCase().includes(o)||e.description&&e.description.toLowerCase().includes(o)||e.tags&&e.tags.some(e=>e.toLowerCase().includes(o)));t.innerHTML="",c.length>0?(t.className="preset-grid",c.forEach(a=>{const o=document.createElement("div");o.className="preset-card-item";const l=document.createElement("div");l.className="preset-card-content";const c=document.createElement("h3");c.textContent=a.name;const s=document.createElement("p");s.textContent=a.description||"説明なし";const r=document.createElement("span");r.className="preset-timestamp",a.updatedAt&&a.updatedAt.toDate&&(r.textContent=`最終更新: ${a.updatedAt.toDate().toLocaleString()}`);const i=document.createElement("div");i.className="tags",a.tags&&a.tags.length>0&&(i.innerHTML=a.tags.map(e=>`<span class="tag">${e}</span>`).join(""));const d=document.createElement("div");d.className="actions";const u=document.createElement("button");u.className="action-button preview",u.innerHTML='<i class="fa-solid fa-play"></i> 試聴';const m=document.createElement("button");m.className="action-button edit",m.innerHTML='<i class="fa-solid fa-pen-to-square"></i>',m.title="名前やタグを編集";const p=document.createElement("button");p.className="action-button delete",p.innerHTML='<i class="fa-solid fa-trash"></i>',p.title="削除";const v=document.createElement("button");v.className="action-button load",v.textContent="読込",d.append(u,m,p,v),l.append(c,s,r,i,d),o.append(l),u.onclick=t=>{t.stopPropagation(),function(t){"suspended"===e.state&&e.resume();const n=Se.length>0;if(qe(),n)return;const a=event.target.closest(".action-button.preview");a&&(a.classList.add("playing"),a.innerHTML='<i class="fa-solid fa-stop"></i> 停止');let o=0,l=e.currentTime+.05;const c=t.sequenceData||[],s=t.sequenceMax||16,r=t.noteDuration||1,i=t.bpm||120,d=()=>{const t=60/i*r;for(;l<e.currentTime+.1;){if(o>=s)return void qe();const n=c[o];if(n&&n.volume>0){const a=De(n.note,n.octave);if(a>0){const o=e.createOscillator(),c=e.createGain();o.type=n.waveform,o.frequency.setValueAtTime(a,l);const s=.01,r=Math.min(.04,.3*t);c.gain.setValueAtTime(0,l),c.gain.linearRampToValueAtTime(n.volume,l+s),l+t-r>l+s&&c.gain.setValueAtTime(n.volume,l+t-r),c.gain.linearRampToValueAtTime(0,l+t),o.connect(c).connect(le),o.start(l),o.stop(l+t+.01);const i={oscillator:o,gainNode:c};Se.push(i),setTimeout(()=>{Se=Se.filter(e=>e!==i)},1e3*(t+.1))}}l+=t,o++}Ne=o<s&&Se.length>0?setTimeout(d,25):setTimeout(qe,1e3*t)};d()}(a)},v.onclick=e=>{e.stopPropagation(),async function(e){if(!W)return;qe();try{const t=n.collection("users").doc(W.uid).collection("presets").doc(e),a=await t.get();if(!a.exists)return void we("プリセットが見つかりません。","error");const o=a.data();await Ye(o),ne=e,ot(o.name,!0),et(),we(`「${o.name}」を読み込みました。`,"success"),rt()}catch(e){we(`プリセットの読み込みに失敗しました: ${e.message}`,"error"),console.error("Error loading preset:",e)}}(a.id)},m.onclick=e=>{e.stopPropagation(),dt(a.id)},p.onclick=e=>{e.stopPropagation(),async function(e,t){if(!W)return;G(`本当にプリセット「${t}」を削除しますか？この操作は取り消せません。`,async()=>{try{await n.collection("users").doc(W.uid).collection("presets").doc(e).delete(),we("プリセットを削除しました。","success"),ne===e&&(ne=null,ot(null)),it()}catch(e){we(`プリセットの削除に失敗しました: ${e.message}`,"error"),console.error("Error deleting preset:",e)}},{isDanger:!0})}(a.id,a.name)},t.appendChild(o)}),a.style.display="none"):(t.className="preset-list",a.style.display="block")}catch(e){t.innerHTML="プリセットの読み込みに失敗しました。",we("プリセットの読み込みに失敗しました。","error"),console.error("Error populating presets: ",e)}}async function dt(e){if(W)try{const t=n.collection("users").doc(W.uid).collection("presets").doc(e),a=await t.get();if(!a.exists)return void we("編集対象のプリセットが見つかりません。","error");const o=a.data();R.querySelector("h3").textContent="プリセット情報の編集";const l=document.getElementById("preset-name");l.value=o.name,document.getElementById("preset-description").value=o.description||"";const c=document.getElementById("tag-display-container");c.innerHTML="",o.tags&&o.tags.forEach(e=>{const t=document.createElement("div");t.className="tag-badge",t.innerHTML=`<span>${e}</span><span class="remove-tag">×</span>`,c.appendChild(t)});const s=document.getElementById("save-preset-button");s.textContent="変更を保存",s.onclick=()=>ct(!0),s.disabled=""===l.value.trim(),R.dataset.editingId=e;const r=document.getElementById("overwrite-preset-button");r&&r.remove(),rt(),Ge(R)}catch(e){we("プリセット情報の取得に失敗しました。","error")}}function ut(e,t,n,a=e=>e){e.innerHTML="",t.forEach(t=>{const n=document.createElement("button");n.type="button",n.dataset.value=t,n.textContent=a(t),n.onclick=t=>{(e.id.startsWith("bulk-")||e.id.startsWith("rg-"))&&!e.id.includes("waveform")?t.target.classList.contains("active")?t.target.classList.remove("active"):(e.querySelectorAll("button.active").forEach(e=>e.classList.remove("active")),t.target.classList.add("active")):(e.querySelectorAll("button").forEach(e=>e.classList.remove("active")),t.target.classList.add("active"))},e.appendChild(n)})}function mt(e,t,n,a,o="value",l="label"){e.innerHTML="",t.forEach(t=>{const c=document.createElement("button"),s="object"==typeof t?t[o]:t;c.dataset.value=s,c.textContent="object"==typeof t?t[l]:t,s===a&&c.classList.add("active"),c.onclick=()=>{n(s),e.querySelectorAll("button").forEach(e=>e.classList.remove("active")),c.classList.add("active")},e.appendChild(c)})}function pt(e,t){e.querySelectorAll("button").forEach(e=>{const n=isNaN(parseFloat(e.dataset.value))?e.dataset.value:parseFloat(e.dataset.value),a=isNaN(parseFloat(t))?t:parseFloat(t);e.classList.toggle("active",n===a)})}function vt(e){let t=(parseInt(m.value)||120)+e;m.value=Math.max(20,Math.min(300,t))}o.addEventListener("click",()=>{const e=new firebase.auth.GoogleAuthProvider;a.signInWithPopup(e).catch(e=>{"auth/popup-closed-by-user"!==e.code&&we("ログインに失敗しました: "+e.message,"error")})}),l.addEventListener("click",()=>{G("本当にログアウトしますか？",()=>a.signOut(),{isDanger:!0})});const ft=document.getElementById("loading-overlay"),yt=document.querySelector(".sequencer-app");ft.style.opacity="0",yt.classList.add("loaded"),setTimeout(()=>{ft.style.display="none"},500),async function(){await async function(){let t=le;for(const n of ce)n.bypassNode=e.createGain(),t.connect(n.bypassNode),t=n.bypassNode;t.connect(e.destination)}(),await ve(),function(){i.innerHTML="",K=[];for(let e=0;e<16;e++){const t=document.createElement("div");t.className="playback-block",t.dataset.id=e,t.draggable=!0,t.onclick=()=>He(e);const n=document.createElement("span");n.className="step-number-pb",n.textContent=e+1;const a=document.createElement("div");a.className="pb-note";const o=document.createElement("div");o.className="pb-wave";const l=document.createElement("div");l.className="pb-volume-container";const c=document.createElement("div");c.className="pb-volume-bar",l.appendChild(c),t.append(n,a,o,l),i.appendChild(t),K.push({id:e,note:"A",octave:4,waveform:"sawtooth",volume:.5,playbackElements:{blockElement:t,noteDisplay:a,waveDisplay:o,volumeBar:c}}),Le(e)}}(),function(){const e=Object.keys(ue);ut(document.getElementById("modal-note-buttons"),ie,"note",e=>e.replace("♯","#")),ut(document.getElementById("modal-octave-buttons"),de,"octave"),ut(document.getElementById("modal-waveform-buttons"),e,"waveform",e=>ue[e]),ut(document.getElementById("bulk-modal-note-buttons"),ie,"note",e=>e.replace("♯","#")),ut(document.getElementById("bulk-modal-octave-buttons"),de,"octave"),ut(document.getElementById("bulk-modal-waveform-buttons"),e,"waveform",e=>ue[e]),mt(d,Array.from({length:16},(e,t)=>t+1),e=>{ee=parseInt(e),tt()},ee),mt(u,me,e=>{te=parseFloat(e),tt()},te,"value","label"),function(){const e=Array.from({length:16},(e,t)=>t+1);ut(document.getElementById("rg-root-note-buttons"),ie,"rg-root",e=>e.replace("♯","#")),pt(document.getElementById("rg-root-note-buttons"),"C");document.getElementById("rg-chord-type").innerHTML=Object.keys(pe).map(e=>`<option value="${e}">${pe[e].name}</option>`).join(""),ut(document.getElementById("rg-octave-min-buttons"),de,"rg-octave-min"),pt(document.getElementById("rg-octave-min-buttons"),3),ut(document.getElementById("rg-octave-max-buttons"),de,"rg-octave-max"),pt(document.getElementById("rg-octave-max-buttons"),5),ut(document.getElementById("rg-steps-buttons"),e,"rg-steps"),pt(document.getElementById("rg-steps-buttons"),ee)}(),x.innerHTML="",ce.forEach(e=>{const t=document.createElement("button");t.className="fx-slot-button",t.dataset.fxId=e.id,t.innerHTML=`<span class="fx-slot-name">${e.name}</span><span class="fx-type-name"></span>`;let n=null;const a=t=>{t.preventDefault(),n=setTimeout(()=>{var t;t=e.id,ae=ce.find(e=>e.id===t),ae&&(L.textContent=`${ae.name} 設定`,A.innerHTML=Object.keys(se).map(e=>`<option value="${e}">${se[e].name}</option>`).join(""),A.value=ae.effectType,he(),Ge(w)),n=null},500)},o=()=>{n&&clearTimeout(n),n=null},l=()=>{null!==n&&function(e){const t=ce.find(t=>t.id===e);t&&(t.isActive=!t.isActive,ge(e),fe(t),tt())}(e.id),o()};t.addEventListener("mousedown",a),t.addEventListener("touchstart",a,{passive:!1}),t.addEventListener("mouseup",l),t.addEventListener("mouseleave",o),t.addEventListener("touchend",l),x.appendChild(t),ge(e.id)})}(),function(){v.onclick=()=>Ae(!1),f.onclick=()=>Ae(!0),y.onclick=Me,g.onclick=Pe,b.onclick=Ue,r.onclick=st,B.onclick=()=>_e(!1),T.onclick=nt,k.onclick=nt,I.addEventListener("click",()=>{ne&&W&&dt(ne)}),p.forEach(e=>e.addEventListener("click",()=>{vt(parseInt(e.dataset.step)),ke(),tt()})),m.addEventListener("change",()=>{m.value=Math.max(20,Math.min(300,parseInt(m.value)||120)),ke(),tt()}),i.addEventListener("dragstart",e=>{e.target.classList.contains("playback-block")&&(Z=e.target,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",e.target.innerHTML),e.target.classList.add("dragging"))}),i.addEventListener("dragover",e=>{e.preventDefault();const t=e.target.closest(".playback-block");t&&t!==Z&&t.classList.add("drag-over")}),i.addEventListener("dragleave",e=>{const t=e.target.closest(".playback-block");t&&t.classList.remove("drag-over")}),i.addEventListener("dragend",e=>e.target.classList.remove("dragging")),i.addEventListener("drop",e=>{e.preventDefault();const t=e.target.closest(".playback-block");if(!t||!Z||t===Z)return void(t&&t.classList.remove("drag-over"));t.classList.remove("drag-over");const n=parseInt(Z.dataset.id),a=parseInt(t.dataset.id);G(`ステップ${n+1}のデータをステップ${a+1}と入れ替えますか？`,()=>{!function(e,t){const n={...K[e]},a={...K[t]};["note","octave","waveform","volume"].forEach(o=>{K[e][o]=a[o],K[t][o]=n[o]}),Le(e),Le(t),tt()}(n,a)},{confirmText:"入れ替え",cancelText:"キャンセル",onAlternative:()=>{!function(e,t){const n={...K[e]};["note","octave","waveform","volume"].forEach(e=>{K[t][e]=n[e]}),Le(t),tt()}(n,a)},alternativeText:"上書き"}),Z=null}),xe(H,Oe),xe(O,Ke),xe(j,Xe),xe(R,lt),xe(P,rt),xe(w,be),N.onclick=Ie,A.onchange=Ee,document.getElementById("modal-volume").oninput=e=>{document.getElementById("modal-volume-display").textContent=`${e.target.value}%`,F(e.target)},document.getElementById("modal-complete-button").onclick=je,document.getElementById("modal-play-test-button").onclick=Re;const e=document.getElementById("bulk-modal-volume"),t=document.getElementById("bulk-modal-volume-display");e.oninput=()=>{t.textContent=`${e.value}%`,e.dataset.isSetForBulk="true",e.style.opacity=1,t.style.opacity=1,F(e)},document.getElementById("bulk-modal-apply-button").onclick=We,document.getElementById("bulk-clear-volume-button").onclick=()=>{e.value=50,t.textContent="50%",e.dataset.isSetForBulk="false",e.style.opacity=.5,t.style.opacity=.5,F(e)},document.getElementById("rg-execute-button").onclick=ze,document.getElementById("save-preset-button").onclick=ct,document.getElementById("search-box").addEventListener("input",it),function(){const e=document.getElementById("preset-name"),t=document.getElementById("save-preset-button"),n=document.getElementById("preset-tags-input"),a=document.getElementById("tag-display-container");function o(e){const t=Array.from(a.querySelectorAll(".tag-badge span:first-child")).map(e=>e.textContent);if(t.includes(e)||t.length>=10)return;const n=document.createElement("div");n.className="tag-badge",n.innerHTML=`<span>${e}</span><span class="remove-tag">×</span>`,a.appendChild(n)}e.addEventListener("input",()=>{t.disabled=""===e.value.trim()}),n.addEventListener("keydown",e=>{"Enter"===e.key&&""!==n.value.trim()&&(e.preventDefault(),o(n.value.trim()),n.value="")}),a.addEventListener("click",e=>{e.target.classList.contains("remove-tag")&&e.target.parentElement.remove()})}(),window.addEventListener("keydown",e=>{const t=document.activeElement;if(["INPUT","TEXTAREA","SELECT"].includes(t.tagName)&&"range"===!t.type)return;const n=document.querySelector(".modal.active");if(!n||"Escape"===e.key)switch(e.key){case" ":X?y.click():f.click(),e.preventDefault();break;case"Enter":v.click(),e.preventDefault();break;case"ArrowUp":vt(e.shiftKey?10:1),e.preventDefault();break;case"ArrowDown":vt(e.shiftKey?-10:-1),e.preventDefault();break;case"ArrowRight":Be(e.shiftKey?d:u,1),e.preventDefault();break;case"ArrowLeft":Be(e.shiftKey?d:u,-1),e.preventDefault();break;case"Escape":n?n.querySelector(".close-button").click():X&&y.click(),e.preventDefault();break;case"r":case"R":b.click();break;case"b":case"B":g.click();break;case"l":case"L":r.click()}})}(),a.onAuthStateChanged(e=>{e?(W=e,function(e){const t=e.displayName||"ユーザー";if(s.textContent=`${t}さん`,e.photoURL){const t=document.createElement("img");t.src=e.photoURL,s.insertBefore(t,s.firstChild)}o.style.display="none",c.style.display="flex"}(e)):(W=null,o.style.display="block",c.style.display="none")}),function(){try{const e=localStorage.getItem(Qe);if(!e)return void ot("新規シーケンス");const t=JSON.parse(e);G(`未保存の作業データが見つかりました。（最終更新: ${new Date(t.timestamp).toLocaleString()}）復元しますか？`,()=>{Ye(t),tt(),we("作業を復元しました。","info")},{onCancel:()=>{et(),we("バックアップを破棄しました。","info"),ot("新規シーケンス",!1,!1)},confirmText:"復元する",cancelText:"破棄する"})}catch(e){console.error("Error loading local backup:",e),et()}}(),document.querySelectorAll('input[type="range"]').forEach(F)}()});