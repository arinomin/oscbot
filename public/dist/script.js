document.addEventListener("DOMContentLoaded",async()=>{const e=new(window.AudioContext||window.webkitAudioContext);if(!e)return void alert("Web Audio API not supported.");let t=null;try{const e=await fetch("/api/firebase-config");if(!e.ok){const t=await e.json();return console.error("Firebase configuration error:",t),void alert("Firebase設定の取得に失敗しました。管理者にお問い合わせください。")}t=await e.json()}catch(e){return console.error("Failed to fetch Firebase config:",e),void alert("Firebase設定の取得に失敗しました。ネットワーク接続を確認してください。")}firebase.initializeApp(t);const n=firebase.firestore(),a=firebase.auth(),o=document.getElementById("login-button"),l=document.getElementById("logout-button"),c=(document.getElementById("user-info"),document.getElementById("user-name"),document.getElementById("load-data-button"),document.getElementById("playback-grid")),s=document.getElementById("sequence-max-buttons"),r=document.getElementById("note-duration-buttons"),i=document.getElementById("bpm"),d=document.querySelectorAll(".bpm-adjust"),u=document.getElementById("play-once-button"),m=document.getElementById("play-loop-button"),p=document.getElementById("stop-button"),v=document.getElementById("bulk-edit-button"),y=document.getElementById("random-generate-trigger-button"),f=document.getElementById("toast-container"),g=document.getElementById("preset-status-container"),b=document.getElementById("current-preset-status"),E=(document.getElementById("manual-save-button"),document.getElementById("footer-save-button"),document.getElementById("new-preset-button"),document.getElementById("fx-slots-container")),h=document.getElementById("fx-edit-modal"),I=document.getElementById("fx-modal-title"),T=document.getElementById("fx-type-select"),k=document.getElementById("fx-params-container"),B=document.getElementById("fx-modal-complete-button"),x=document.getElementById("confirmation-modal"),w=document.getElementById("confirmation-modal-message"),L=document.getElementById("confirmation-modal-confirm-button"),A=document.getElementById("confirmation-modal-cancel-button"),C=document.getElementById("confirmation-modal-alternative-button");function N(e){if(!e)return;const t=e.min?parseFloat(e.min):0,n=e.max?parseFloat(e.max):100,a=(parseFloat(e.value)-t)/(n-t)*100;e.style.setProperty("--fill-percent",`${a}%`)}function M(e,t,n={}){w.innerHTML=e.replace(/\n/g,"<br>"),L.onclick=()=>{t&&t(),qe(x)},A.onclick=()=>{n.onCancel&&n.onCancel(),qe(x)},n.onAlternative?(C.style.display="inline-block",C.textContent=n.alternativeText||"選択肢",C.onclick=()=>{n.onAlternative&&n.onAlternative(),qe(x)}):C.style.display="none",L.textContent=n.confirmText||"OK",A.textContent=n.cancelText||"キャンセル",L.classList.toggle("danger",!!n.isDanger),Se(x)}Ee(x,()=>qe(x));const S=document.getElementById("edit-modal"),q=document.getElementById("bulk-edit-modal"),$=document.getElementById("random-generate-modal"),D=document.getElementById("save-preset-modal"),F=document.getElementById("load-preset-modal");let G=[],V=null,H=0,j=!1,O=!1,R=null,P=0,K=[],_=null,W=null,X=16,U=1,z=null,J=null,Q=null;const Y=e.createGain();let Z=[{id:"B",name:"FX B",node:null,bypassNode:null,isActive:!1,effectType:"delay",params:{mix:.5,time:.25,feedback:.4,syncMode:"bpm",rate:4}},{id:"C",name:"FX C",node:null,bypassNode:null,isActive:!1,effectType:"reverb",params:{mix:.5}},{id:"D",name:"FX D",node:null,bypassNode:null,isActive:!1,effectType:"none",params:{}}];const ee={none:{name:"エフェクトなし",params:{}},reverb:{name:"リバーブ",params:{mix:{label:"Mix",type:"range",min:0,max:1,step:.01,value:.5}},createNode:async e=>{const t=e.createConvolver(),n=e.createGain(),a=e.createGain(),o=e.sampleRate,l=2*o,c=e.createBuffer(2,l,o),s=c.getChannelData(0),r=c.getChannelData(1);for(let e=0;e<l;e++)s[e]=(2*Math.random()-1)*Math.pow(1-e/l,2.5),r[e]=(2*Math.random()-1)*Math.pow(1-e/l,2.5);return t.buffer=c,{convolver:t,wetGain:n,dryGain:a}}},delay:{name:"ディレイ",params:{mix:{label:"Mix",type:"range",min:0,max:1,step:.01,value:.5},feedback:{label:"Feedback",type:"range",min:0,max:.9,step:.01,value:.4},time:{label:"Time",type:"range",min:.01,max:2,step:.01,value:.25},rate:{label:"Rate",type:"buttons",value:4,options:[{value:.5,label:"2分"},{value:.75,label:"2分3連符"},{value:1,label:"4分"},{value:1/1.5,label:"付点4分"},{value:1.5,label:"4分3連符"},{value:2,label:"8分"},{value:2/1.5,label:"付点8分"},{value:3,label:"8分3連符"},{value:4,label:"16分"}]}},createNode:e=>({delay:e.createDelay(5),feedback:e.createGain(),wetGain:e.createGain(),dryGain:e.createGain()})},slicer:{name:"スライサー",params:{depth:{label:"Depth",type:"range",min:0,max:1,step:.01,value:1},rate:{label:"Rate",type:"buttons",value:4,options:[{value:1,label:"4分"},{value:1.5,label:"4分3連符"},{value:2,label:"8分"},{value:2/1.5,label:"付点8分"},{value:3,label:"8分3連符"},{value:4,label:"16分"},{value:4/1.5,label:"付点16分"},{value:6,label:"16分3連符"},{value:8,label:"32分"}]}},createNode:e=>{const t=e.createGain(),n=e.createOscillator(),a=e.createGain(),o=e.createConstantSource();return n.type="square",t.gain.value=0,n.connect(a),a.connect(t.gain),o.connect(t.gain),n.start(),o.start(),{slicerGain:t,lfo:n,lfoGain:a,dcOffset:o}}}},te={C:0,"C♯":1,"D♭":1,D:2,"D♯":3,"E♭":3,E:4,F:5,"F♯":6,"G♭":6,G:7,"G♯":8,"A♭":8,A:9,"A♯":10,"B♭":10,B:11},ne=["C","C♯","D","D♯","E","F","F♯","G","G♯","A","A♯","B"],ae=[1,2,3,4,5,6,7,8,9],oe={sine:"正弦波",square:"矩形波",sawtooth:"ノコギリ波",triangle:"三角波"},le=[{value:.25,label:"16分"},{value:1/3,label:"1拍3連"},{value:.5,label:"8分"},{value:2/3,label:"2拍3連"},{value:1,label:"4分"},{value:2,label:"2分"},{value:4,label:"全音符"}],ce={major:{name:"メジャー",intervals:[0,4,7]},minor:{name:"マイナー",intervals:[0,3,7]},dominant7th:{name:"ドミナント7th",intervals:[0,4,7,10]},major7th:{name:"メジャー7th",intervals:[0,4,7,11]},minor7th:{name:"マイナー7th",intervals:[0,3,7,10]},diminished:{name:"ディミニッシュ",intervals:[0,3,6]},augmented:{name:"オーギュメント",intervals:[0,4,8]},sus4:{name:"サスフォー",intervals:[0,5,7]},majorPentatonic:{name:"メジャーペンタ",intervals:[0,2,4,7,9]},minorPentatonic:{name:"マイナーペンタ",intervals:[0,3,5,7,10]}};async function se(){for(const t of Z)"none"!==t.effectType&&ee[t.effectType].createNode?(t.node=await ee[t.effectType].createNode(e),t.node.type=t.effectType,fe(t)):t.node=null;ie()}function re(e){const t=0===Z.indexOf(e)?Y:Z[Z.indexOf(e)-1].bypassNode;if(t.disconnect(),e.isActive&&"none"!==e.effectType&&e.node){if("reverb"===e.effectType){const{convolver:n,wetGain:a,dryGain:o}=e.node;t.connect(o).connect(e.bypassNode),t.connect(n).connect(a).connect(e.bypassNode)}else if("delay"===e.effectType){const{delay:n,feedback:a,wetGain:o,dryGain:l}=e.node;t.connect(l).connect(e.bypassNode),t.connect(n),n.connect(o).connect(e.bypassNode),n.connect(a).connect(n)}else if("slicer"===e.effectType){const{slicerGain:n}=e.node;t.connect(n).connect(e.bypassNode)}}else t.connect(e.bypassNode)}function ie(){Z.forEach(re)}function de(e){const t=document.getElementById("tag-display-container"),n=Array.from(t.querySelectorAll(".tag-badge span:first-child")).map(e=>e.textContent);if(n.includes(e)||n.length>=10)return;const a=document.createElement("div");a.className="tag-badge",a.innerHTML=`<span>${e}</span><span class="remove-tag">×</span>`,t.appendChild(a)}function ue(e){const t=Z.find(t=>t.id===e),n=E.querySelector(`[data-fx-id="${e}"]`);t&&n&&(n.classList.toggle("active",t.isActive),n.querySelector(".fx-type-name").textContent=ee[t.effectType].name)}function me(){qe(h),J=null}async function pe(){const t=T.value,n=J;if(!n||n.effectType===t)return;n.effectType=t;const a=ee[t].params;n.params={};for(const e in a)n.params[e]=a[e].value;ee[t].createNode?(n.node=await ee[t].createNode(e),n.node.type=t):n.node=null,ve()}function ve(){const e=J;if(k.innerHTML="",!e||"none"===e.effectType)return;const t=ee[e.effectType].params;if("delay"===e.effectType){const n=e.params,a=(e,t)=>{const a=n[e]??t.value,o=document.createElement("div");o.className="fx-param-control",o.innerHTML=`\n                    <label>${t.label}</label>\n                    <div class="slider-wrapper">\n                        <input type="range" min="${t.min}" max="${t.max}" step="${t.step}" value="${a}" data-param-key="${e}">\n                        <span>${a}</span>\n                    </div>\n                `;const l=o.querySelector("input"),c=o.querySelector("span");return l.oninput=()=>{c.textContent=l.value,N(l)},N(l),o};k.appendChild(a("mix",t.mix)),k.appendChild(a("feedback",t.feedback));const o=document.createElement("div");o.className="fx-param-control toggle-switch-container",o.innerHTML='\n                <span class="toggle-label">Time (秒数で指定)</span>\n                <label class="toggle-switch">\n                    <input type="checkbox" data-param-key="syncMode">\n                    <span class="toggle-slider"></span>\n                </label>\n            ';const l=o.querySelector("input");k.appendChild(o);const c=document.createElement("div");c.dataset.syncControl="time",c.appendChild(a("time",t.time)),k.appendChild(c);const s=document.createElement("div");s.dataset.syncControl="bpm";const r=t.rate,i=n.rate??r.value,d=document.createElement("div");d.className="fx-param-control",d.innerHTML=`<label>${r.label}</label>`;const u=document.createElement("div");u.className="button-selector-group fx-param-buttons",u.dataset.paramKey="rate",r.options.forEach(e=>{const t=document.createElement("button");t.type="button",t.dataset.value=e.value,t.textContent=e.label,e.value==i&&t.classList.add("active"),t.onclick=()=>{u.querySelectorAll("button").forEach(e=>e.classList.remove("active")),t.classList.add("active")},u.appendChild(t)}),d.appendChild(u),s.appendChild(d),k.appendChild(s);const m=()=>{const e=l.checked;c.style.display=e?"":"none",s.style.display=e?"none":""};l.onchange=m,l.checked="time"===n.syncMode,m()}else for(const n in t){const a=t[n],o=e.params[n]??a.value,l=document.createElement("div");l.className="fx-param-control";const c=document.createElement("label");if(c.textContent=a.label,l.appendChild(c),"range"===a.type){const e=document.createElement("div");e.className="slider-wrapper",e.innerHTML=`\n                        <input type="range" min="${a.min}" max="${a.max}" step="${a.step}" value="${o}" data-param-key="${n}">\n                        <span>${o}</span>`;const t=e.querySelector('input[type="range"]'),c=e.querySelector("span");t.oninput=()=>{c.textContent=t.value,N(t)},l.appendChild(e),N(t)}else if("buttons"===a.type){const e=document.createElement("div");e.className="button-selector-group fx-param-buttons",e.dataset.paramKey=n,a.options.forEach(t=>{const n=document.createElement("button");n.type="button",n.dataset.value=t.value,n.textContent=t.label,t.value==o&&n.classList.add("active"),n.onclick=()=>{e.querySelectorAll("button").forEach(e=>e.classList.remove("active")),n.classList.add("active")},e.appendChild(n)}),l.appendChild(e)}k.appendChild(l)}}async function ye(){const t=J;if(t){if("delay"===t.effectType){const e=k.querySelector('input[data-param-key="syncMode"]');if(t.params.syncMode=e.checked?"time":"bpm",t.params.mix=parseFloat(k.querySelector('input[data-param-key="mix"]').value),t.params.feedback=parseFloat(k.querySelector('input[data-param-key="feedback"]').value),"time"===t.params.syncMode)t.params.time=parseFloat(k.querySelector('input[data-param-key="time"]').value);else{const e=k.querySelector('.button-selector-group[data-param-key="rate"]').querySelector("button.active");e&&(t.params.rate=parseFloat(e.dataset.value))}}else k.querySelectorAll('input[type="range"]').forEach(e=>{t.params[e.dataset.paramKey]=parseFloat(e.value)}),k.querySelectorAll(".button-selector-group").forEach(e=>{const n=e.dataset.paramKey,a=e.querySelector("button.active");a&&(t.params[n]=parseFloat(a.dataset.value))});t.node&&t.node.type===t.effectType||(ee[t.effectType].createNode?(t.node=await ee[t.effectType].createNode(e),t.node.type=t.effectType):t.node=null),fe(t),ie(),ue(t.id),me(),Ue()}}function fe(t){if(!t.node||"none"===t.effectType)return;const n=t.params,a=e.currentTime;if("reverb"===t.effectType)t.node.wetGain.gain.setValueAtTime(n.mix,a),t.node.dryGain.gain.setValueAtTime(1-n.mix,a);else if("delay"===t.effectType){let e;if(t.node.wetGain.gain.setValueAtTime(n.mix,a),t.node.dryGain.gain.setValueAtTime(1-n.mix,a),"bpm"===n.syncMode){e=60/(parseFloat(i.value)*n.rate)}else e=n.time;e=Math.max(.001,Math.min(e,5)),t.node.delay.delayTime.setValueAtTime(e,a),t.node.feedback.gain.setValueAtTime(n.feedback,a)}else if("slicer"===t.effectType){const{lfo:e,lfoGain:o,dcOffset:l}=t.node,c=parseFloat(i.value)/60*n.rate,s=n.depth;e.frequency.setValueAtTime(c,a),o.gain.setValueAtTime(s/2,a),l.offset.setValueAtTime(s/2,a)}}function ge(){Z.filter(e=>e.isActive&&("slicer"===e.effectType||"delay"===e.effectType&&"bpm"===e.params.syncMode)).forEach(fe)}function be(e,t){const n=Array.from(e.querySelectorAll("button")),a=e.querySelector("button.active");let o=n.findIndex(e=>e===a);-1===o?o=0:o+=t,o>=n.length?o=0:o<0&&(o=n.length-1),n[o].click()}function Ee(e,t){e.querySelector(".close-button").onclick=t,window.addEventListener("click",n=>{n.target==e&&t()})}function he(e,t="info",n=3e3){const a=document.createElement("div");a.className=`toast-message ${t}`,a.textContent=e,f.appendChild(a),setTimeout(()=>a.classList.add("show"),10),setTimeout(()=>{a.classList.remove("show"),a.addEventListener("transitionend",()=>a.remove())},n)}function Ie(e,t,n=null,a=null){if("undefined"!=typeof gtag){gtag("event",e,{event_category:t,event_label:n,value:a})}}function Te(e){const t=G[e],n=t.playbackElements;n.noteDisplay.textContent=`${t.note.replace("♯","#")}${t.octave}`,n.waveDisplay.textContent=oe[t.waveform]||t.waveform,n.volumeBar.style.width=100*t.volume+"%"}function ke(t){j&&Le();const n=()=>{j=!0,O=t,H=0,P=e.currentTime+.05,document.querySelectorAll(".playback-block.playing").forEach(e=>e.classList.remove("playing")),Be(),Ie("play_sequence","audio",t?"loop":"once")};"suspended"===e.state?e.resume().then(n):n()}function Be(){if(!j)return;const t=60/parseFloat(i.value)*U;for(;P<e.currentTime+.1;){if(H>=X){if(!O)return void Le();H=0}const e=G[H],n=.1;Me(H,t,P),Ce(e,t,P+n),P+=t,H++}j&&(R=setTimeout(Be,25))}let xe=null,we=[];function Le(){j=!1,O=!1,R&&clearTimeout(R),R=null;const t=e.currentTime;K.forEach(({gainNode:e})=>{try{e.gain.cancelScheduledValues(t),e.gain.setValueAtTime(e.gain.value,t),e.gain.linearRampToValueAtTime(0,t+.02)}catch(e){}}),K=[],document.querySelectorAll(".playback-block.playing").forEach(e=>e.classList.remove("playing")),H=0,Ae()}function Ae(){xe&&clearTimeout(xe),xe=null;const t=e.currentTime;we.forEach(({gainNode:e})=>{try{e.gain.cancelScheduledValues(t),e.gain.setValueAtTime(e.gain.value,t),e.gain.linearRampToValueAtTime(0,t+.02)}catch(e){}}),we=[],document.querySelectorAll(".action-button.preview.playing").forEach(e=>{e.classList.remove("playing"),e.innerHTML='<i class="fa-solid fa-play"></i> 試聴'})}function Ce(t,n,a=e.currentTime){if(0===t.volume)return;const o=Ne(t.note,t.octave);if(0===o)return;const l=e.createOscillator(),c=e.createGain();l.type=t.waveform,l.frequency.setValueAtTime(o,a);const s=Math.min(.04,.3*n);c.gain.setValueAtTime(0,a),c.gain.linearRampToValueAtTime(t.volume,a+.01),a+n-s>a+.01&&c.gain.setValueAtTime(t.volume,a+n-s),c.gain.linearRampToValueAtTime(0,a+n),l.connect(c).connect(Y),l.start(a),l.stop(a+n+.01);const r={oscillator:l,gainNode:c,blockId:t.id};K.push(r),setTimeout(()=>K=K.filter(e=>e!==r),1e3*(n+.1))}function Ne(e,t){const n=te[e.replace("#","♯")];if(void 0===n)return 0;const a=12*(t+1)+n;return 440*Math.pow(2,(a-69)/12)}function Me(t,n,a){const o=G[t]?.playbackElements?.blockElement;if(o){const t=1e3*(a-e.currentTime);setTimeout(()=>{o.classList.add("playing"),setTimeout(()=>o.classList.remove("playing"),1e3*n)},Math.max(0,t))}}function Se(e){e.style.display="flex",setTimeout(()=>e.classList.add("active"),10)}function qe(e){e.classList.remove("active"),setTimeout(()=>e.style.display="none",300)}function $e(e){_=e;const t=G[e];document.getElementById("modal-title").textContent=`ステップ ${e+1} 編集`,nt(document.getElementById("modal-note-buttons"),t.note),nt(document.getElementById("modal-octave-buttons"),t.octave),nt(document.getElementById("modal-waveform-buttons"),t.waveform);const n=document.getElementById("modal-volume");n.value=100*t.volume,N(n),document.getElementById("modal-volume-display").textContent=`${Math.round(100*t.volume)}%`,Se(S)}function De(){qe(S),_=null}function Fe(){if(null===_)return;const e=_,t=e=>e.querySelector("button.active")?.dataset.value;G[e].note=t(document.getElementById("modal-note-buttons"))||G[e].note,G[e].octave=parseInt(t(document.getElementById("modal-octave-buttons")))||G[e].octave,G[e].waveform=t(document.getElementById("modal-waveform-buttons"))||G[e].waveform,G[e].volume=parseInt(document.getElementById("modal-volume").value)/100,Te(e),De(),Ue()}function Ge(){if(null===_)return;const t=e=>e.querySelector("button.active")?.dataset.value,n={note:t(document.getElementById("modal-note-buttons")),octave:parseInt(t(document.getElementById("modal-octave-buttons"))),waveform:t(document.getElementById("modal-waveform-buttons")),volume:parseInt(document.getElementById("modal-volume").value)/100};var a,o;a=n,o=.5,"suspended"===e.state?e.resume().then(()=>Ce(a,o)):Ce(a,o)}function Ve(){[document.getElementById("bulk-modal-note-buttons"),document.getElementById("bulk-modal-octave-buttons"),document.getElementById("bulk-modal-waveform-buttons")].forEach(e=>e.querySelectorAll("button.active").forEach(e=>e.classList.remove("active")));const e=document.getElementById("bulk-modal-volume");e.value=50,document.getElementById("bulk-modal-volume-display").textContent="50%",e.dataset.isSetForBulk="false",e.style.opacity=.5,document.getElementById("bulk-modal-volume-display").style.opacity=.5,N(e),Se(q)}function He(){qe(q)}function je(){const e=e=>e.querySelector("button.active")?.dataset.value,t={note:e(document.getElementById("bulk-modal-note-buttons")),octave:parseInt(e(document.getElementById("bulk-modal-octave-buttons"))),waveform:e(document.getElementById("bulk-modal-waveform-buttons"))};"true"===document.getElementById("bulk-modal-volume").dataset.isSetForBulk&&(t.volume=parseInt(document.getElementById("bulk-modal-volume").value)/100);for(let e=0;e<16;e++)t.note&&(G[e].note=t.note),isNaN(t.octave)||(G[e].octave=t.octave),t.waveform&&(G[e].waveform=t.waveform),void 0!==t.volume&&(G[e].volume=t.volume),Te(e);He(),Ue()}function Oe(){Se($)}function Re(){qe($)}function Pe(){z=null,ze(null,!1);const e=e=>e.querySelector("button.active")?.dataset.value,t=e(document.getElementById("rg-root-note-buttons")),n=parseInt(e(document.getElementById("rg-octave-min-buttons"))),a=parseInt(e(document.getElementById("rg-octave-max-buttons"))),o=parseInt(e(document.getElementById("rg-steps-buttons")));if(!(t&&n&&a&&o))return void he("ランダム生成の全項目を選択してください。","error");if(n>a)return void he("最小オクターブは最大以下にしてください。","error");const l=ce[document.getElementById("rg-chord-type").value],c=te[t],r=[];for(let e=n;e<=a;e++)l.intervals.forEach(t=>{const n=12*(e+1)+c+t,a=n%12,o=Math.floor(n/12)-1;let l=ne.find(e=>te[e]===a&&!e.includes("♭"))||ne[a];o>=1&&o<=9&&r.push({note:l,octave:o})});if(0!==r.length){for(let e=0;e<o;e++){const t=r[Math.floor(Math.random()*r.length)];G[e].note=t.note,G[e].octave=t.octave,Te(e)}X=o,nt(s,X),Re(),he("ランダム生成を実行しました。","success"),Ie("random_generate","creation_tools",l.name,o),Ue()}else he("指定範囲で生成可能な音がありません。","error")}const Ke="oscbot_local_backup";async function _e(e){if(e.sequenceData.forEach((e,t)=>{G[t]&&(Object.assign(G[t],e),Te(t))}),i.value=e.bpm,U=e.noteDuration,nt(r,U),X=e.sequenceMax,nt(s,X),e.fxSlots){for(let t=0;t<Z.length;t++)if(e.fxSlots[t]){const n=Z[t],a=e.fxSlots[t];n.isActive=a.isActive,n.effectType=a.effectType;const o=ee[a.effectType]?.params||{},l=Object.fromEntries(Object.entries(o).map(([e,t])=>[e,t.value]));n.params={...l,...a.params}}await se(),Z.forEach(e=>ue(e.id))}}function We(){return{sequenceData:G.map(({note:e,octave:t,waveform:n,volume:a})=>({note:e,octave:t,waveform:n,volume:a})),bpm:parseInt(i.value),noteDuration:U,sequenceMax:X,fxSlots:Z.map(e=>({isActive:e.isActive,effectType:e.effectType,params:e.params}))}}function Xe(){localStorage.removeItem(Ke)}function Ue(){!function(){try{const e={...We(),timestamp:(new Date).getTime()};localStorage.setItem(Ke,JSON.stringify(e))}catch(e){console.error("Error saving local backup:",e)}}(),ze(z?b.textContent:"新規シーケンス",!1,!0),V&&z&&(Q&&clearTimeout(Q),Q=setTimeout(()=>async function(e,t=null){if(!V||!z)return;const a=b.textContent;ze("保存中...",!1);try{const a=We(),o=n.collection("users").doc(V.uid).collection("presets").doc(z);await o.update({...a,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});const l=(await o.get()).data().name;ze(l,!0),e||he(`「${l}」を保存しました。`,"success"),Xe(),t&&t()}catch(e){he(`保存に失敗: ${e.message}`,"error"),console.error("Save error: ",e),ze(a.replace("保存中...",""),!1,!0)}}(!0),1e4))}function ze(e,t,n=!1){const a=document.getElementById("manual-save-button"),o=document.getElementById("footer-save-button");let l=e||"新規シーケンス";const c=l.replace(/\s\*$/,"").replace(/^[\u2713\s]*/,"").replace(/^保存中.../,"");if(null!==e){if(!V&&!n)return g.style.display="none",void(o.disabled=!0);t?(l=`✓ ${c}`,a.textContent="保存済み",a.disabled=!0,o.disabled=!0):"保存中..."===e?(l="保存中...",a.textContent="保存中...",a.disabled=!0,o.disabled=!0):n?(l=`${c} *`,a.textContent="保存",a.disabled=!1,o.disabled=!1):(l=c,a.textContent="保存",a.disabled=!0,o.disabled=!0),b.textContent=l,g.style.display="flex",b.classList.toggle("editable",!!z&&!!V)}else g.style.display="none"}function Je(){const e=document.getElementById("overwrite-preset-button");e&&e.remove(),qe(D)}async function Qe(e=!0){if(!V)return void he("ログインが必要です。","error");const t=document.getElementById("preset-name").value.trim();if(!t)return void he("プリセット名は必須です。","error");const a=document.getElementById("preset-tags-input");""!==a.value.trim()&&(de(a.value.trim()),a.value="");const o=D.dataset.editingId,l=document.getElementById("tag-display-container"),c=Array.from(l.querySelectorAll(".tag-badge span:first-child")).map(e=>e.textContent),s={name:t,description:document.getElementById("preset-description").value.trim(),tags:c,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};try{const t=n.collection("users").doc(V.uid).collection("presets");if(e&&o)await t.doc(o).update({name:s.name,description:s.description,tags:s.tags}),he("プリセット情報を更新しました。","success"),o===z&&ze(s.name,!0),Ze();else{const e={...We(),...s,createdAt:firebase.firestore.FieldValue.serverTimestamp()},n=await t.add(e);z=n.id,he(`「${s.name}」を保存しました。`,"success"),ze(s.name,!0),Xe()}Je()}catch(e){he(`保存に失敗しました: ${e.message}`,"error"),console.error("Error saving preset: ",e)}}function Ye(){qe(F)}async function Ze(){if(!V)return;const t=document.getElementById("preset-list"),a=document.getElementById("no-results-message"),o=document.getElementById("search-box").value.toLowerCase();t.innerHTML='<div class="loading-spinner"></div>';try{const l=await n.collection("users").doc(V.uid).collection("presets").orderBy("updatedAt","desc").get(),c=l.docs.map(e=>({id:e.id,...e.data()})).filter(e=>e.name.toLowerCase().includes(o)||e.description&&e.description.toLowerCase().includes(o)||e.tags&&e.tags.some(e=>e.toLowerCase().includes(o)));t.innerHTML="",c.length>0?(t.className="preset-grid",c.forEach(a=>{const o=document.createElement("div");o.className="preset-card-item";const l=document.createElement("div");l.className="preset-card-content";const c=document.createElement("h3");c.textContent=a.name;const s=document.createElement("p");s.textContent=a.description||"説明なし";const r=document.createElement("span");r.className="preset-timestamp",a.updatedAt&&a.updatedAt.toDate&&(r.textContent=`最終更新: ${a.updatedAt.toDate().toLocaleString()}`);const i=document.createElement("div");i.className="tags",a.tags&&a.tags.length>0&&(i.innerHTML=a.tags.map(e=>`<span class="tag">${e}</span>`).join(""));const d=document.createElement("div");d.className="actions";const u=document.createElement("button");u.className="action-button preview",u.innerHTML='<i class="fa-solid fa-play"></i> 試聴';const m=document.createElement("button");m.className="action-button edit",m.innerHTML='<i class="fa-solid fa-pen-to-square"></i>',m.title="名前やタグを編集";const p=document.createElement("button");p.className="action-button delete",p.innerHTML='<i class="fa-solid fa-trash"></i>',p.title="削除";const v=document.createElement("button");v.className="action-button load",v.textContent="読込",d.append(u,m,p,v),l.append(c,s,r,i,d),o.append(l),u.onclick=t=>{t.stopPropagation(),function(t){"suspended"===e.state&&e.resume();const n=we.length>0;if(Ae(),n)return;const a=event.target.closest(".action-button.preview");a&&(a.classList.add("playing"),a.innerHTML='<i class="fa-solid fa-stop"></i> 停止');let o=0,l=e.currentTime+.05;const c=t.sequenceData||[],s=t.sequenceMax||16,r=t.noteDuration||1,i=t.bpm||120,d=()=>{const t=60/i*r;for(;l<e.currentTime+.1;){if(o>=s)return void Ae();const n=c[o];if(n&&n.volume>0){const a=Ne(n.note,n.octave);if(a>0){const o=e.createOscillator(),c=e.createGain();o.type=n.waveform,o.frequency.setValueAtTime(a,l);const s=.01,r=Math.min(.04,.3*t);c.gain.setValueAtTime(0,l),c.gain.linearRampToValueAtTime(n.volume,l+s),l+t-r>l+s&&c.gain.setValueAtTime(n.volume,l+t-r),c.gain.linearRampToValueAtTime(0,l+t),o.connect(c).connect(Y),o.start(l),o.stop(l+t+.01);const i={oscillator:o,gainNode:c};we.push(i),setTimeout(()=>{we=we.filter(e=>e!==i)},1e3*(t+.1))}}l+=t,o++}xe=o<s&&we.length>0?setTimeout(d,25):setTimeout(Ae,1e3*t)};d()}(a)},v.onclick=e=>{e.stopPropagation(),async function(e){if(!V)return;Ae();try{const t=n.collection("users").doc(V.uid).collection("presets").doc(e),a=await t.get();if(!a.exists)return void he("プリセットが見つかりません。","error");const o=a.data();await _e(o),z=e,ze(o.name,!0),Xe(),he(`「${o.name}」を読み込みました。`,"success"),Ye()}catch(e){he(`プリセットの読み込みに失敗しました: ${e.message}`,"error"),console.error("Error loading preset:",e)}}(a.id)},m.onclick=e=>{e.stopPropagation(),async function(e){if(!V)return;try{const t=n.collection("users").doc(V.uid).collection("presets").doc(e),a=await t.get();if(!a.exists)return void he("編集対象のプリセットが見つかりません。","error");const o=a.data();D.querySelector("h3").textContent="プリセット情報の編集";const l=document.getElementById("preset-name");l.value=o.name,document.getElementById("preset-description").value=o.description||"";const c=document.getElementById("tag-display-container");c.innerHTML="",o.tags&&o.tags.forEach(e=>{const t=document.createElement("div");t.className="tag-badge",t.innerHTML=`<span>${e}</span><span class="remove-tag">×</span>`,c.appendChild(t)});const s=document.getElementById("save-preset-button");s.textContent="変更を保存",s.onclick=()=>Qe(!0),s.disabled=""===l.value.trim(),D.dataset.editingId=e;const r=document.getElementById("overwrite-preset-button");r&&r.remove(),Ye(),Se(D)}catch(e){he("プリセット情報の取得に失敗しました。","error")}}(a.id)},p.onclick=e=>{e.stopPropagation(),async function(e,t){if(!V)return;M(`本当にプリセット「${t}」を削除しますか？この操作は取り消せません。`,async()=>{try{await n.collection("users").doc(V.uid).collection("presets").doc(e).delete(),he("プリセットを削除しました。","success"),z===e&&(z=null,ze(null)),Ze()}catch(e){he(`プリセットの削除に失敗しました: ${e.message}`,"error"),console.error("Error deleting preset:",e)}},{isDanger:!0})}(a.id,a.name)},t.appendChild(o)}),a.style.display="none"):(t.className="preset-list",a.style.display="block")}catch(e){t.innerHTML="プリセットの読み込みに失敗しました。",he("プリセットの読み込みに失敗しました。","error"),console.error("Error populating presets: ",e)}}function et(e,t,n,a=e=>e){e.innerHTML="",t.forEach(t=>{const n=document.createElement("button");n.type="button",n.dataset.value=t,n.textContent=a(t),n.onclick=t=>{(e.id.startsWith("bulk-")||e.id.startsWith("rg-"))&&!e.id.includes("waveform")?t.target.classList.contains("active")?t.target.classList.remove("active"):(e.querySelectorAll("button.active").forEach(e=>e.classList.remove("active")),t.target.classList.add("active")):(e.querySelectorAll("button").forEach(e=>e.classList.remove("active")),t.target.classList.add("active"))},e.appendChild(n)})}function tt(e,t,n,a,o="value",l="label"){e.innerHTML="",t.forEach(t=>{const c=document.createElement("button"),s="object"==typeof t?t[o]:t;c.dataset.value=s,c.textContent="object"==typeof t?t[l]:t,s===a&&c.classList.add("active"),c.onclick=()=>{n(s),e.querySelectorAll("button").forEach(e=>e.classList.remove("active")),c.classList.add("active")},e.appendChild(c)})}function nt(e,t){e.querySelectorAll("button").forEach(e=>{const n=isNaN(parseFloat(e.dataset.value))?e.dataset.value:parseFloat(e.dataset.value),a=isNaN(parseFloat(t))?t:parseFloat(t);e.classList.toggle("active",n===a)})}function at(e){let t=(parseInt(i.value)||120)+e;i.value=Math.max(20,Math.min(300,t))}o.addEventListener("click",()=>{const e=new firebase.auth.GoogleAuthProvider;a.signInWithPopup(e).catch(e=>{"auth/popup-closed-by-user"!==e.code&&he("ログインに失敗しました: "+e.message,"error")})}),l.addEventListener("click",()=>{M("本当にログアウトしますか？",()=>a.signOut(),{isDanger:!0})});const ot=document.getElementById("loading-overlay"),lt=document.querySelector(".sequencer-app");ot.style.opacity="0",lt.classList.add("loaded"),setTimeout(()=>{ot.style.display="none"},500),async function(){await async function(){let t=Y;for(const n of Z)n.bypassNode=e.createGain(),t.connect(n.bypassNode),t=n.bypassNode;t.connect(e.destination)}(),await se(),function(){c.innerHTML="",G=[];for(let e=0;e<16;e++){const t=document.createElement("div");t.className="playback-block",t.dataset.id=e,t.draggable=!0,t.onclick=()=>$e(e);const n=document.createElement("span");n.className="step-number-pb",n.textContent=e+1;const a=document.createElement("div");a.className="pb-note";const o=document.createElement("div");o.className="pb-wave";const l=document.createElement("div");l.className="pb-volume-container";const s=document.createElement("div");s.className="pb-volume-bar",l.appendChild(s),t.append(n,a,o,l),c.appendChild(t),G.push({id:e,note:"A",octave:4,waveform:"sawtooth",volume:.5,playbackElements:{blockElement:t,noteDisplay:a,waveDisplay:o,volumeBar:s}}),Te(e)}}(),function(){const e=Object.keys(oe);et(document.getElementById("modal-note-buttons"),ne,"note",e=>e.replace("♯","#")),et(document.getElementById("modal-octave-buttons"),ae,"octave"),et(document.getElementById("modal-waveform-buttons"),e,"waveform",e=>oe[e]),et(document.getElementById("bulk-modal-note-buttons"),ne,"note",e=>e.replace("♯","#")),et(document.getElementById("bulk-modal-octave-buttons"),ae,"octave"),et(document.getElementById("bulk-modal-waveform-buttons"),e,"waveform",e=>oe[e]),tt(s,Array.from({length:16},(e,t)=>t+1),e=>{X=parseInt(e),Ue()},X),tt(r,le,e=>{U=parseFloat(e),Ue()},U,"value","label"),function(){const e=Array.from({length:16},(e,t)=>t+1);et(document.getElementById("rg-root-note-buttons"),ne,"rg-root",e=>e.replace("♯","#")),nt(document.getElementById("rg-root-note-buttons"),"C");document.getElementById("rg-chord-type").innerHTML=Object.keys(ce).map(e=>`<option value="${e}">${ce[e].name}</option>`).join(""),et(document.getElementById("rg-octave-min-buttons"),ae,"rg-octave-min"),nt(document.getElementById("rg-octave-min-buttons"),3),et(document.getElementById("rg-octave-max-buttons"),ae,"rg-octave-max"),nt(document.getElementById("rg-octave-max-buttons"),5),et(document.getElementById("rg-steps-buttons"),e,"rg-steps"),nt(document.getElementById("rg-steps-buttons"),X)}(),E.innerHTML="",Z.forEach(e=>{const t=document.createElement("button");t.className="fx-slot-button",t.dataset.fxId=e.id,t.innerHTML=`<span class="fx-slot-name">${e.name}</span><span class="fx-type-name"></span>`;let n=null;const a=t=>{t.preventDefault(),n=setTimeout(()=>{var t;t=e.id,J=Z.find(e=>e.id===t),J&&(I.textContent=`${J.name} 設定`,T.innerHTML=Object.keys(ee).map(e=>`<option value="${e}">${ee[e].name}</option>`).join(""),T.value=J.effectType,ve(),Se(h)),n=null},500)},o=()=>{n&&clearTimeout(n),n=null},l=()=>{null!==n&&function(e){const t=Z.find(t=>t.id===e);t&&(t.isActive=!t.isActive,ue(e),re(t),Ue())}(e.id),o()};t.addEventListener("mousedown",a),t.addEventListener("touchstart",a,{passive:!1}),t.addEventListener("mouseup",l),t.addEventListener("mouseleave",o),t.addEventListener("touchend",l),E.appendChild(t),ue(e.id)})}(),function(){u.onclick=()=>ke(!1),m.onclick=()=>ke(!0),p.onclick=Le,v.onclick=Ve,y.onclick=Oe,d.forEach(e=>e.addEventListener("click",()=>{at(parseInt(e.dataset.step)),ge(),Ue()})),i.addEventListener("change",()=>{i.value=Math.max(20,Math.min(300,parseInt(i.value)||120)),ge(),Ue()}),c.addEventListener("dragstart",e=>{e.target.classList.contains("playback-block")&&(W=e.target,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",e.target.innerHTML),e.target.classList.add("dragging"))}),c.addEventListener("dragover",e=>{e.preventDefault();const t=e.target.closest(".playback-block");t&&t!==W&&t.classList.add("drag-over")}),c.addEventListener("dragleave",e=>{const t=e.target.closest(".playback-block");t&&t.classList.remove("drag-over")}),c.addEventListener("dragend",e=>e.target.classList.remove("dragging")),c.addEventListener("drop",e=>{e.preventDefault();const t=e.target.closest(".playback-block");if(!t||!W||t===W)return void(t&&t.classList.remove("drag-over"));t.classList.remove("drag-over");const n=parseInt(W.dataset.id),a=parseInt(t.dataset.id);M(`ステップ${n+1}のデータをステップ${a+1}と入れ替えますか？`,()=>{!function(e,t){const n={...G[e]},a={...G[t]};["note","octave","waveform","volume"].forEach(o=>{G[e][o]=a[o],G[t][o]=n[o]}),Te(e),Te(t),Ue()}(n,a)},{confirmText:"入れ替え",cancelText:"キャンセル",onAlternative:()=>{!function(e,t){const n={...G[e]};["note","octave","waveform","volume"].forEach(e=>{G[t][e]=n[e]}),Te(t),Ue()}(n,a)},alternativeText:"上書き"}),W=null}),Ee(S,De),Ee(q,He),Ee($,Re),Ee(D,Je),Ee(F,Ye),Ee(h,me),B.onclick=ye,T.onchange=pe,document.getElementById("modal-volume").oninput=e=>{document.getElementById("modal-volume-display").textContent=`${e.target.value}%`,N(e.target)},document.getElementById("modal-complete-button").onclick=Fe,document.getElementById("modal-play-test-button").onclick=Ge;const e=document.getElementById("bulk-modal-volume"),t=document.getElementById("bulk-modal-volume-display");e.oninput=()=>{t.textContent=`${e.value}%`,e.dataset.isSetForBulk="true",e.style.opacity=1,t.style.opacity=1,N(e)},document.getElementById("bulk-modal-apply-button").onclick=je,document.getElementById("bulk-clear-volume-button").onclick=()=>{e.value=50,t.textContent="50%",e.dataset.isSetForBulk="false",e.style.opacity=.5,t.style.opacity=.5,N(e)},document.getElementById("rg-execute-button").onclick=Pe,document.getElementById("save-preset-button").onclick=Qe,document.getElementById("search-box").addEventListener("input",Ze),function(){const e=document.getElementById("preset-name"),t=document.getElementById("save-preset-button"),n=document.getElementById("preset-tags-input"),a=document.getElementById("tag-display-container");e.addEventListener("input",()=>{t.disabled=""===e.value.trim()}),n.addEventListener("keydown",e=>{"Enter"===e.key&&""!==n.value.trim()&&(e.preventDefault(),de(n.value.trim()),n.value="")}),a.addEventListener("click",e=>{e.target.classList.contains("remove-tag")&&e.target.parentElement.remove()})}(),window.addEventListener("keydown",e=>{const t=document.activeElement;if(["INPUT","TEXTAREA","SELECT"].includes(t.tagName)&&"range"===!t.type)return;const n=document.querySelector(".modal.active");if(!n||"Escape"===e.key)switch(e.key){case" ":j?p.click():m.click(),e.preventDefault();break;case"Enter":u.click(),e.preventDefault();break;case"ArrowUp":at(e.shiftKey?10:1),e.preventDefault();break;case"ArrowDown":at(e.shiftKey?-10:-1),e.preventDefault();break;case"ArrowRight":be(e.shiftKey?s:r,1),e.preventDefault();break;case"ArrowLeft":be(e.shiftKey?s:r,-1),e.preventDefault();break;case"Escape":n?n.querySelector(".close-button").click():j&&p.click(),e.preventDefault();break;case"r":case"R":y.click();break;case"b":case"B":v.click()}})}(),document.querySelectorAll('input[type="range"]').forEach(N)}()});