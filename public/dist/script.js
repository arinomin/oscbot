document.addEventListener("DOMContentLoaded",async()=>{const e=new(window.AudioContext||window.webkitAudioContext);if(!e)return void alert("Web Audio API not supported.");const t=()=>{"suspended"===e.state&&e.resume().catch(console.error)};document.addEventListener("click",t,{once:!0}),document.addEventListener("touchstart",t,{once:!0}),document.addEventListener("keydown",t,{once:!0});let n=null;try{const e=await fetch("/api/firebase-config");if(!e.ok){const t=await e.json();return console.error("Firebase configuration error:",t),void alert("Firebase設定の取得に失敗しました。管理者にお問い合わせください。")}n=await e.json()}catch(e){return console.error("Failed to fetch Firebase config:",e),void alert("Firebase設定の取得に失敗しました。ネットワーク接続を確認してください。")}firebase.initializeApp(n);const a=firebase.firestore(),o=firebase.auth(),c=document.getElementById("login-button"),l=document.getElementById("logout-button"),s=document.getElementById("user-info"),r=document.getElementById("user-name"),i=document.getElementById("load-data-button"),d=document.getElementById("playback-grid"),u=document.getElementById("sequence-max-buttons"),m=document.getElementById("note-duration-buttons"),p=document.getElementById("bpm"),f=document.querySelectorAll(".bpm-adjust"),v=document.getElementById("play-once-button"),y=document.getElementById("play-loop-button"),g=document.getElementById("stop-button"),b=document.getElementById("bulk-edit-button"),E=document.getElementById("random-generate-trigger-button"),h=document.getElementById("toast-container"),T=document.getElementById("preset-status-container"),I=document.getElementById("current-preset-status"),k=document.getElementById("manual-save-button"),x=document.getElementById("footer-save-button"),B=document.getElementById("new-preset-button"),w=document.getElementById("fx-slots-container"),L=document.getElementById("fx-edit-modal"),A=document.getElementById("fx-modal-title"),C=document.getElementById("fx-type-select"),N=document.getElementById("fx-params-container"),S=document.getElementById("fx-modal-complete-button"),M=document.getElementById("confirmation-modal"),q=document.getElementById("confirmation-modal-message"),$=document.getElementById("confirmation-modal-confirm-button"),D=document.getElementById("confirmation-modal-cancel-button"),F=document.getElementById("confirmation-modal-alternative-button");function G(e){if(!e)return;const t=e.min?parseFloat(e.min):0,n=e.max?parseFloat(e.max):100,a=(parseFloat(e.value)-t)/(n-t)*100;e.style.setProperty("--fill-percent",`${a}%`)}function V(e,t,n={}){q.innerHTML=e.replace(/\n/g,"<br>"),$.onclick=()=>{t&&t(),Oe(M)},D.onclick=()=>{n.onCancel&&n.onCancel(),Oe(M)},n.onAlternative?(F.style.display="inline-block",F.textContent=n.alternativeText||"選択肢",F.onclick=()=>{n.onAlternative&&n.onAlternative(),Oe(M)}):F.style.display="none",$.textContent=n.confirmText||"OK",D.textContent=n.cancelText||"キャンセル",$.classList.toggle("danger",!!n.isDanger),Re(M)}function H(){V("この機能を利用するにはTwitterアカウントでのログインが必要です。",()=>{!async function(){const e=new firebase.auth.TwitterAuthProvider;try{await o.signInWithRedirect(e)}catch(e){console.error("Firebase Twitter Auth Error:",e),Ae(`ログインに失敗しました: ${e.message}`,"error")}}()},{confirmText:"Twitterでログイン",cancelText:"キャンセル"})}Le(M,()=>Oe(M));const R=document.getElementById("edit-modal"),O=document.getElementById("bulk-edit-modal"),j=document.getElementById("random-generate-modal"),P=document.getElementById("save-preset-modal"),_=document.getElementById("load-preset-modal");let K=[],U=null,X=0,W=!1,J=!1,z=null,Q=0,Y=[],Z=null,ee=null,te=16,ne=1,ae=null,oe=null,ce=null;const le=e.createGain();let se=[{id:"B",name:"FX B",node:null,bypassNode:null,isActive:!1,effectType:"delay",params:{mix:.5,time:.25,feedback:.4,syncMode:"bpm",rate:4}},{id:"C",name:"FX C",node:null,bypassNode:null,isActive:!1,effectType:"reverb",params:{mix:.5}},{id:"D",name:"FX D",node:null,bypassNode:null,isActive:!1,effectType:"none",params:{}}];const re={none:{name:"エフェクトなし",params:{}},reverb:{name:"リバーブ",params:{mix:{label:"Mix",type:"range",min:0,max:1,step:.01,value:.5}},createNode:async e=>{const t=e.createConvolver(),n=e.createGain(),a=e.createGain(),o=e.sampleRate,c=2*o,l=e.createBuffer(2,c,o),s=l.getChannelData(0),r=l.getChannelData(1);for(let e=0;e<c;e++)s[e]=(2*Math.random()-1)*Math.pow(1-e/c,2.5),r[e]=(2*Math.random()-1)*Math.pow(1-e/c,2.5);return t.buffer=l,{convolver:t,wetGain:n,dryGain:a}}},delay:{name:"ディレイ",params:{mix:{label:"Mix",type:"range",min:0,max:1,step:.01,value:.5},feedback:{label:"Feedback",type:"range",min:0,max:.9,step:.01,value:.4},time:{label:"Time",type:"range",min:.01,max:2,step:.01,value:.25},rate:{label:"Rate",type:"buttons",value:4,options:[{value:.5,label:"2分"},{value:.75,label:"2分3連符"},{value:1,label:"4分"},{value:1/1.5,label:"付点4分"},{value:1.5,label:"4分3連符"},{value:2,label:"8分"},{value:2/1.5,label:"付点8分"},{value:3,label:"8分3連符"},{value:4,label:"16分"}]}},createNode:e=>({delay:e.createDelay(5),feedback:e.createGain(),wetGain:e.createGain(),dryGain:e.createGain()})},slicer:{name:"スライサー",params:{depth:{label:"Depth",type:"range",min:0,max:1,step:.01,value:1},rate:{label:"Rate",type:"buttons",value:4,options:[{value:1,label:"4分"},{value:1.5,label:"4分3連符"},{value:2,label:"8分"},{value:2/1.5,label:"付点8分"},{value:3,label:"8分3連符"},{value:4,label:"16分"},{value:4/1.5,label:"付点16分"},{value:6,label:"16分3連符"},{value:8,label:"32分"}]}},createNode:e=>{const t=e.createGain(),n=e.createOscillator(),a=e.createGain(),o=e.createConstantSource();return n.type="square",t.gain.value=0,n.connect(a),a.connect(t.gain),o.connect(t.gain),n.start(),o.start(),{slicerGain:t,lfo:n,lfoGain:a,dcOffset:o}}}},ie={C:0,"C♯":1,"D♭":1,D:2,"D♯":3,"E♭":3,E:4,F:5,"F♯":6,"G♭":6,G:7,"G♯":8,"A♭":8,A:9,"A♯":10,"B♭":10,B:11},de=["C","C♯","D","D♯","E","F","F♯","G","G♯","A","A♯","B"],ue=[1,2,3,4,5,6,7,8,9],me={sine:"正弦波",square:"矩形波",sawtooth:"ノコギリ波",triangle:"三角波"},pe=[{value:.25,label:"16分"},{value:1/3,label:"1拍3連"},{value:.5,label:"8分"},{value:2/3,label:"2拍3連"},{value:1,label:"4分"},{value:2,label:"2分"},{value:4,label:"全音符"}],fe={major:{name:"メジャー",intervals:[0,4,7]},minor:{name:"マイナー",intervals:[0,3,7]},dominant7th:{name:"ドミナント7th",intervals:[0,4,7,10]},major7th:{name:"メジャー7th",intervals:[0,4,7,11]},minor7th:{name:"マイナー7th",intervals:[0,3,7,10]},diminished:{name:"ディミニッシュ",intervals:[0,3,6]},augmented:{name:"オーギュメント",intervals:[0,4,8]},sus4:{name:"サスフォー",intervals:[0,5,7]},majorPentatonic:{name:"メジャーペンタ",intervals:[0,2,4,7,9]},minorPentatonic:{name:"マイナーペンタ",intervals:[0,3,5,7,10]}};async function ve(){for(const t of se)"none"!==t.effectType&&re[t.effectType].createNode?(t.node=await re[t.effectType].createNode(e),t.node.type=t.effectType,xe(t)):t.node=null;ge()}function ye(e){const t=0===se.indexOf(e)?le:se[se.indexOf(e)-1].bypassNode;if(t.disconnect(),e.isActive&&"none"!==e.effectType&&e.node){if("reverb"===e.effectType){const{convolver:n,wetGain:a,dryGain:o}=e.node;t.connect(o).connect(e.bypassNode),t.connect(n).connect(a).connect(e.bypassNode)}else if("delay"===e.effectType){const{delay:n,feedback:a,wetGain:o,dryGain:c}=e.node;t.connect(c).connect(e.bypassNode),t.connect(n),n.connect(o).connect(e.bypassNode),n.connect(a).connect(n)}else if("slicer"===e.effectType){const{slicerGain:n}=e.node;t.connect(n).connect(e.bypassNode)}}else t.connect(e.bypassNode)}function ge(){se.forEach(ye)}function be(e){const t=document.getElementById("tag-display-container"),n=Array.from(t.querySelectorAll(".tag-badge span:first-child")).map(e=>e.textContent);if(n.includes(e)||n.length>=10)return;const a=document.createElement("div");a.className="tag-badge",a.innerHTML=`<span>${e}</span><span class="remove-tag">×</span>`,t.appendChild(a)}function Ee(e){const t=se.find(t=>t.id===e),n=w.querySelector(`[data-fx-id="${e}"]`);t&&n&&(n.classList.toggle("active",t.isActive),n.querySelector(".fx-type-name").textContent=re[t.effectType].name)}function he(){Oe(L),oe=null}async function Te(){const t=C.value,n=oe;if(!n||n.effectType===t)return;n.effectType=t;const a=re[t].params;n.params={};for(const e in a)n.params[e]=a[e].value;re[t].createNode?(n.node=await re[t].createNode(e),n.node.type=t):n.node=null,Ie()}function Ie(){const e=oe;if(N.innerHTML="",!e||"none"===e.effectType)return;const t=re[e.effectType].params;if("delay"===e.effectType){const n=e.params,a=(e,t)=>{const a=n[e]??t.value,o=document.createElement("div");o.className="fx-param-control",o.innerHTML=`\n                    <label>${t.label}</label>\n                    <div class="slider-wrapper">\n                        <input type="range" min="${t.min}" max="${t.max}" step="${t.step}" value="${a}" data-param-key="${e}">\n                        <span>${a}</span>\n                    </div>\n                `;const c=o.querySelector("input"),l=o.querySelector("span");return c.oninput=()=>{l.textContent=c.value,G(c)},G(c),o};N.appendChild(a("mix",t.mix)),N.appendChild(a("feedback",t.feedback));const o=document.createElement("div");o.className="fx-param-control toggle-switch-container",o.innerHTML='\n                <span class="toggle-label">Time (秒数で指定)</span>\n                <label class="toggle-switch">\n                    <input type="checkbox" data-param-key="syncMode">\n                    <span class="toggle-slider"></span>\n                </label>\n            ';const c=o.querySelector("input");N.appendChild(o);const l=document.createElement("div");l.dataset.syncControl="time",l.appendChild(a("time",t.time)),N.appendChild(l);const s=document.createElement("div");s.dataset.syncControl="bpm";const r=t.rate,i=n.rate??r.value,d=document.createElement("div");d.className="fx-param-control",d.innerHTML=`<label>${r.label}</label>`;const u=document.createElement("div");u.className="button-selector-group fx-param-buttons",u.dataset.paramKey="rate",r.options.forEach(e=>{const t=document.createElement("button");t.type="button",t.dataset.value=e.value,t.textContent=e.label,e.value==i&&t.classList.add("active"),t.onclick=()=>{u.querySelectorAll("button").forEach(e=>e.classList.remove("active")),t.classList.add("active")},u.appendChild(t)}),d.appendChild(u),s.appendChild(d),N.appendChild(s);const m=()=>{const e=c.checked;l.style.display=e?"":"none",s.style.display=e?"none":""};c.onchange=m,c.checked="time"===n.syncMode,m()}else for(const n in t){const a=t[n],o=e.params[n]??a.value,c=document.createElement("div");c.className="fx-param-control";const l=document.createElement("label");if(l.textContent=a.label,c.appendChild(l),"range"===a.type){const e=document.createElement("div");e.className="slider-wrapper",e.innerHTML=`\n                        <input type="range" min="${a.min}" max="${a.max}" step="${a.step}" value="${o}" data-param-key="${n}">\n                        <span>${o}</span>`;const t=e.querySelector('input[type="range"]'),l=e.querySelector("span");t.oninput=()=>{l.textContent=t.value,G(t)},c.appendChild(e),G(t)}else if("buttons"===a.type){const e=document.createElement("div");e.className="button-selector-group fx-param-buttons",e.dataset.paramKey=n,a.options.forEach(t=>{const n=document.createElement("button");n.type="button",n.dataset.value=t.value,n.textContent=t.label,t.value==o&&n.classList.add("active"),n.onclick=()=>{e.querySelectorAll("button").forEach(e=>e.classList.remove("active")),n.classList.add("active")},e.appendChild(n)}),c.appendChild(e)}N.appendChild(c)}}async function ke(){const t=oe;if(t){if("delay"===t.effectType){const e=N.querySelector('input[data-param-key="syncMode"]');if(t.params.syncMode=e.checked?"time":"bpm",t.params.mix=parseFloat(N.querySelector('input[data-param-key="mix"]').value),t.params.feedback=parseFloat(N.querySelector('input[data-param-key="feedback"]').value),"time"===t.params.syncMode)t.params.time=parseFloat(N.querySelector('input[data-param-key="time"]').value);else{const e=N.querySelector('.button-selector-group[data-param-key="rate"]').querySelector("button.active");e&&(t.params.rate=parseFloat(e.dataset.value))}}else N.querySelectorAll('input[type="range"]').forEach(e=>{t.params[e.dataset.paramKey]=parseFloat(e.value)}),N.querySelectorAll(".button-selector-group").forEach(e=>{const n=e.dataset.paramKey,a=e.querySelector("button.active");a&&(t.params[n]=parseFloat(a.dataset.value))});t.node&&t.node.type===t.effectType||(re[t.effectType].createNode?(t.node=await re[t.effectType].createNode(e),t.node.type=t.effectType):t.node=null),xe(t),ge(),Ee(t.id),he(),ot()}}function xe(t){if(!t.node||"none"===t.effectType)return;const n=t.params,a=e.currentTime;if("reverb"===t.effectType)t.node.wetGain.gain.setValueAtTime(n.mix,a),t.node.dryGain.gain.setValueAtTime(1-n.mix,a);else if("delay"===t.effectType){let e;if(t.node.wetGain.gain.setValueAtTime(n.mix,a),t.node.dryGain.gain.setValueAtTime(1-n.mix,a),"bpm"===n.syncMode){e=60/(parseFloat(p.value)*n.rate)}else e=n.time;e=Math.max(.001,Math.min(e,5)),t.node.delay.delayTime.setValueAtTime(e,a),t.node.feedback.gain.setValueAtTime(n.feedback,a)}else if("slicer"===t.effectType){const{lfo:e,lfoGain:o,dcOffset:c}=t.node,l=parseFloat(p.value)/60*n.rate,s=n.depth;e.frequency.setValueAtTime(l,a),o.gain.setValueAtTime(s/2,a),c.offset.setValueAtTime(s/2,a)}}function Be(){se.filter(e=>e.isActive&&("slicer"===e.effectType||"delay"===e.effectType&&"bpm"===e.params.syncMode)).forEach(xe)}function we(e,t){const n=Array.from(e.querySelectorAll("button")),a=e.querySelector("button.active");let o=n.findIndex(e=>e===a);-1===o?o=0:o+=t,o>=n.length?o=0:o<0&&(o=n.length-1),n[o].click()}function Le(e,t){e.querySelector(".close-button").onclick=t,window.addEventListener("click",n=>{n.target==e&&t()})}function Ae(e,t="info",n=3e3){const a=document.createElement("div");a.className=`toast-message ${t}`,a.textContent=e,h.appendChild(a),setTimeout(()=>a.classList.add("show"),10),setTimeout(()=>{a.classList.remove("show"),a.addEventListener("transitionend",()=>a.remove())},n)}function Ce(e,t,n=null,a=null){if("undefined"!=typeof gtag){gtag("event",e,{event_category:t,event_label:n,value:a})}}function Ne(e){const t=K[e],n=t.playbackElements;n.noteDisplay.textContent=`${t.note.replace("♯","#")}${t.octave}`,n.waveDisplay.textContent=me[t.waveform]||t.waveform,n.volumeBar.style.width=100*t.volume+"%"}function Se(t){W&&De();const n=()=>{W=!0,J=t,X=0,Q=e.currentTime+.05,document.querySelectorAll(".playback-block.playing").forEach(e=>e.classList.remove("playing")),Me(),Ce("play_sequence","audio",t?"loop":"once")};"suspended"===e.state?e.resume().then(n):n()}function Me(){if(!W)return;const t=60/parseFloat(p.value)*ne;for(;Q<e.currentTime+.1;){if(X>=te){if(!J)return void De();X=0}const e=K[X],n=.1;He(X,t,Q),Ge(e,t,Q+n),Q+=t,X++}W&&(z=setTimeout(Me,25))}let qe=null,$e=[];function De(){W=!1,J=!1,z&&clearTimeout(z),z=null;const t=e.currentTime;Y.forEach(({gainNode:e})=>{try{e.gain.cancelScheduledValues(t),e.gain.setValueAtTime(e.gain.value,t),e.gain.linearRampToValueAtTime(0,t+.02)}catch(e){}}),Y=[],document.querySelectorAll(".playback-block.playing").forEach(e=>e.classList.remove("playing")),X=0,Fe()}function Fe(){qe&&clearTimeout(qe),qe=null;const t=e.currentTime;$e.forEach(({gainNode:e})=>{try{e.gain.cancelScheduledValues(t),e.gain.setValueAtTime(e.gain.value,t),e.gain.linearRampToValueAtTime(0,t+.02)}catch(e){}}),$e=[],document.querySelectorAll(".action-button.preview.playing").forEach(e=>{e.classList.remove("playing"),e.innerHTML='<i class="fa-solid fa-play"></i> 試聴'})}function Ge(t,n,a=e.currentTime){if(0===t.volume)return;const o=Ve(t.note,t.octave);if(0===o)return;const c=e.createOscillator(),l=e.createGain();c.type=t.waveform,c.frequency.setValueAtTime(o,a);const s=Math.min(.04,.3*n);l.gain.setValueAtTime(0,a),l.gain.linearRampToValueAtTime(t.volume,a+.01),a+n-s>a+.01&&l.gain.setValueAtTime(t.volume,a+n-s),l.gain.linearRampToValueAtTime(0,a+n),c.connect(l).connect(le),c.start(a),c.stop(a+n+.01);const r={oscillator:c,gainNode:l,blockId:t.id};Y.push(r),setTimeout(()=>Y=Y.filter(e=>e!==r),1e3*(n+.1))}function Ve(e,t){const n=ie[e.replace("#","♯")];if(void 0===n)return 0;const a=12*(t+1)+n;return 440*Math.pow(2,(a-69)/12)}function He(t,n,a){const o=K[t]?.playbackElements?.blockElement;if(o){const t=1e3*(a-e.currentTime);setTimeout(()=>{o.classList.add("playing"),setTimeout(()=>o.classList.remove("playing"),1e3*n)},Math.max(0,t))}}function Re(e){e.style.display="flex",setTimeout(()=>e.classList.add("active"),10)}function Oe(e){e.classList.remove("active"),setTimeout(()=>e.style.display="none",300)}function je(e){Z=e;const t=K[e];document.getElementById("modal-title").textContent=`ステップ ${e+1} 編集`,pt(document.getElementById("modal-note-buttons"),t.note),pt(document.getElementById("modal-octave-buttons"),t.octave),pt(document.getElementById("modal-waveform-buttons"),t.waveform);const n=document.getElementById("modal-volume");n.value=100*t.volume,G(n),document.getElementById("modal-volume-display").textContent=`${Math.round(100*t.volume)}%`,Re(R)}function Pe(){Oe(R),Z=null}function _e(){if(null===Z)return;const e=Z,t=e=>e.querySelector("button.active")?.dataset.value;K[e].note=t(document.getElementById("modal-note-buttons"))||K[e].note,K[e].octave=parseInt(t(document.getElementById("modal-octave-buttons")))||K[e].octave,K[e].waveform=t(document.getElementById("modal-waveform-buttons"))||K[e].waveform,K[e].volume=parseInt(document.getElementById("modal-volume").value)/100,Ne(e),Pe(),ot()}function Ke(){if(null===Z)return;const t=e=>e.querySelector("button.active")?.dataset.value,n={note:t(document.getElementById("modal-note-buttons")),octave:parseInt(t(document.getElementById("modal-octave-buttons"))),waveform:t(document.getElementById("modal-waveform-buttons")),volume:parseInt(document.getElementById("modal-volume").value)/100};var a,o;a=n,o=.5,"suspended"===e.state?e.resume().then(()=>Ge(a,o)):Ge(a,o)}function Ue(){[document.getElementById("bulk-modal-note-buttons"),document.getElementById("bulk-modal-octave-buttons"),document.getElementById("bulk-modal-waveform-buttons")].forEach(e=>e.querySelectorAll("button.active").forEach(e=>e.classList.remove("active")));const e=document.getElementById("bulk-modal-volume");e.value=50,document.getElementById("bulk-modal-volume-display").textContent="50%",e.dataset.isSetForBulk="false",e.style.opacity=.5,document.getElementById("bulk-modal-volume-display").style.opacity=.5,G(e),Re(O)}function Xe(){Oe(O)}function We(){const e=e=>e.querySelector("button.active")?.dataset.value,t={note:e(document.getElementById("bulk-modal-note-buttons")),octave:parseInt(e(document.getElementById("bulk-modal-octave-buttons"))),waveform:e(document.getElementById("bulk-modal-waveform-buttons"))};"true"===document.getElementById("bulk-modal-volume").dataset.isSetForBulk&&(t.volume=parseInt(document.getElementById("bulk-modal-volume").value)/100);for(let e=0;e<16;e++)t.note&&(K[e].note=t.note),isNaN(t.octave)||(K[e].octave=t.octave),t.waveform&&(K[e].waveform=t.waveform),void 0!==t.volume&&(K[e].volume=t.volume),Ne(e);Xe(),ot()}function Je(){Re(j)}function ze(){Oe(j)}function Qe(){K.forEach((e,t)=>{Object.assign(e,{note:"A",octave:4,waveform:"sawtooth",volume:.5}),Ne(t)}),p.value=120,ne=1,pt(m,ne),te=16,pt(u,te)}function Ye(e=!1,t=null){if(!U)return void H();const n=()=>{const n=document.getElementById("preset-name"),o=document.getElementById("preset-description"),c=document.getElementById("tag-display-container"),l=document.getElementById("preset-tags-input"),s=document.getElementById("save-preset-button"),r=P.querySelector("h3");delete P.dataset.editingId;const i=document.getElementById("overwrite-preset-button");i&&i.remove(),e?(r.textContent="名前を付けて保存",s.textContent="保存"):(r.textContent="新規プリセット作成",s.textContent="作成して保存"),n.value="",o.value="",c.innerHTML="",l.value="",s.disabled=!0,s.onclick=()=>async function(e,t=null){if(!U)return void Ae("ログインが必要です。","error");const n=document.getElementById("preset-name").value.trim();if(!n)return void Ae("プリセット名は必須です。","error");const o=document.getElementById("preset-tags-input");""!==o.value.trim()&&(be(o.value.trim()),o.value="");const c=document.getElementById("tag-display-container"),l=Array.from(c.querySelectorAll(".tag-badge span:first-child")).map(e=>e.textContent);e||Qe();const s={name:n,description:document.getElementById("preset-description").value.trim(),tags:l,...nt(),createdAt:firebase.firestore.FieldValue.serverTimestamp(),updatedAt:firebase.firestore.FieldValue.serverTimestamp()};try{const e=await a.collection("users").doc(U.uid).collection("presets").add(s);ae=e.id,Ae(`プリセット「${n}」を作成しました。`,"success"),lt(n,!0),at(),st(),Ce("create_preset","preset_management","new_preset"),t&&t()}catch(e){Ae(`プリセットの作成に失敗しました: ${e.message}`,"error"),console.error("Error creating new preset: ",e)}}(!0,t),Re(P)},o=I.textContent.includes("*");!e&&o?V("新規作成します。\n現在の編集内容は保存しますか？",()=>{ct(()=>{Qe(),lt("新規シーケンス",!1,!1),at()})},{confirmText:"保存して続行",onCancel:()=>{Qe(),lt("新規シーケンス",!1,!1),at(),n()},cancelText:"破棄して続行",onAlternative:()=>{},alternativeText:"キャンセル",isDanger:!1}):n()}function Ze(){ae=null,lt(null,!1);const e=e=>e.querySelector("button.active")?.dataset.value,t=e(document.getElementById("rg-root-note-buttons")),n=parseInt(e(document.getElementById("rg-octave-min-buttons"))),a=parseInt(e(document.getElementById("rg-octave-max-buttons"))),o=parseInt(e(document.getElementById("rg-steps-buttons")));if(!(t&&n&&a&&o))return void Ae("ランダム生成の全項目を選択してください。","error");if(n>a)return void Ae("最小オクターブは最大以下にしてください。","error");const c=fe[document.getElementById("rg-chord-type").value],l=ie[t],s=[];for(let e=n;e<=a;e++)c.intervals.forEach(t=>{const n=12*(e+1)+l+t,a=n%12,o=Math.floor(n/12)-1;let c=de.find(e=>ie[e]===a&&!e.includes("♭"))||de[a];o>=1&&o<=9&&s.push({note:c,octave:o})});if(0!==s.length){for(let e=0;e<o;e++){const t=s[Math.floor(Math.random()*s.length)];K[e].note=t.note,K[e].octave=t.octave,Ne(e)}te=o,pt(u,te),ze(),Ae("ランダム生成を実行しました。","success"),Ce("random_generate","creation_tools",c.name,o),ot()}else Ae("指定範囲で生成可能な音がありません。","error")}const et="oscbot_local_backup";async function tt(e){if(e.sequenceData.forEach((e,t)=>{K[t]&&(Object.assign(K[t],e),Ne(t))}),p.value=e.bpm,ne=e.noteDuration,pt(m,ne),te=e.sequenceMax,pt(u,te),e.fxSlots){for(let t=0;t<se.length;t++)if(e.fxSlots[t]){const n=se[t],a=e.fxSlots[t];n.isActive=a.isActive,n.effectType=a.effectType;const o=re[a.effectType]?.params||{},c=Object.fromEntries(Object.entries(o).map(([e,t])=>[e,t.value]));n.params={...c,...a.params}}await ve(),se.forEach(e=>Ee(e.id))}}function nt(){return{sequenceData:K.map(({note:e,octave:t,waveform:n,volume:a})=>({note:e,octave:t,waveform:n,volume:a})),bpm:parseInt(p.value),noteDuration:ne,sequenceMax:te,fxSlots:se.map(e=>({isActive:e.isActive,effectType:e.effectType,params:e.params}))}}function at(){localStorage.removeItem(et)}function ot(){!function(){try{const e={...nt(),timestamp:(new Date).getTime()};localStorage.setItem(et,JSON.stringify(e))}catch(e){console.error("Error saving local backup:",e)}}(),lt(ae?I.textContent:"新規シーケンス",!1,!0),U&&ae&&(ce&&clearTimeout(ce),ce=setTimeout(()=>async function(e,t=null){if(!U||!ae)return;const n=I.textContent;lt("保存中...",!1);try{const n=nt(),o=a.collection("users").doc(U.uid).collection("presets").doc(ae);await o.update({...n,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});const c=(await o.get()).data().name;lt(c,!0),e||Ae(`「${c}」を保存しました。`,"success"),at(),t&&t()}catch(e){Ae(`保存に失敗: ${e.message}`,"error"),console.error("Save error: ",e),lt(n.replace("保存中...",""),!1,!0)}}(!0),1e4))}function ct(e=null){U?ae?(ce&&clearTimeout(ce),V("現在のプリセットの保存方法を選択してください",()=>{!async function(e,t=null){if(!U||!e)return;const n={...nt(),updatedAt:firebase.firestore.FieldValue.serverTimestamp()};try{const o=a.collection("users").doc(U.uid).collection("presets").doc(e);await o.update(n);const c=(await o.get()).data().name;Ae(`「${c}」を上書き保存しました。`,"success"),lt(c,!0),at(),t&&t()}catch(e){console.error("Error overwriting preset: ",e),"not-found"===e.code?(Ae("エラー: 保存対象のプリセットが見つかりませんでした。","error"),V("元のプリセットが削除されているようです。現在の内容を新しいプリセットとして保存しますか？",()=>{Ye(!0)},{confirmText:"新規保存",cancelText:"キャンセル"}),ae=null,lt("新規シーケンス",!1,!0)):Ae(`上書き保存に失敗しました: ${e.message}`,"error")}}(ae,e)},{onAlternative:()=>{Ye(!0)},confirmText:"上書き保存",alternativeText:"別名で保存",cancelText:"キャンセル"})):Ye(!0,e):Ye(!0)}function lt(e,t,n=!1){const a=document.getElementById("manual-save-button"),o=document.getElementById("footer-save-button");let c=e||"新規シーケンス";const l=c.replace(/\s\*$/,"").replace(/^[\u2713\s]*/,"").replace(/^保存中.../,"");if(null!==e){if(!U&&!n)return T.style.display="none",void(o.disabled=!0);t?(c=`✓ ${l}`,a.textContent="保存済み",a.disabled=!0,o.disabled=!0):"保存中..."===e?(c="保存中...",a.textContent="保存中...",a.disabled=!0,o.disabled=!0):n?(c=`${l} *`,a.textContent="保存",a.disabled=!1,o.disabled=!1):(c=l,a.textContent="保存",a.disabled=!0,o.disabled=!0),I.textContent=c,T.style.display="flex",I.classList.toggle("editable",!!ae&&!!U)}else T.style.display="none"}function st(){const e=document.getElementById("overwrite-preset-button");e&&e.remove(),Oe(P)}async function rt(e=!0){if(!U)return void Ae("ログインが必要です。","error");const t=document.getElementById("preset-name").value.trim();if(!t)return void Ae("プリセット名は必須です。","error");const n=document.getElementById("preset-tags-input");""!==n.value.trim()&&(be(n.value.trim()),n.value="");const o=P.dataset.editingId,c=document.getElementById("tag-display-container"),l=Array.from(c.querySelectorAll(".tag-badge span:first-child")).map(e=>e.textContent),s={name:t,description:document.getElementById("preset-description").value.trim(),tags:l,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};try{const t=a.collection("users").doc(U.uid).collection("presets");if(e&&o)await t.doc(o).update({name:s.name,description:s.description,tags:s.tags}),Ae("プリセット情報を更新しました。","success"),o===ae&&lt(s.name,!0),ut();else{const e={...nt(),...s,createdAt:firebase.firestore.FieldValue.serverTimestamp()},n=await t.add(e);ae=n.id,Ae(`「${s.name}」を保存しました。`,"success"),lt(s.name,!0),at()}st()}catch(e){Ae(`保存に失敗しました: ${e.message}`,"error"),console.error("Error saving preset: ",e)}}function it(){U?(ut(),Re(_)):H()}function dt(){Oe(_)}async function ut(){if(!U)return;const t=document.getElementById("preset-list"),n=document.getElementById("no-results-message"),o=document.getElementById("search-box").value.toLowerCase();t.innerHTML='<div class="loading-spinner"></div>';try{const c=await a.collection("users").doc(U.uid).collection("presets").orderBy("updatedAt","desc").get(),l=c.docs.map(e=>({id:e.id,...e.data()})).filter(e=>e.name.toLowerCase().includes(o)||e.description&&e.description.toLowerCase().includes(o)||e.tags&&e.tags.some(e=>e.toLowerCase().includes(o)));t.innerHTML="",l.length>0?(t.className="preset-grid",l.forEach(n=>{const o=document.createElement("div");o.className="preset-card-item";const c=document.createElement("div");c.className="preset-card-content";const l=document.createElement("h3");l.textContent=n.name;const s=document.createElement("p");s.textContent=n.description||"説明なし";const r=document.createElement("span");r.className="preset-timestamp",n.updatedAt&&n.updatedAt.toDate&&(r.textContent=`最終更新: ${n.updatedAt.toDate().toLocaleString()}`);const i=document.createElement("div");i.className="tags",n.tags&&n.tags.length>0&&(i.innerHTML=n.tags.map(e=>`<span class="tag">${e}</span>`).join(""));const d=document.createElement("div");d.className="actions";const u=document.createElement("button");u.className="action-button preview",u.innerHTML='<i class="fa-solid fa-play"></i> 試聴';const m=document.createElement("button");m.className="action-button edit",m.innerHTML='<i class="fa-solid fa-pen-to-square"></i>',m.title="名前やタグを編集";const p=document.createElement("button");p.className="action-button delete",p.innerHTML='<i class="fa-solid fa-trash"></i>',p.title="削除";const f=document.createElement("button");f.className="action-button load",f.textContent="読込",d.append(u,m,p,f),c.append(l,s,r,i,d),o.append(c),u.onclick=t=>{t.stopPropagation(),function(t){"suspended"===e.state&&e.resume();const n=$e.length>0;if(Fe(),n)return;const a=event.target.closest(".action-button.preview");a&&(a.classList.add("playing"),a.innerHTML='<i class="fa-solid fa-stop"></i> 停止');let o=0,c=e.currentTime+.05;const l=t.sequenceData||[],s=t.sequenceMax||16,r=t.noteDuration||1,i=t.bpm||120,d=()=>{const t=60/i*r;for(;c<e.currentTime+.1;){if(o>=s)return void Fe();const n=l[o];if(n&&n.volume>0){const a=Ve(n.note,n.octave);if(a>0){const o=e.createOscillator(),l=e.createGain();o.type=n.waveform,o.frequency.setValueAtTime(a,c);const s=.01,r=Math.min(.04,.3*t);l.gain.setValueAtTime(0,c),l.gain.linearRampToValueAtTime(n.volume,c+s),c+t-r>c+s&&l.gain.setValueAtTime(n.volume,c+t-r),l.gain.linearRampToValueAtTime(0,c+t),o.connect(l).connect(le),o.start(c),o.stop(c+t+.01);const i={oscillator:o,gainNode:l};$e.push(i),setTimeout(()=>{$e=$e.filter(e=>e!==i)},1e3*(t+.1))}}c+=t,o++}qe=o<s&&$e.length>0?setTimeout(d,25):setTimeout(Fe,1e3*t)};d()}(n)},f.onclick=e=>{e.stopPropagation(),async function(e){if(!U)return;Fe();try{const t=a.collection("users").doc(U.uid).collection("presets").doc(e),n=await t.get();if(!n.exists)return void Ae("プリセットが見つかりません。","error");const o=n.data();await tt(o),ae=e,lt(o.name,!0),at(),Ae(`「${o.name}」を読み込みました。`,"success"),dt()}catch(e){Ae(`プリセットの読み込みに失敗しました: ${e.message}`,"error"),console.error("Error loading preset:",e)}}(n.id)},m.onclick=e=>{e.stopPropagation(),mt(n.id)},p.onclick=e=>{e.stopPropagation(),async function(e,t){if(!U)return;V(`本当にプリセット「${t}」を削除しますか？この操作は取り消せません。`,async()=>{try{await a.collection("users").doc(U.uid).collection("presets").doc(e).delete(),Ae("プリセットを削除しました。","success"),ae===e&&(ae=null,lt(null)),ut()}catch(e){Ae(`プリセットの削除に失敗しました: ${e.message}`,"error"),console.error("Error deleting preset:",e)}},{isDanger:!0})}(n.id,n.name)},t.appendChild(o)}),n.style.display="none"):(t.className="preset-list",n.style.display="block")}catch(e){t.innerHTML="プリセットの読み込みに失敗しました。",Ae("プリセットの読み込みに失敗しました。","error"),console.error("Error populating presets: ",e)}}async function mt(e){if(U)try{const t=a.collection("users").doc(U.uid).collection("presets").doc(e),n=await t.get();if(!n.exists)return void Ae("編集対象のプリセットが見つかりません。","error");const o=n.data();P.querySelector("h3").textContent="プリセット情報の編集";const c=document.getElementById("preset-name");c.value=o.name,document.getElementById("preset-description").value=o.description||"";const l=document.getElementById("tag-display-container");l.innerHTML="",o.tags&&o.tags.forEach(e=>{const t=document.createElement("div");t.className="tag-badge",t.innerHTML=`<span>${e}</span><span class="remove-tag">×</span>`,l.appendChild(t)});const s=document.getElementById("save-preset-button");s.textContent="変更を保存",s.onclick=()=>rt(!0),s.disabled=""===c.value.trim(),P.dataset.editingId=e;const r=document.getElementById("overwrite-preset-button");r&&r.remove(),dt(),Re(P)}catch(e){Ae("プリセット情報の取得に失敗しました。","error")}}function pt(e,t){e.querySelectorAll("button").forEach(e=>{e.classList.toggle("active",e.dataset.value==t)})}function ft(e,t,n,a=e=>e){e.innerHTML="",t.forEach(t=>{const n=document.createElement("button");n.type="button",n.dataset.value=t,n.textContent=a(t),n.onclick=()=>{e.querySelectorAll("button").forEach(e=>e.classList.remove("active")),n.classList.add("active")},e.appendChild(n)})}function vt(e,t,n,a,o="value",c="label"){e.innerHTML="",t.forEach(t=>{const l="object"==typeof t?t[o]:t,s="object"==typeof t?t[c]:t,r=document.createElement("button");r.type="button",r.dataset.value=l,r.textContent=s,l==a&&r.classList.add("active"),r.onclick=()=>{e.querySelectorAll("button").forEach(e=>e.classList.remove("active")),r.classList.add("active"),n(l)},e.appendChild(r)})}function yt(e){let t=parseInt(p.value);t=Math.max(20,Math.min(300,t+e)),p.value=t}!async function(){await async function(){let t=le;for(const n of se)n.bypassNode=e.createGain(),t.connect(n.bypassNode),t=n.bypassNode;t.connect(e.destination)}(),await ve(),function(){d.innerHTML="",K=[];for(let e=0;e<16;e++){const t=document.createElement("div");t.className="playback-block",t.dataset.id=e,t.draggable=!0,t.onclick=()=>je(e);const n=document.createElement("span");n.className="step-number-pb",n.textContent=e+1;const a=document.createElement("div");a.className="pb-note";const o=document.createElement("div");o.className="pb-wave";const c=document.createElement("div");c.className="pb-volume-container";const l=document.createElement("div");l.className="pb-volume-bar",c.appendChild(l),t.append(n,a,o,c),d.appendChild(t),K.push({id:e,note:"A",octave:4,waveform:"sawtooth",volume:.5,playbackElements:{blockElement:t,noteDisplay:a,waveDisplay:o,volumeBar:l}}),Ne(e)}}(),function(){const e=Object.keys(me);ft(document.getElementById("modal-note-buttons"),de,"note",e=>e.replace("♯","#")),ft(document.getElementById("modal-octave-buttons"),ue,"octave"),ft(document.getElementById("modal-waveform-buttons"),e,"waveform",e=>me[e]),ft(document.getElementById("bulk-modal-note-buttons"),de,"note",e=>e.replace("♯","#")),ft(document.getElementById("bulk-modal-octave-buttons"),ue,"octave"),ft(document.getElementById("bulk-modal-waveform-buttons"),e,"waveform",e=>me[e]),vt(u,Array.from({length:16},(e,t)=>t+1),e=>{te=parseInt(e),ot()},te),vt(m,pe,e=>{ne=parseFloat(e),ot()},ne,"value","label"),function(){ft(document.getElementById("rg-root-note-buttons"),de,"rg-root-note"),ft(document.getElementById("rg-octave-min-buttons"),ue,"rg-octave-min"),ft(document.getElementById("rg-octave-max-buttons"),ue,"rg-octave-max"),ft(document.getElementById("rg-steps-buttons"),Array.from({length:16},(e,t)=>t+1),"rg-steps");document.getElementById("rg-chord-type").innerHTML=Object.keys(fe).map(e=>`<option value="${e}">${fe[e].name}</option>`).join("")}(),w.innerHTML="",se.forEach(e=>{const t=document.createElement("button");t.className="fx-slot-button",t.dataset.fxId=e.id,t.innerHTML=`<span class="fx-slot-name">${e.name}</span><span class="fx-type-name"></span>`;let n=null;const a=t=>{t.preventDefault(),n=setTimeout(()=>{var t;t=e.id,oe=se.find(e=>e.id===t),oe&&(A.textContent=`${oe.name} 設定`,C.innerHTML=Object.keys(re).map(e=>`<option value="${e}">${re[e].name}</option>`).join(""),C.value=oe.effectType,Ie(),Re(L)),n=null},500)},o=()=>{n&&clearTimeout(n),n=null},c=()=>{null!==n&&function(e){const t=se.find(t=>t.id===e);t&&(t.isActive=!t.isActive,Ee(e),ye(t),ot())}(e.id),o()};t.addEventListener("mousedown",a),t.addEventListener("touchstart",a,{passive:!1}),t.addEventListener("mouseup",c),t.addEventListener("mouseleave",o),t.addEventListener("touchend",c),w.appendChild(t),Ee(e.id)})}(),function(){c.addEventListener("click",signInWithGoogleAuth),l.addEventListener("click",()=>o.signOut()),v.onclick=()=>Se(!1),y.onclick=()=>Se(!0),g.onclick=De,b.onclick=Ue,E.onclick=Je,i.onclick=it,B.onclick=()=>Ye(!1),k.onclick=()=>ct(),x.onclick=()=>ct(),I.addEventListener("click",()=>{ae&&U&&mt(ae)}),f.forEach(e=>e.addEventListener("click",()=>{yt(parseInt(e.dataset.step)),Be(),ot()})),p.addEventListener("change",()=>{p.value=Math.max(20,Math.min(300,parseInt(p.value)||120)),Be(),ot()}),d.addEventListener("dragstart",e=>{e.target.classList.contains("playback-block")&&(ee=e.target,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",e.target.innerHTML),e.target.classList.add("dragging"))}),d.addEventListener("dragover",e=>{e.preventDefault();const t=e.target.closest(".playback-block");t&&t!==ee&&t.classList.add("drag-over")}),d.addEventListener("dragleave",e=>{const t=e.target.closest(".playback-block");t&&t.classList.remove("drag-over")}),d.addEventListener("dragend",e=>e.target.classList.remove("dragging")),d.addEventListener("drop",e=>{e.preventDefault();const t=e.target.closest(".playback-block");if(!t||!ee||t===ee)return void(t&&t.classList.remove("drag-over"));t.classList.remove("drag-over");const n=parseInt(ee.dataset.id),a=parseInt(t.dataset.id);V(`ステップ${n+1}のデータをステップ${a+1}と入れ替えますか？`,()=>{!function(e,t){const n={...K[e]},a={...K[t]};["note","octave","waveform","volume"].forEach(o=>{K[e][o]=a[o],K[t][o]=n[o]}),Ne(e),Ne(t),ot()}(n,a)},{confirmText:"入れ替え",cancelText:"キャンセル",onAlternative:()=>{!function(e,t){const n={...K[e]};["note","octave","waveform","volume"].forEach(e=>{K[t][e]=n[e]}),Ne(t),ot()}(n,a)},alternativeText:"上書き"}),ee=null}),Le(R,Pe),Le(O,Xe),Le(j,ze),Le(P,st),Le(L,he),S.onclick=ke,C.onchange=Te,document.getElementById("modal-volume").oninput=e=>{document.getElementById("modal-volume-display").textContent=`${e.target.value}%`,G(e.target)},document.getElementById("modal-complete-button").onclick=_e,document.getElementById("modal-play-test-button").onclick=Ke;const e=document.getElementById("bulk-modal-volume"),t=document.getElementById("bulk-modal-volume-display");e.oninput=()=>{t.textContent=`${e.value}%`,e.dataset.isSetForBulk="true",e.style.opacity=1,t.style.opacity=1,G(e)},document.getElementById("bulk-modal-apply-button").onclick=We,document.getElementById("bulk-clear-volume-button").onclick=()=>{e.value=50,t.textContent="50%",e.dataset.isSetForBulk="false",e.style.opacity=.5,t.style.opacity=.5,G(e)},document.getElementById("rg-execute-button").onclick=Ze,document.getElementById("save-preset-button").onclick=rt,document.getElementById("search-box").addEventListener("input",ut),function(){const e=document.getElementById("preset-name"),t=document.getElementById("save-preset-button"),n=document.getElementById("preset-tags-input"),a=document.getElementById("tag-display-container");e.addEventListener("input",()=>{t.disabled=""===e.value.trim()}),n.addEventListener("keydown",e=>{"Enter"===e.key&&""!==n.value.trim()&&(e.preventDefault(),be(n.value.trim()),n.value="")}),a.addEventListener("click",e=>{e.target.classList.contains("remove-tag")&&e.target.parentElement.remove()})}(),window.addEventListener("keydown",e=>{const t=document.activeElement;if(["INPUT","TEXTAREA","SELECT"].includes(t.tagName)&&"range"===!t.type)return;const n=document.querySelector(".modal.active");if(!n||"Escape"===e.key)switch(e.key){case" ":W?g.click():y.click(),e.preventDefault();break;case"Enter":v.click(),e.preventDefault();break;case"ArrowUp":yt(e.shiftKey?10:1),e.preventDefault();break;case"ArrowDown":yt(e.shiftKey?-10:-1),e.preventDefault();break;case"ArrowRight":we(e.shiftKey?u:m,1),e.preventDefault();break;case"ArrowLeft":we(e.shiftKey?u:m,-1),e.preventDefault();break;case"Escape":n?n.querySelector(".close-button").click():W&&g.click(),e.preventDefault();break;case"r":case"R":E.click();break;case"b":case"B":b.click();break;case"l":case"L":i.click()}})}(),o.getRedirectResult().then(e=>{e.user&&Ae("ログインに成功しました","success")}).catch(e=>{console.error("Redirect result error:",e),"auth/popup-closed-by-user"!==e.code&&Ae(`ログインに失敗しました: ${e.message}`,"error")}),o.onAuthStateChanged(t=>{if(t){const n=a.collection("users").doc(t.uid);n.get().then(e=>{const a={displayName:t.displayName,email:t.email,photoURL:t.photoURL,lastLoginAt:firebase.firestore.FieldValue.serverTimestamp()};return e.exists||(a.createdAt=firebase.firestore.FieldValue.serverTimestamp()),n.set(a,{merge:!0})}).catch(e=>{console.error("Error checking/creating user in Firestore:",e),Ae("ユーザー情報の確認に失敗しました。","error")}),U=t,function(e){const t=e.displayName||"ユーザー";if(r.textContent=`${t}さん`,e.photoURL){const t=document.createElement("img");t.src=e.photoURL;const n=r.querySelector("img");n&&n.remove(),r.insertBefore(t,r.firstChild)}}(t),"suspended"===e.state&&e.resume().catch(console.error)}else U=null,s.style.display="none",c.style.display="block",i.disabled=!0,B.disabled=!0,x.disabled=!0,k.disabled=!0,lt(null)}),function(){try{const e=localStorage.getItem(et);if(!e)return void lt("新規シーケンス");const t=JSON.parse(e);V(`未保存の作業データが見つかりました。（最終更新: ${new Date(t.timestamp).toLocaleString()}）復元しますか？`,()=>{tt(t),ot(),Ae("作業を復元しました。","info")},{onCancel:()=>{at(),Ae("バックアップを破棄しました。","info"),lt("新規シーケンス",!1,!1)},confirmText:"復元する",cancelText:"破棄する"})}catch(e){console.error("Error loading local backup:",e),at()}}(),document.querySelectorAll('input[type="range"]').forEach(G)}()});