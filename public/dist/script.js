document.addEventListener("DOMContentLoaded",async()=>{const e=new(window.AudioContext||window.webkitAudioContext);if(!e)return void alert("Web Audio API not supported.");const t=()=>{"suspended"===e.state&&e.resume().catch(console.error)};document.addEventListener("click",t,{once:!0}),document.addEventListener("touchstart",t,{once:!0}),document.addEventListener("keydown",t,{once:!0});let n=null,a=null,o=null;try{const e=await fetch("/api/firebase-config");if(e.ok){const t=await e.json();t&&t.apiKey?(n=t,firebase.initializeApp(n),a=firebase.firestore(),o=firebase.auth()):console.warn("Firebase config is incomplete. Firebase features will be disabled.")}else console.warn("Failed to load Firebase config. Firebase features will be disabled.")}catch(e){console.error("Error during Firebase initialization:",e)}const l=document.getElementById("login-button"),c=document.getElementById("logout-button"),s=document.getElementById("user-info"),r=document.getElementById("user-name"),i=document.getElementById("load-data-button"),d=document.getElementById("playback-grid"),u=document.getElementById("sequence-max-buttons"),m=document.getElementById("note-duration-buttons"),p=document.getElementById("bpm"),f=document.querySelectorAll(".bpm-adjust"),y=document.getElementById("play-once-button"),v=document.getElementById("play-loop-button"),g=document.getElementById("stop-button"),b=document.getElementById("bulk-edit-button"),E=document.getElementById("random-generate-trigger-button"),h=document.getElementById("toast-container"),T=document.getElementById("preset-status-container"),I=document.getElementById("current-preset-status"),k=document.getElementById("manual-save-button"),x=document.getElementById("footer-save-button"),B=document.getElementById("new-preset-button"),w=document.getElementById("fx-slots-container"),L=document.getElementById("fx-edit-modal"),A=document.getElementById("fx-modal-title"),C=document.getElementById("fx-type-select"),N=document.getElementById("fx-params-container"),S=document.getElementById("fx-modal-complete-button"),M=document.getElementById("confirmation-modal"),q=document.getElementById("confirmation-modal-message"),$=document.getElementById("confirmation-modal-confirm-button"),D=document.getElementById("confirmation-modal-cancel-button"),F=document.getElementById("confirmation-modal-alternative-button");function V(e){if(!e)return;const t=e.min?parseFloat(e.min):0,n=e.max?parseFloat(e.max):100,a=(parseFloat(e.value)-t)/(n-t)*100;e.style.setProperty("--fill-percent",`${a}%`)}function G(e,t,n={}){q.innerHTML=e.replace(/\n/g,"<br>"),$.onclick=()=>{t&&t(),je(M)},D.onclick=()=>{n.onCancel&&n.onCancel(),je(M)},n.onAlternative?(F.style.display="inline-block",F.textContent=n.alternativeText||"選択肢",F.onclick=()=>{n.onAlternative&&n.onAlternative(),je(M)}):F.style.display="none",$.textContent=n.confirmText||"OK",D.textContent=n.cancelText||"キャンセル",$.classList.toggle("danger",!!n.isDanger),Re(M)}function H(){o?G("この機能を利用するにはTwitterアカウントでのログインが必要です。",()=>{O()},{confirmText:"Twitterでログイン",cancelText:"キャンセル"}):G("現在、ログイン機能は利用できません。Firebaseの設定を確認してください。",()=>{},{confirmText:"OK",cancelText:"閉じる"})}async function O(){if(!o)return void Ce("ログイン機能は現在利用できません。","error");const e=new firebase.auth.TwitterAuthProvider;try{await o.signInWithRedirect(e)}catch(e){console.error("Firebase Twitter Auth Error:",e),Ce(`ログインに失敗しました: ${e.message}`,"error")}}Ae(M,()=>je(M));const R=document.getElementById("edit-modal"),j=document.getElementById("bulk-edit-modal"),K=document.getElementById("random-generate-modal"),P=document.getElementById("save-preset-modal"),_=document.getElementById("load-preset-modal");let U=[],X=null,z=0,J=!1,W=!1,Q=null,Y=0,Z=[],ee=null,te=null,ne=16,ae=1,oe=null,le=null,ce=null;const se=e.createGain();let re=[{id:"B",name:"FX B",node:null,bypassNode:null,isActive:!1,effectType:"delay",params:{mix:.5,time:.25,feedback:.4,syncMode:"bpm",rate:4}},{id:"C",name:"FX C",node:null,bypassNode:null,isActive:!1,effectType:"reverb",params:{mix:.5}},{id:"D",name:"FX D",node:null,bypassNode:null,isActive:!1,effectType:"none",params:{}}];const ie={none:{name:"エフェクトなし",params:{}},reverb:{name:"リバーブ",params:{mix:{label:"Mix",type:"range",min:0,max:1,step:.01,value:.5}},createNode:async e=>{const t=e.createConvolver(),n=e.createGain(),a=e.createGain(),o=e.sampleRate,l=2*o,c=e.createBuffer(2,l,o),s=c.getChannelData(0),r=c.getChannelData(1);for(let e=0;e<l;e++)s[e]=(2*Math.random()-1)*Math.pow(1-e/l,2.5),r[e]=(2*Math.random()-1)*Math.pow(1-e/l,2.5);return t.buffer=c,{convolver:t,wetGain:n,dryGain:a}}},delay:{name:"ディレイ",params:{mix:{label:"Mix",type:"range",min:0,max:1,step:.01,value:.5},feedback:{label:"Feedback",type:"range",min:0,max:.9,step:.01,value:.4},time:{label:"Time",type:"range",min:.01,max:2,step:.01,value:.25},rate:{label:"Rate",type:"buttons",value:4,options:[{value:.5,label:"2分"},{value:.75,label:"2分3連符"},{value:1,label:"4分"},{value:1/1.5,label:"付点4分"},{value:1.5,label:"4分3連符"},{value:2,label:"8分"},{value:2/1.5,label:"付点8分"},{value:3,label:"8分3連符"},{value:4,label:"16分"}]}},createNode:e=>({delay:e.createDelay(5),feedback:e.createGain(),wetGain:e.createGain(),dryGain:e.createGain()})},slicer:{name:"スライサー",params:{depth:{label:"Depth",type:"range",min:0,max:1,step:.01,value:1},rate:{label:"Rate",type:"buttons",value:4,options:[{value:1,label:"4分"},{value:1.5,label:"4分3連符"},{value:2,label:"8分"},{value:2/1.5,label:"付点8分"},{value:3,label:"8分3連符"},{value:4,label:"16分"},{value:4/1.5,label:"付点16分"},{value:6,label:"16分3連符"},{value:8,label:"32分"}]}},createNode:e=>{const t=e.createGain(),n=e.createOscillator(),a=e.createGain(),o=e.createConstantSource();return n.type="square",t.gain.value=0,n.connect(a),a.connect(t.gain),o.connect(t.gain),n.start(),o.start(),{slicerGain:t,lfo:n,lfoGain:a,dcOffset:o}}}},de={C:0,"C♯":1,"D♭":1,D:2,"D♯":3,"E♭":3,E:4,F:5,"F♯":6,"G♭":6,G:7,"G♯":8,"A♭":8,A:9,"A♯":10,"B♭":10,B:11},ue=["C","C♯","D","D♯","E","F","F♯","G","G♯","A","A♯","B"],me=[1,2,3,4,5,6,7,8,9],pe={sine:"正弦波",square:"矩形波",sawtooth:"ノコギリ波",triangle:"三角波"},fe=[{value:.25,label:"16分"},{value:1/3,label:"1拍3連"},{value:.5,label:"8分"},{value:2/3,label:"2拍3連"},{value:1,label:"4分"},{value:2,label:"2分"},{value:4,label:"全音符"}],ye={major:{name:"メジャー",intervals:[0,4,7]},minor:{name:"マイナー",intervals:[0,3,7]},dominant7th:{name:"ドミナント7th",intervals:[0,4,7,10]},major7th:{name:"メジャー7th",intervals:[0,4,7,11]},minor7th:{name:"マイナー7th",intervals:[0,3,7,10]},diminished:{name:"ディミニッシュ",intervals:[0,3,6]},augmented:{name:"オーギュメント",intervals:[0,4,8]},sus4:{name:"サスフォー",intervals:[0,5,7]},majorPentatonic:{name:"メジャーペンタ",intervals:[0,2,4,7,9]},minorPentatonic:{name:"マイナーペンタ",intervals:[0,3,5,7,10]}};async function ve(){for(const t of re)"none"!==t.effectType&&ie[t.effectType].createNode?(t.node=await ie[t.effectType].createNode(e),t.node.type=t.effectType,Be(t)):t.node=null;be()}function ge(e){const t=0===re.indexOf(e)?se:re[re.indexOf(e)-1].bypassNode;if(t.disconnect(),e.isActive&&"none"!==e.effectType&&e.node){if("reverb"===e.effectType){const{convolver:n,wetGain:a,dryGain:o}=e.node;t.connect(o).connect(e.bypassNode),t.connect(n).connect(a).connect(e.bypassNode)}else if("delay"===e.effectType){const{delay:n,feedback:a,wetGain:o,dryGain:l}=e.node;t.connect(l).connect(e.bypassNode),t.connect(n),n.connect(o).connect(e.bypassNode),n.connect(a).connect(n)}else if("slicer"===e.effectType){const{slicerGain:n}=e.node;t.connect(n).connect(e.bypassNode)}}else t.connect(e.bypassNode)}function be(){re.forEach(ge)}function Ee(e){const t=document.getElementById("tag-display-container"),n=Array.from(t.querySelectorAll(".tag-badge span:first-child")).map(e=>e.textContent);if(n.includes(e)||n.length>=10)return;const a=document.createElement("div");a.className="tag-badge",a.innerHTML=`<span>${e}</span><span class="remove-tag">×</span>`,t.appendChild(a)}function he(e){const t=re.find(t=>t.id===e),n=w.querySelector(`[data-fx-id="${e}"]`);t&&n&&(n.classList.toggle("active",t.isActive),n.querySelector(".fx-type-name").textContent=ie[t.effectType].name)}function Te(){je(L),le=null}async function Ie(){const t=C.value,n=le;if(!n||n.effectType===t)return;n.effectType=t;const a=ie[t].params;n.params={};for(const e in a)n.params[e]=a[e].value;ie[t].createNode?(n.node=await ie[t].createNode(e),n.node.type=t):n.node=null,ke()}function ke(){const e=le;if(N.innerHTML="",!e||"none"===e.effectType)return;const t=ie[e.effectType].params;if("delay"===e.effectType){const n=e.params,a=(e,t)=>{const a=n[e]??t.value,o=document.createElement("div");o.className="fx-param-control",o.innerHTML=`\n                    <label>${t.label}</label>\n                    <div class="slider-wrapper">\n                        <input type="range" min="${t.min}" max="${t.max}" step="${t.step}" value="${a}" data-param-key="${e}">\n                        <span>${a}</span>\n                    </div>\n                `;const l=o.querySelector("input"),c=o.querySelector("span");return l.oninput=()=>{c.textContent=l.value,V(l)},V(l),o};N.appendChild(a("mix",t.mix)),N.appendChild(a("feedback",t.feedback));const o=document.createElement("div");o.className="fx-param-control toggle-switch-container",o.innerHTML='\n                <span class="toggle-label">Time (秒数で指定)</span>\n                <label class="toggle-switch">\n                    <input type="checkbox" data-param-key="syncMode">\n                    <span class="toggle-slider"></span>\n                </label>\n            ';const l=o.querySelector("input");N.appendChild(o);const c=document.createElement("div");c.dataset.syncControl="time",c.appendChild(a("time",t.time)),N.appendChild(c);const s=document.createElement("div");s.dataset.syncControl="bpm";const r=t.rate,i=n.rate??r.value,d=document.createElement("div");d.className="fx-param-control",d.innerHTML=`<label>${r.label}</label>`;const u=document.createElement("div");u.className="button-selector-group fx-param-buttons",u.dataset.paramKey="rate",r.options.forEach(e=>{const t=document.createElement("button");t.type="button",t.dataset.value=e.value,t.textContent=e.label,e.value==i&&t.classList.add("active"),t.onclick=()=>{u.querySelectorAll("button").forEach(e=>e.classList.remove("active")),t.classList.add("active")},u.appendChild(t)}),d.appendChild(u),s.appendChild(d),N.appendChild(s);const m=()=>{const e=l.checked;c.style.display=e?"":"none",s.style.display=e?"none":""};l.onchange=m,l.checked="time"===n.syncMode,m()}else for(const n in t){const a=t[n],o=e.params[n]??a.value,l=document.createElement("div");l.className="fx-param-control";const c=document.createElement("label");if(c.textContent=a.label,l.appendChild(c),"range"===a.type){const e=document.createElement("div");e.className="slider-wrapper",e.innerHTML=`\n                        <input type="range" min="${a.min}" max="${a.max}" step="${a.step}" value="${o}" data-param-key="${n}">\n                        <span>${o}</span>`;const t=e.querySelector('input[type="range"]'),c=e.querySelector("span");t.oninput=()=>{c.textContent=t.value,V(t)},l.appendChild(e),V(t)}else if("buttons"===a.type){const e=document.createElement("div");e.className="button-selector-group fx-param-buttons",e.dataset.paramKey=n,a.options.forEach(t=>{const n=document.createElement("button");n.type="button",n.dataset.value=t.value,n.textContent=t.label,t.value==o&&n.classList.add("active"),n.onclick=()=>{e.querySelectorAll("button").forEach(e=>e.classList.remove("active")),n.classList.add("active")},e.appendChild(n)}),l.appendChild(e)}N.appendChild(l)}}async function xe(){const t=le;if(t){if("delay"===t.effectType){const e=N.querySelector('input[data-param-key="syncMode"]');if(t.params.syncMode=e.checked?"time":"bpm",t.params.mix=parseFloat(N.querySelector('input[data-param-key="mix"]').value),t.params.feedback=parseFloat(N.querySelector('input[data-param-key="feedback"]').value),"time"===t.params.syncMode)t.params.time=parseFloat(N.querySelector('input[data-param-key="time"]').value);else{const e=N.querySelector('.button-selector-group[data-param-key="rate"]').querySelector("button.active");e&&(t.params.rate=parseFloat(e.dataset.value))}}else N.querySelectorAll('input[type="range"]').forEach(e=>{t.params[e.dataset.paramKey]=parseFloat(e.value)}),N.querySelectorAll(".button-selector-group").forEach(e=>{const n=e.dataset.paramKey,a=e.querySelector("button.active");a&&(t.params[n]=parseFloat(a.dataset.value))});t.node&&t.node.type===t.effectType||(ie[t.effectType].createNode?(t.node=await ie[t.effectType].createNode(e),t.node.type=t.effectType):t.node=null),Be(t),be(),he(t.id),Te(),lt()}}function Be(t){if(!t.node||"none"===t.effectType)return;const n=t.params,a=e.currentTime;if("reverb"===t.effectType)t.node.wetGain.gain.setValueAtTime(n.mix,a),t.node.dryGain.gain.setValueAtTime(1-n.mix,a);else if("delay"===t.effectType){let e;if(t.node.wetGain.gain.setValueAtTime(n.mix,a),t.node.dryGain.gain.setValueAtTime(1-n.mix,a),"bpm"===n.syncMode){e=60/(parseFloat(p.value)*n.rate)}else e=n.time;e=Math.max(.001,Math.min(e,5)),t.node.delay.delayTime.setValueAtTime(e,a),t.node.feedback.gain.setValueAtTime(n.feedback,a)}else if("slicer"===t.effectType){const{lfo:e,lfoGain:o,dcOffset:l}=t.node,c=parseFloat(p.value)/60*n.rate,s=n.depth;e.frequency.setValueAtTime(c,a),o.gain.setValueAtTime(s/2,a),l.offset.setValueAtTime(s/2,a)}}function we(){re.filter(e=>e.isActive&&("slicer"===e.effectType||"delay"===e.effectType&&"bpm"===e.params.syncMode)).forEach(Be)}function Le(e,t){const n=Array.from(e.querySelectorAll("button")),a=e.querySelector("button.active");let o=n.findIndex(e=>e===a);-1===o?o=0:o+=t,o>=n.length?o=0:o<0&&(o=n.length-1),n[o].click()}function Ae(e,t){e.querySelector(".close-button").onclick=t,window.addEventListener("click",n=>{n.target==e&&t()})}function Ce(e,t="info",n=3e3){const a=document.createElement("div");a.className=`toast-message ${t}`,a.textContent=e,h.appendChild(a),setTimeout(()=>a.classList.add("show"),10),setTimeout(()=>{a.classList.remove("show"),a.addEventListener("transitionend",()=>a.remove())},n)}function Ne(e,t,n=null,a=null){if("undefined"!=typeof gtag){gtag("event",e,{event_category:t,event_label:n,value:a})}}function Se(e){const t=U[e],n=t.playbackElements;n.noteDisplay.textContent=`${t.note.replace("♯","#")}${t.octave}`,n.waveDisplay.textContent=pe[t.waveform]||t.waveform,n.volumeBar.style.width=100*t.volume+"%"}function Me(t){J&&Fe();const n=()=>{J=!0,W=t,z=0,Y=e.currentTime+.05,document.querySelectorAll(".playback-block.playing").forEach(e=>e.classList.remove("playing")),qe(),Ne("play_sequence","audio",t?"loop":"once")};"suspended"===e.state?e.resume().then(n):n()}function qe(){if(!J)return;const t=60/parseFloat(p.value)*ae;for(;Y<e.currentTime+.1;){if(z>=ne){if(!W)return void Fe();z=0}const e=U[z],n=.1;Oe(z,t,Y),Ge(e,t,Y+n),Y+=t,z++}J&&(Q=setTimeout(qe,25))}let $e=null,De=[];function Fe(){J=!1,W=!1,Q&&clearTimeout(Q),Q=null;const t=e.currentTime;Z.forEach(({gainNode:e})=>{try{e.gain.cancelScheduledValues(t),e.gain.setValueAtTime(e.gain.value,t),e.gain.linearRampToValueAtTime(0,t+.02)}catch(e){}}),Z=[],document.querySelectorAll(".playback-block.playing").forEach(e=>e.classList.remove("playing")),z=0,Ve()}function Ve(){$e&&clearTimeout($e),$e=null;const t=e.currentTime;De.forEach(({gainNode:e})=>{try{e.gain.cancelScheduledValues(t),e.gain.setValueAtTime(e.gain.value,t),e.gain.linearRampToValueAtTime(0,t+.02)}catch(e){}}),De=[],document.querySelectorAll(".action-button.preview.playing").forEach(e=>{e.classList.remove("playing"),e.innerHTML='<i class="fa-solid fa-play"></i> 試聴'})}function Ge(t,n,a=e.currentTime){if(0===t.volume)return;const o=He(t.note,t.octave);if(0===o)return;const l=e.createOscillator(),c=e.createGain();l.type=t.waveform,l.frequency.setValueAtTime(o,a);const s=Math.min(.04,.3*n);c.gain.setValueAtTime(0,a),c.gain.linearRampToValueAtTime(t.volume,a+.01),a+n-s>a+.01&&c.gain.setValueAtTime(t.volume,a+n-s),c.gain.linearRampToValueAtTime(0,a+n),l.connect(c).connect(se),l.start(a),l.stop(a+n+.01);const r={oscillator:l,gainNode:c,blockId:t.id};Z.push(r),setTimeout(()=>Z=Z.filter(e=>e!==r),1e3*(n+.1))}function He(e,t){const n=de[e.replace("#","♯")];if(void 0===n)return 0;const a=12*(t+1)+n;return 440*Math.pow(2,(a-69)/12)}function Oe(t,n,a){const o=U[t]?.playbackElements?.blockElement;if(o){const t=1e3*(a-e.currentTime);setTimeout(()=>{o.classList.add("playing"),setTimeout(()=>o.classList.remove("playing"),1e3*n)},Math.max(0,t))}}function Re(e){e.style.display="flex",setTimeout(()=>e.classList.add("active"),10)}function je(e){e.classList.remove("active"),setTimeout(()=>e.style.display="none",300)}function Ke(e){ee=e;const t=U[e];document.getElementById("modal-title").textContent=`ステップ ${e+1} 編集`,ft(document.getElementById("modal-note-buttons"),t.note),ft(document.getElementById("modal-octave-buttons"),t.octave),ft(document.getElementById("modal-waveform-buttons"),t.waveform);const n=document.getElementById("modal-volume");n.value=100*t.volume,V(n),document.getElementById("modal-volume-display").textContent=`${Math.round(100*t.volume)}%`,Re(R)}function Pe(){je(R),ee=null}function _e(){if(null===ee)return;const e=ee,t=e=>e.querySelector("button.active")?.dataset.value;U[e].note=t(document.getElementById("modal-note-buttons"))||U[e].note,U[e].octave=parseInt(t(document.getElementById("modal-octave-buttons")))||U[e].octave,U[e].waveform=t(document.getElementById("modal-waveform-buttons"))||U[e].waveform,U[e].volume=parseInt(document.getElementById("modal-volume").value)/100,Se(e),Pe(),lt()}function Ue(){if(null===ee)return;const t=e=>e.querySelector("button.active")?.dataset.value,n={note:t(document.getElementById("modal-note-buttons")),octave:parseInt(t(document.getElementById("modal-octave-buttons"))),waveform:t(document.getElementById("modal-waveform-buttons")),volume:parseInt(document.getElementById("modal-volume").value)/100};var a,o;a=n,o=.5,"suspended"===e.state?e.resume().then(()=>Ge(a,o)):Ge(a,o)}function Xe(){[document.getElementById("bulk-modal-note-buttons"),document.getElementById("bulk-modal-octave-buttons"),document.getElementById("bulk-modal-waveform-buttons")].forEach(e=>e.querySelectorAll("button.active").forEach(e=>e.classList.remove("active")));const e=document.getElementById("bulk-modal-volume");e.value=50,document.getElementById("bulk-modal-volume-display").textContent="50%",e.dataset.isSetForBulk="false",e.style.opacity=.5,document.getElementById("bulk-modal-volume-display").style.opacity=.5,V(e),Re(j)}function ze(){je(j)}function Je(){const e=e=>e.querySelector("button.active")?.dataset.value,t={note:e(document.getElementById("bulk-modal-note-buttons")),octave:parseInt(e(document.getElementById("bulk-modal-octave-buttons"))),waveform:e(document.getElementById("bulk-modal-waveform-buttons"))};"true"===document.getElementById("bulk-modal-volume").dataset.isSetForBulk&&(t.volume=parseInt(document.getElementById("bulk-modal-volume").value)/100);for(let e=0;e<16;e++)t.note&&(U[e].note=t.note),isNaN(t.octave)||(U[e].octave=t.octave),t.waveform&&(U[e].waveform=t.waveform),void 0!==t.volume&&(U[e].volume=t.volume),Se(e);ze(),lt()}function We(){Re(K)}function Qe(){je(K)}function Ye(){U.forEach((e,t)=>{Object.assign(e,{note:"A",octave:4,waveform:"sawtooth",volume:.5}),Se(t)}),p.value=120,ae=1,ft(m,ae),ne=16,ft(u,ne)}function Ze(e=!1,t=null){if(!X||!o)return void H();const n=()=>{const n=document.getElementById("preset-name"),o=document.getElementById("preset-description"),l=document.getElementById("tag-display-container"),c=document.getElementById("preset-tags-input"),s=document.getElementById("save-preset-button"),r=P.querySelector("h3");delete P.dataset.editingId;const i=document.getElementById("overwrite-preset-button");i&&i.remove(),e?(r.textContent="名前を付けて保存",s.textContent="保存"):(r.textContent="新規プリセット作成",s.textContent="作成して保存"),n.value="",o.value="",l.innerHTML="",c.value="",s.disabled=!0,s.onclick=()=>async function(e,t=null){if(!X||!a)return void Ce("ログイン機能は現在利用できません。","error");const n=document.getElementById("preset-name").value.trim();if(!n)return void Ce("プリセット名は必須です。","error");const o=document.getElementById("preset-tags-input");""!==o.value.trim()&&(Ee(o.value.trim()),o.value="");const l=document.getElementById("tag-display-container"),c=Array.from(l.querySelectorAll(".tag-badge span:first-child")).map(e=>e.textContent);e||Ye();const s={name:n,description:document.getElementById("preset-description").value.trim(),tags:c,...at(),createdAt:firebase.firestore.FieldValue.serverTimestamp(),updatedAt:firebase.firestore.FieldValue.serverTimestamp()};try{const e=await a.collection("users").doc(X.uid).collection("presets").add(s);oe=e.id,Ce(`プリセット「${n}」を作成しました。`,"success"),st(n,!0),ot(),rt(),Ne("create_preset","preset_management","new_preset"),t&&t()}catch(e){Ce(`プリセットの作成に失敗しました: ${e.message}`,"error"),console.error("Error creating new preset: ",e)}}(!0,t),Re(P)},l=I.textContent.includes("*");!e&&l?G("新規作成します。\n現在の編集内容は保存しますか？",()=>{ct(()=>{Ye(),st("新規シーケンス",!1,!1),ot()})},{confirmText:"保存して続行",onCancel:()=>{Ye(),st("新規シーケンス",!1,!1),ot(),n()},cancelText:"破棄して続行",onAlternative:()=>{},alternativeText:"キャンセル",isDanger:!1}):n()}function et(){oe=null,st(null,!1);const e=e=>e.querySelector("button.active")?.dataset.value,t=e(document.getElementById("rg-root-note-buttons")),n=parseInt(e(document.getElementById("rg-octave-min-buttons"))),a=parseInt(e(document.getElementById("rg-octave-max-buttons"))),o=parseInt(e(document.getElementById("rg-steps-buttons")));if(!(t&&n&&a&&o))return void Ce("ランダム生成の全項目を選択してください。","error");if(n>a)return void Ce("最小オクターブは最大以下にしてください。","error");const l=ye[document.getElementById("rg-chord-type").value],c=de[t],s=[];for(let e=n;e<=a;e++)l.intervals.forEach(t=>{const n=12*(e+1)+c+t,a=n%12,o=Math.floor(n/12)-1;let l=ue.find(e=>de[e]===a&&!e.includes("♭"))||ue[a];o>=1&&o<=9&&s.push({note:l,octave:o})});if(0!==s.length){for(let e=0;e<o;e++){const t=s[Math.floor(Math.random()*s.length)];U[e].note=t.note,U[e].octave=t.octave,Se(e)}ne=o,ft(u,ne),Qe(),Ce("ランダム生成を実行しました。","success"),Ne("random_generate","creation_tools",l.name,o),lt()}else Ce("指定範囲で生成可能な音がありません。","error")}const tt="oscbot_local_backup";async function nt(e){if(e.sequenceData.forEach((e,t)=>{U[t]&&(Object.assign(U[t],e),Se(t))}),p.value=e.bpm,ae=e.noteDuration,ft(m,ae),ne=e.sequenceMax,ft(u,ne),e.fxSlots){for(let t=0;t<re.length;t++)if(e.fxSlots[t]){const n=re[t],a=e.fxSlots[t];n.isActive=a.isActive,n.effectType=a.effectType;const o=ie[a.effectType]?.params||{},l=Object.fromEntries(Object.entries(o).map(([e,t])=>[e,t.value]));n.params={...l,...a.params}}await ve(),re.forEach(e=>he(e.id))}}function at(){return{sequenceData:U.map(({note:e,octave:t,waveform:n,volume:a})=>({note:e,octave:t,waveform:n,volume:a})),bpm:parseInt(p.value),noteDuration:ae,sequenceMax:ne,fxSlots:re.map(e=>({isActive:e.isActive,effectType:e.effectType,params:e.params}))}}function ot(){localStorage.removeItem(tt)}function lt(){!function(){try{const e={...at(),timestamp:(new Date).getTime()};localStorage.setItem(tt,JSON.stringify(e))}catch(e){console.error("Error saving local backup:",e)}}(),st(oe?I.textContent:"新規シーケンス",!1,!0),X&&oe&&(ce&&clearTimeout(ce),ce=setTimeout(()=>async function(e,t=null){if(!X||!a||!oe)return;const n=I.textContent;st("保存中...",!1);try{const n=at(),o=a.collection("users").doc(X.uid).collection("presets").doc(oe);await o.update({...n,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});const l=(await o.get()).data().name;st(l,!0),e||Ce(`「${l}」を保存しました。`,"success"),ot(),t&&t()}catch(e){Ce(`保存に失敗: ${e.message}`,"error"),console.error("Save error: ",e),st(n.replace("保存中...",""),!1,!0)}}(!0),1e4))}function ct(e=null){X&&o?oe?(ce&&clearTimeout(ce),G("現在のプリセットの保存方法を選択してください",()=>{!async function(e,t=null){if(!X||!a||!e)return;const n={...at(),updatedAt:firebase.firestore.FieldValue.serverTimestamp()};try{const o=a.collection("users").doc(X.uid).collection("presets").doc(e);await o.update(n);const l=(await o.get()).data().name;Ce(`「${l}」を上書き保存しました。`,"success"),st(l,!0),ot(),t&&t()}catch(e){console.error("Error overwriting preset: ",e),"not-found"===e.code?(Ce("エラー: 保存対象のプリセットが見つかりませんでした。","error"),G("元のプリセットが削除されているようです。現在の内容を新しいプリセットとして保存しますか？",()=>{Ze(!0)},{confirmText:"新規保存",cancelText:"キャンセル"}),oe=null,st("新規シーケンス",!1,!0)):Ce(`上書き保存に失敗しました: ${e.message}`,"error")}}(oe,e)},{onAlternative:()=>{Ze(!0)},confirmText:"上書き保存",alternativeText:"別名で保存",cancelText:"キャンセル"})):Ze(!0,e):Ze(!0)}function st(e,t,n=!1){const a=document.getElementById("manual-save-button"),o=document.getElementById("footer-save-button");let l=e||"新規シーケンス";const c=l.replace(/\s\*$/,"").replace(/^[\u2713\s]*/,"").replace(/^保存中.../,"");if(null!==e){if(!X&&!n)return T.style.display="none",void(o.disabled=!0);t?(l=`✓ ${c}`,a.textContent="保存済み",a.disabled=!0,o.disabled=!0):"保存中..."===e?(l="保存中...",a.textContent="保存中...",a.disabled=!0,o.disabled=!0):n?(l=`${c} *`,a.textContent="保存",a.disabled=!1,o.disabled=!1):(l=c,a.textContent="保存",a.disabled=!0,o.disabled=!0),I.textContent=l,T.style.display="flex",I.classList.toggle("editable",!!oe&&!!X)}else T.style.display="none"}function rt(){const e=document.getElementById("overwrite-preset-button");e&&e.remove(),je(P)}async function it(e=!0){if(!X||!a)return void Ce("ログイン機能は現在利用できません。","error");const t=document.getElementById("preset-name").value.trim();if(!t)return void Ce("プリセット名は必須です。","error");const n=document.getElementById("preset-tags-input");""!==n.value.trim()&&(Ee(n.value.trim()),n.value="");const o=P.dataset.editingId,l=document.getElementById("tag-display-container"),c=Array.from(l.querySelectorAll(".tag-badge span:first-child")).map(e=>e.textContent),s={name:t,description:document.getElementById("preset-description").value.trim(),tags:c,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};try{const t=a.collection("users").doc(X.uid).collection("presets");if(e&&o)await t.doc(o).update({name:s.name,description:s.description,tags:s.tags}),Ce("プリセット情報を更新しました。","success"),o===oe&&st(s.name,!0),mt();else{const e={...at(),...s,createdAt:firebase.firestore.FieldValue.serverTimestamp()},n=await t.add(e);oe=n.id,Ce(`「${s.name}」を保存しました。`,"success"),st(s.name,!0),ot()}rt()}catch(e){Ce(`保存に失敗しました: ${e.message}`,"error"),console.error("Error saving preset: ",e)}}function dt(){X&&o?(mt(),Re(_)):H()}function ut(){je(_)}async function mt(){if(!X||!a)return;const t=document.getElementById("preset-list"),n=document.getElementById("no-results-message"),o=document.getElementById("search-box").value.toLowerCase();t.innerHTML='<div class="loading-spinner"></div>';try{const l=await a.collection("users").doc(X.uid).collection("presets").orderBy("updatedAt","desc").get(),c=l.docs.map(e=>({id:e.id,...e.data()})).filter(e=>e.name.toLowerCase().includes(o)||e.description&&e.description.toLowerCase().includes(o)||e.tags&&e.tags.some(e=>e.toLowerCase().includes(o)));t.innerHTML="",c.length>0?(t.className="preset-grid",c.forEach(n=>{const o=document.createElement("div");o.className="preset-card-item";const l=document.createElement("div");l.className="preset-card-content";const c=document.createElement("h3");c.textContent=n.name;const s=document.createElement("p");s.textContent=n.description||"説明なし";const r=document.createElement("span");r.className="preset-timestamp",n.updatedAt&&n.updatedAt.toDate&&(r.textContent=`最終更新: ${n.updatedAt.toDate().toLocaleString()}`);const i=document.createElement("div");i.className="tags",n.tags&&n.tags.length>0&&(i.innerHTML=n.tags.map(e=>`<span class="tag">${e}</span>`).join(""));const d=document.createElement("div");d.className="actions";const u=document.createElement("button");u.className="action-button preview",u.innerHTML='<i class="fa-solid fa-play"></i> 試聴';const m=document.createElement("button");m.className="action-button edit",m.innerHTML='<i class="fa-solid fa-pen-to-square"></i>',m.title="名前やタグを編集";const p=document.createElement("button");p.className="action-button delete",p.innerHTML='<i class="fa-solid fa-trash"></i>',p.title="削除";const f=document.createElement("button");f.className="action-button load",f.textContent="読込",d.append(u,m,p,f),l.append(c,s,r,i,d),o.append(l),u.onclick=t=>{t.stopPropagation(),function(t){"suspended"===e.state&&e.resume();const n=De.length>0;if(Ve(),n)return;const a=event.target.closest(".action-button.preview");a&&(a.classList.add("playing"),a.innerHTML='<i class="fa-solid fa-stop"></i> 停止');let o=0,l=e.currentTime+.05;const c=t.sequenceData||[],s=t.sequenceMax||16,r=t.noteDuration||1,i=t.bpm||120,d=()=>{const t=60/i*r;for(;l<e.currentTime+.1;){if(o>=s)return void Ve();const n=c[o];if(n&&n.volume>0){const a=He(n.note,n.octave);if(a>0){const o=e.createOscillator(),c=e.createGain();o.type=n.waveform,o.frequency.setValueAtTime(a,l);const s=.01,r=Math.min(.04,.3*t);c.gain.setValueAtTime(0,l),c.gain.linearRampToValueAtTime(n.volume,l+s),l+t-r>l+s&&c.gain.setValueAtTime(n.volume,l+t-r),c.gain.linearRampToValueAtTime(0,l+t),o.connect(c).connect(se),o.start(l),o.stop(l+t+.01);const i={oscillator:o,gainNode:c};De.push(i),setTimeout(()=>{De=De.filter(e=>e!==i)},1e3*(t+.1))}}l+=t,o++}$e=o<s&&De.length>0?setTimeout(d,25):setTimeout(Ve,1e3*t)};d()}(n)},f.onclick=e=>{e.stopPropagation(),async function(e){if(!X||!a)return;Ve();try{const t=a.collection("users").doc(X.uid).collection("presets").doc(e),n=await t.get();if(!n.exists)return void Ce("プリセットが見つかりません。","error");const o=n.data();await nt(o),oe=e,st(o.name,!0),ot(),Ce(`「${o.name}」を読み込みました。`,"success"),ut()}catch(e){Ce(`プリセットの読み込みに失敗しました: ${e.message}`,"error"),console.error("Error loading preset:",e)}}(n.id)},m.onclick=e=>{e.stopPropagation(),pt(n.id)},p.onclick=e=>{e.stopPropagation(),async function(e,t){if(!X||!a)return;G(`本当にプリセット「${t}」を削除しますか？この操作は取り消せません。`,async()=>{try{await a.collection("users").doc(X.uid).collection("presets").doc(e).delete(),Ce("プリセットを削除しました。","success"),oe===e&&(oe=null,st(null)),mt()}catch(e){Ce(`プリセットの削除に失敗しました: ${e.message}`,"error"),console.error("Error deleting preset:",e)}},{isDanger:!0})}(n.id,n.name)},t.appendChild(o)}),n.style.display="none"):(t.className="preset-list",n.style.display="block")}catch(e){t.innerHTML="プリセットの読み込みに失敗しました。",Ce("プリセットの読み込みに失敗しました。","error"),console.error("Error populating presets: ",e)}}async function pt(e){if(X&&a)try{const t=a.collection("users").doc(X.uid).collection("presets").doc(e),n=await t.get();if(!n.exists)return void Ce("編集対象のプリセットが見つかりません。","error");const o=n.data();P.querySelector("h3").textContent="プリセット情報の編集";const l=document.getElementById("preset-name");l.value=o.name,document.getElementById("preset-description").value=o.description||"";const c=document.getElementById("tag-display-container");c.innerHTML="",o.tags&&o.tags.forEach(e=>{const t=document.createElement("div");t.className="tag-badge",t.innerHTML=`<span>${e}</span><span class="remove-tag">×</span>`,c.appendChild(t)});const s=document.getElementById("save-preset-button");s.textContent="変更を保存",s.onclick=()=>it(!0),s.disabled=""===l.value.trim(),P.dataset.editingId=e;const r=document.getElementById("overwrite-preset-button");r&&r.remove(),ut(),Re(P)}catch(e){Ce("プリセット情報の取得に失敗しました。","error")}}function ft(e,t){e.querySelectorAll("button").forEach(e=>{e.classList.toggle("active",e.dataset.value==t)})}function yt(e,t,n,a=e=>e){e.innerHTML="",t.forEach(t=>{const n=document.createElement("button");n.type="button",n.dataset.value=t,n.textContent=a(t),n.onclick=()=>{e.querySelectorAll("button").forEach(e=>e.classList.remove("active")),n.classList.add("active")},e.appendChild(n)})}function vt(e,t,n,a,o="value",l="label"){e.innerHTML="",t.forEach(t=>{const c="object"==typeof t?t[o]:t,s="object"==typeof t?t[l]:t,r=document.createElement("button");r.type="button",r.dataset.value=c,r.textContent=s,c==a&&r.classList.add("active"),r.onclick=()=>{e.querySelectorAll("button").forEach(e=>e.classList.remove("active")),r.classList.add("active"),n(c)},e.appendChild(r)})}function gt(e){let t=parseInt(p.value);t=Math.max(20,Math.min(300,t+e)),p.value=t}!async function(){try{await async function(){let t=se;for(const n of re)n.bypassNode=e.createGain(),t.connect(n.bypassNode),t=n.bypassNode;t.connect(e.destination)}(),await ve(),function(){d.innerHTML="",U=[];for(let e=0;e<16;e++){const t=document.createElement("div");t.className="playback-block",t.dataset.id=e,t.draggable=!0,t.onclick=()=>Ke(e);const n=document.createElement("span");n.className="step-number-pb",n.textContent=e+1;const a=document.createElement("div");a.className="pb-note";const o=document.createElement("div");o.className="pb-wave";const l=document.createElement("div");l.className="pb-volume-container";const c=document.createElement("div");c.className="pb-volume-bar",l.appendChild(c),t.append(n,a,o,l),d.appendChild(t),U.push({id:e,note:"A",octave:4,waveform:"sawtooth",volume:.5,playbackElements:{blockElement:t,noteDisplay:a,waveDisplay:o,volumeBar:c}}),Se(e)}}(),function(){const e=Object.keys(pe);yt(document.getElementById("modal-note-buttons"),ue,"note",e=>e.replace("♯","#")),yt(document.getElementById("modal-octave-buttons"),me,"octave"),yt(document.getElementById("modal-waveform-buttons"),e,"waveform",e=>pe[e]),yt(document.getElementById("bulk-modal-note-buttons"),ue,"note",e=>e.replace("♯","#")),yt(document.getElementById("bulk-modal-octave-buttons"),me,"octave"),yt(document.getElementById("bulk-modal-waveform-buttons"),e,"waveform",e=>pe[e]),vt(u,Array.from({length:16},(e,t)=>t+1),e=>{ne=parseInt(e),lt()},ne),vt(m,fe,e=>{ae=parseFloat(e),lt()},ae,"value","label"),function(){yt(document.getElementById("rg-root-note-buttons"),ue,"rg-root-note"),yt(document.getElementById("rg-octave-min-buttons"),me,"rg-octave-min"),yt(document.getElementById("rg-octave-max-buttons"),me,"rg-octave-max"),yt(document.getElementById("rg-steps-buttons"),Array.from({length:16},(e,t)=>t+1),"rg-steps");document.getElementById("rg-chord-type").innerHTML=Object.keys(ye).map(e=>`<option value="${e}">${ye[e].name}</option>`).join("")}(),w.innerHTML="",re.forEach(e=>{const t=document.createElement("button");t.className="fx-slot-button",t.dataset.fxId=e.id,t.innerHTML=`<span class="fx-slot-name">${e.name}</span><span class="fx-type-name"></span>`;let n=null;const a=t=>{t.preventDefault(),n=setTimeout(()=>{var t;t=e.id,le=re.find(e=>e.id===t),le&&(A.textContent=`${le.name} 設定`,C.innerHTML=Object.keys(ie).map(e=>`<option value="${e}">${ie[e].name}</option>`).join(""),C.value=le.effectType,ke(),Re(L)),n=null},500)},o=()=>{n&&clearTimeout(n),n=null},l=()=>{null!==n&&function(e){const t=re.find(t=>t.id===e);t&&(t.isActive=!t.isActive,he(e),ge(t),lt())}(e.id),o()};t.addEventListener("mousedown",a),t.addEventListener("touchstart",a,{passive:!1}),t.addEventListener("mouseup",l),t.addEventListener("mouseleave",o),t.addEventListener("touchend",l),w.appendChild(t),he(e.id)})}(),function(){l.addEventListener("click",O),c.addEventListener("click",()=>o.signOut()),y.onclick=()=>Me(!1),v.onclick=()=>Me(!0),g.onclick=Fe,b.onclick=Xe,E.onclick=We,i.onclick=dt,B.onclick=()=>Ze(!1),k.onclick=()=>ct(),x.onclick=()=>ct(),I.addEventListener("click",()=>{oe&&X&&pt(oe)}),f.forEach(e=>e.addEventListener("click",()=>{gt(parseInt(e.dataset.step)),we(),lt()})),p.addEventListener("change",()=>{p.value=Math.max(20,Math.min(300,parseInt(p.value)||120)),we(),lt()}),d.addEventListener("dragstart",e=>{e.target.classList.contains("playback-block")&&(te=e.target,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",e.target.innerHTML),e.target.classList.add("dragging"))}),d.addEventListener("dragover",e=>{e.preventDefault();const t=e.target.closest(".playback-block");t&&t!==te&&t.classList.add("drag-over")}),d.addEventListener("dragleave",e=>{const t=e.target.closest(".playback-block");t&&t.classList.remove("drag-over")}),d.addEventListener("dragend",e=>e.target.classList.remove("dragging")),d.addEventListener("drop",e=>{e.preventDefault();const t=e.target.closest(".playback-block");if(!t||!te||t===te)return void(t&&t.classList.remove("drag-over"));t.classList.remove("drag-over");const n=parseInt(te.dataset.id),a=parseInt(t.dataset.id);G(`ステップ${n+1}のデータをステップ${a+1}と入れ替えますか？`,()=>{!function(e,t){const n={...U[e]},a={...U[t]};["note","octave","waveform","volume"].forEach(o=>{U[e][o]=a[o],U[t][o]=n[o]}),Se(e),Se(t),lt()}(n,a)},{confirmText:"入れ替え",cancelText:"キャンセル",onAlternative:()=>{!function(e,t){const n={...U[e]};["note","octave","waveform","volume"].forEach(e=>{U[t][e]=n[e]}),Se(t),lt()}(n,a)},alternativeText:"上書き"}),te=null}),Ae(R,Pe),Ae(j,ze),Ae(K,Qe),Ae(P,rt),Ae(L,Te),S.onclick=xe,C.onchange=Ie,document.getElementById("modal-volume").oninput=e=>{document.getElementById("modal-volume-display").textContent=`${e.target.value}%`,V(e.target)},document.getElementById("modal-complete-button").onclick=_e,document.getElementById("modal-play-test-button").onclick=Ue;const e=document.getElementById("bulk-modal-volume"),t=document.getElementById("bulk-modal-volume-display");e.oninput=()=>{t.textContent=`${e.value}%`,e.dataset.isSetForBulk="true",e.style.opacity=1,t.style.opacity=1,V(e)},document.getElementById("bulk-modal-apply-button").onclick=Je,document.getElementById("bulk-clear-volume-button").onclick=()=>{e.value=50,t.textContent="50%",e.dataset.isSetForBulk="false",e.style.opacity=.5,t.style.opacity=.5,V(e)},document.getElementById("rg-execute-button").onclick=et,document.getElementById("save-preset-button").onclick=it,document.getElementById("search-box").addEventListener("input",mt),function(){const e=document.getElementById("preset-name"),t=document.getElementById("save-preset-button"),n=document.getElementById("preset-tags-input"),a=document.getElementById("tag-display-container");e.addEventListener("input",()=>{t.disabled=""===e.value.trim()}),n.addEventListener("keydown",e=>{"Enter"===e.key&&""!==n.value.trim()&&(e.preventDefault(),Ee(n.value.trim()),n.value="")}),a.addEventListener("click",e=>{e.target.classList.contains("remove-tag")&&e.target.parentElement.remove()})}(),window.addEventListener("keydown",e=>{const t=document.activeElement;if(["INPUT","TEXTAREA","SELECT"].includes(t.tagName)&&"range"===!t.type)return;const n=document.querySelector(".modal.active");if(!n||"Escape"===e.key)switch(e.key){case" ":J?g.click():v.click(),e.preventDefault();break;case"Enter":y.click(),e.preventDefault();break;case"ArrowUp":gt(e.shiftKey?10:1),e.preventDefault();break;case"ArrowDown":gt(e.shiftKey?-10:-1),e.preventDefault();break;case"ArrowRight":Le(e.shiftKey?u:m,1),e.preventDefault();break;case"ArrowLeft":Le(e.shiftKey?u:m,-1),e.preventDefault();break;case"Escape":n?n.querySelector(".close-button").click():J&&g.click(),e.preventDefault();break;case"r":case"R":E.click();break;case"b":case"B":b.click();break;case"l":case"L":i.click()}})}(),function(){if(!o)return l.style.display="none",c.style.display="none",s.style.display="none",i.disabled=!0,void(B.disabled=!0);o.getRedirectResult().then(e=>{e.user&&Ce("ログインに成功しました","success")}).catch(e=>{console.error("Redirect result error:",e),"auth/popup-closed-by-user"!==e.code&&Ce(`ログインに失敗しました: ${e.message}`,"error")}),o.onAuthStateChanged(t=>{if(t){const n=a.collection("users").doc(t.uid);n.get().then(e=>{const a={displayName:t.displayName,email:t.email,photoURL:t.photoURL,lastLoginAt:firebase.firestore.FieldValue.serverTimestamp()};return e.exists||(a.createdAt=firebase.firestore.FieldValue.serverTimestamp()),n.set(a,{merge:!0})}).catch(e=>{console.error("Error checking/creating user in Firestore:",e),Ce("ユーザー情報の確認に失敗しました。","error")}),X=t,function(e){const t=e.displayName||"ユーザー";if(r.textContent=`${t}さん`,e.photoURL){const t=document.createElement("img");t.src=e.photoURL;const n=r.querySelector("img");n&&n.remove(),r.insertBefore(t,r.firstChild)}}(t),"suspended"===e.state&&e.resume().catch(console.error)}else X=null,s.style.display="none",l.style.display="block",i.disabled=!0,B.disabled=!0,x.disabled=!0,k.disabled=!0,st(null)})}(),function(){try{const e=localStorage.getItem(tt);if(!e)return void st("新規シーケンス");const t=JSON.parse(e);G(`未保存の作業データが見つかりました。（最終更新: ${new Date(t.timestamp).toLocaleString()}）復元しますか？`,()=>{nt(t),lt(),Ce("作業を復元しました。","info")},{onCancel:()=>{ot(),Ce("バックアップを破棄しました。","info"),st("新規シーケンス",!1,!1)},confirmText:"復元する",cancelText:"破棄する"})}catch(e){console.error("Error loading local backup:",e),ot()}}(),document.querySelectorAll('input[type="range"]').forEach(V)}catch(e){console.error("Initialization failed:",e)}finally{const e=document.getElementById("loading-overlay");e&&(e.style.display="none")}}()});